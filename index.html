<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق جداول الشعب التدريبية</title>

    <!-- Google Fonts - Cairo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* ═══════════════════════════════════════════════════════════════
           المتغيرات والجذر
           ═══════════════════════════════════════════════════════════════ */
        :root {
            /* الألوان الأساسية */
            --bg-primary: #0a0e1a;
            --bg-secondary: #111827;
            --bg-card: rgba(30, 41, 59, 0.7);
            --bg-glass: rgba(255, 255, 255, 0.05);

            /* ألوان النص */
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;

            /* ألوان الأنواع */
            --color-theory: #3b82f6;
            /* نظري - أزرق */
            --color-practical: #10b981;
            /* عملي - أخضر */
            --color-blended: #8b5cf6;
            /* مدمج - بنفسجي */
            --color-self: #6b7280;
            /* ذاتي - رمادي */
            --color-coop: #f59e0b;
            /* تعاوني - برتقالي */

            /* ألوان التفاعل */
            --color-accent: #6366f1;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-target: #fbbf24;
            /* الوقت المستهدف */

            /* التدرجات */
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-header: linear-gradient(90deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);

            /* الظلال */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 20px rgba(99, 102, 241, 0.3);

            /* الحدود */
            --border-color: rgba(255, 255, 255, 0.1);
            --border-radius: 12px;
            --border-radius-sm: 8px;

            /* الخط */
            --font-family: 'Cairo', sans-serif;
        }

        /* ═══════════════════════════════════════════════════════════════
           إعادة التعيين والأساسيات
           ═══════════════════════════════════════════════════════════════ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* الخلفية المتحركة */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(59, 130, 246, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: -1;
        }

        /* ═══════════════════════════════════════════════════════════════
           صفحة الرفع
           ═══════════════════════════════════════════════════════════════ */
        .upload-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .upload-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        /* بطاقات المميزات */
        .features-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .feature-card {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.3);
            padding: 0.6rem 1rem;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.3);
            border-color: rgba(99, 102, 241, 0.6);
        }

        .feature-icon {
            width: 18px !important;
            height: 18px !important;
            color: #a5b4fc !important;
            flex-shrink: 0;
        }

        .feature-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .upload-privacy {
            color: #22c55e;
            font-size: 0.85rem;
            margin-bottom: 2.5rem;
            text-align: center;
            background: rgba(34, 197, 94, 0.1);
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            border: 1px solid rgba(34, 197, 94, 0.3);
            display: inline-block;
        }

        .upload-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
            max-width: 1200px;
            width: 100%;
            margin-bottom: 2rem;
        }

        .upload-zone {
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-zone:hover {
            border-color: var(--color-accent);
            background: rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .upload-zone.dragover {
            border-color: var(--color-accent);
            background: rgba(99, 102, 241, 0.15);
        }

        .upload-zone.uploaded {
            border-color: var(--color-success);
            border-style: solid;
        }

        .upload-zone-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .upload-zone-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .upload-zone-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .upload-zone-hint {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .upload-zone-success {
            display: none;
            color: var(--color-success);
            font-weight: 600;
        }

        /* زر حذف الملف */
        .delete-file-btn {
            display: none;
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #f87171;
        }

        .delete-file-btn:hover {
            background: rgba(239, 68, 68, 0.4);
            border-color: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.4);
            transform: scale(1.1);
        }

        .delete-file-btn i {
            width: 18px;
            height: 18px;
        }

        /* إظهار زر الحذف عند رفع الملف */
        .upload-zone.uploaded .delete-file-btn {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-zone.uploaded .upload-zone-success {
            display: block;
        }

        .upload-zone.uploaded .upload-zone-hint {
            display: none;
        }

        .upload-progress {
            width: 100%;
            height: 4px;
            background: var(--bg-secondary);
            border-radius: 2px;
            margin-top: 1rem;
            overflow: hidden;
            display: none;
        }

        .upload-progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .upload-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 1rem 3rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: var(--font-family);
            transition: all 0.3s ease;
            opacity: 0.5;
            pointer-events: none;
        }

        .upload-btn.active {
            opacity: 1;
            pointer-events: auto;
        }

        .upload-btn.active:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        /* ═══════════════════════════════════════════════════════════════
           الصفحة الرئيسية
           ═══════════════════════════════════════════════════════════════ */
        .main-page {
            display: none;
            flex-direction: column;
            height: 100vh;
        }

        /* الشريط العلوي - 3 صفوف */
        /* الشريط العلوي - مضغوط للغاية */
        .top-bar {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 0.2rem 0.5rem;
            /* أقل ما يمكن */
        }

        .control-row {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            /* محاذاة لليسار (RTL) */
            padding-bottom: 0.1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            min-height: 24px;
            /* زيادة طفيفة */
        }

        .toggles-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .section-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            min-height: 30px;
        }

        .section-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 280px;
        }

        .vertical-divider {
            width: 1px;
            height: 16px;
            background: var(--border-color);
            margin: 0 0.8rem;
        }

        /* Safe Split Layout Wrapper */
        .split-rows-container {
            display: flex;
            width: 100%;
            gap: 4px;
            margin-bottom: 0.25rem;
        }

        /* Force section rows to share width when inside the wrapper */
        .split-rows-container .section-row {
            flex: 1;
            width: 50%;
            margin-bottom: 0;
            min-width: 0;
            /* Allow shrinking if needed */
        }

        /* Distinct styles for each half */
        .section-row.visible-row {
            background: rgba(30, 41, 59, 0.6) !important;
            border: 1px solid rgba(147, 51, 234, 0.2);
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }

        /* توهج جذب الانتباه للشعب الظاهرة */
        .section-row.visible-row.attention-glow {
            border-color: #22d3ee !important;
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.5),
                0 0 40px rgba(34, 211, 238, 0.3),
                inset 0 0 10px rgba(34, 211, 238, 0.1);
            animation: attentionPulse 1.5s ease-in-out infinite;
        }

        @keyframes attentionPulse {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(34, 211, 238, 0.5),
                    0 0 40px rgba(34, 211, 238, 0.3);
                border-color: #22d3ee;
            }

            50% {
                box-shadow: 0 0 30px rgba(34, 211, 238, 0.7),
                    0 0 60px rgba(34, 211, 238, 0.4);
                border-color: #67e8f9;
            }
        }

        .section-row.target-row {
            background: rgba(60, 40, 20, 0.4) !important;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        /* صف أدوات التحكم */
        .section-row.controls-row {
            background: rgba(30, 41, 59, 0.6) !important;
            border: 1px solid rgba(99, 102, 241, 0.2);
            justify-content: flex-start;
        }

        .controls-row .btn-home {
            margin-left: auto;
        }

        .controls-row .btn-home i {
            width: 18px;
            height: 18px;
        }

        .controls-row .btn-help {
            background: rgba(34, 211, 238, 0.15);
            border: 1px solid rgba(34, 211, 238, 0.4);
            color: #22d3ee;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .controls-row .btn-help:hover {
            background: rgba(34, 211, 238, 0.3);
            box-shadow: 0 0 10px rgba(34, 211, 238, 0.4);
        }

        .controls-row .btn-help i {
            width: 18px;
            height: 18px;
        }

        .controls-row .toggles-group {
            flex: 1;
            justify-content: center;
        }

        /* صف بحث أوقات الفراغ - لون سماوي مميز */
        .section-row.freetime-row {
            background: rgba(6, 78, 95, 0.4) !important;
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .freetime-section-input input {
            border-color: rgba(6, 182, 212, 0.3) !important;
        }

        .freetime-section-input input:focus {
            border-color: rgba(6, 182, 212, 0.6) !important;
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.15);
        }

        .freetime-row .filter-section-label {
            color: #22d3ee;
        }

        /* زر البحث عن موعد - نمط الإدخال */
        .freetime-input-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .freetime-search-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(6, 182, 212, 0.1);
            color: #22d3ee;
            border: 1px solid rgba(6, 182, 212, 0.4);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.3s ease;
            min-width: 140px;
        }

        .freetime-search-btn:hover {
            background: rgba(6, 182, 212, 0.25);
            border-color: #22d3ee;
            box-shadow: 0 0 15px rgba(34, 211, 238, 0.3);
            transform: translateY(-1px);
        }

        .freetime-search-btn i {
            width: 16px;
            height: 16px;
        }

        /* زر إعادة تعيين الفترات */
        .freetime-reset-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.4);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .freetime-reset-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.4);
        }

        .freetime-reset-btn i {
            width: 16px;
            height: 16px;
        }

        /* Layout Adjustments for condensed width */
        .split-rows-container .section-input-group {
            min-width: auto;
            /* Override default 280px min-width to prevent overflow */
            flex: 1;
        }

        .split-rows-container .section-search-input {
            flex: 1;
        }

        .split-rows-container .section-search-input input {
            width: 100%;
            /* Fill available space */
            min-width: 60px;
        }

        /* الفلاتر */
        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .filter-select {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.3rem 0.6rem;
            border-radius: var(--border-radius-sm);
            font-family: var(--font-family);
            font-size: 0.8rem;
            min-width: 120px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-select:hover,
        .filter-select:focus {
            border-color: var(--color-accent);
            outline: none;
        }

        /* الشعب المختارة (Chips) */
        .chips-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            flex: 1;
        }

        .chips-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .chip {
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid var(--color-accent);
            color: var(--text-primary);
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: chipIn 0.2s ease;
        }

        @keyframes chipIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .chip-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            font-size: 1rem;
            line-height: 1;
            transition: color 0.2s;
        }

        .chip-remove:hover {
            color: var(--color-danger);
        }

        .add-chip-btn {
            background: var(--bg-glass);
            border: 1px dashed var(--border-color);
            color: var(--text-secondary);
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            font-family: var(--font-family);
            transition: all 0.2s ease;
        }

        .add-chip-btn:hover {
            border-color: var(--color-accent);
            color: var(--text-primary);
        }

        /* الشعبة المستهدفة */
        .target-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius-sm);
        }

        .target-icon {
            font-size: 1.2rem;
        }

        .target-label {
            color: var(--color-target);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: auto;
        }

        .toggle-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            /* تكبير الخط (+20%) */
        }

        .toggle {
            position: relative;
            width: 32px;
            /* تكبير العرض (+~20%) */
            height: 16px;
            /* تكبير الارتفاع */
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle.active {
            background: var(--color-accent);
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 12px;
            /* تكبير الكرة */
            height: 12px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle.active::after {
            transform: translateX(16px);
        }

        /* مفتاح الألوان - مضغوط */
        .legend {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.2rem;
            font-size: 0.6rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 8px !important;
            height: 8px !important;
            min-width: 8px;
            min-height: 8px;
            border-radius: 2px;
        }

        /* ═══════════════════════════════════════════════════════════════
           فلاتر الأعمدة (داخل الرؤوس)
           ═══════════════════════════════════════════════════════════════ */
        .th-filter-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
        }

        .column-filter-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .column-filter-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .column-filter-btn.active {
            color: var(--color-accent);
            background: rgba(99, 102, 241, 0.1);
        }

        .column-filter-btn i {
            width: 14px;
            height: 14px;
        }

        .column-filter-dropdown {
            position: fixed;
            /* Fixed to viewport to avoid overflow clipping */
            top: 0;
            left: 0;
            width: 350px;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-lg);
            padding: 0.5rem;
            z-index: 9999;
            /* Very high z-index */
            display: none;
            flex-direction: column;
            gap: 0.5rem;
            animation: fadeIn 0.1s ease-out;
            text-align: right;
        }

        .column-filter-dropdown.show {
            display: flex;
        }

        .column-filter-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .column-filter-search {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.4rem;
            border-radius: 4px;
            font-family: var(--font-family);
            font-size: 0.8rem;
        }

        .column-filter-search:focus {
            border-color: var(--color-accent);
            outline: none;
        }

        .column-filter-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .column-filter-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .column-filter-action-btn i {
            width: 16px;
            height: 16px;
        }

        .btn-select-all:hover {
            color: var(--color-accent);
        }

        .btn-clear-all:hover {
            color: var(--color-danger);
        }

        .column-filter-options {
            max-height: 200px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .column-filter-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.3rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .column-filter-option:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .column-filter-option input[type="checkbox"] {
            accent-color: var(--color-accent);
        }

        .column-filter-option span {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* ═══════════════════════════════════════════════════════════════
           منطقة الجداول - مضغوطة
           ═══════════════════════════════════════════════════════════════ */
        .tables-container {
            flex: 1;
            overflow: hidden;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
        }

        .table-section {
            margin-bottom: 0.3rem;
        }

        /* جدول المدربين - تقليص الارتفاع لإعطاء مساحة أكبر للمتدربين */
        .table-section:first-child .data-table-wrapper {
            max-height: 35vh;
        }

        /* جدول المتدربين - زيادة الارتفاع */
        .table-section:last-child .data-table-wrapper {
            min-height: 55vh;
            max-height: 65vh;
        }

        /* إزالة الصفوف المنفصلة للعناوين - دمجها inline */
        .table-header {
            display: none;
        }

        /* الجدول */
        .data-table-wrapper {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            overflow-x: auto;
            overflow-y: auto;
            scrollbar-gutter: stable;
            /* حجز مساحة لشريط التمرير دائماً لمحاذاة الأعمدة */
            border: 1px solid var(--border-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        .data-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 600;
            padding: 0.3rem 0.2rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        /* رسالة الجدول الفارغ */
        .empty-table-message {
            text-align: center !important;
            padding: 3rem 1rem !important;
            color: var(--text-muted);
            font-size: 1.2rem;
            font-weight: 500;
            background: transparent !important;
        }

        .empty-table-message i {
            width: 48px;
            height: 48px;
            display: block;
            margin: 0 auto 1rem;
            opacity: 0.4;
            color: var(--color-accent);
        }

        /* تمييز رؤوس الجداول */
        .trainer-header th {
            background: rgba(30, 58, 138, 0.4) !important;
            /* أزرق غامق */
            border-top: 3px solid #3b82f6;
        }

        .trainee-header th {
            background: rgba(6, 78, 59, 0.4) !important;
            /* أخضر غامق */
            border-top: 3px solid #10b981;
        }

        /* ألوان الأيام - تلوين الأعمدة بالكامل */
        .data-table th.day-header {
            font-weight: 700;
        }

        /* تلوين الأعمدة - باستخدام الكلاسات لضمان الدقة */
        .data-table .day-sun {
            background: rgba(239, 68, 68, 0.15) !important;
            /* الأحد - أحمر */
        }

        .data-table .day-mon {
            background: rgba(249, 115, 22, 0.15) !important;
            /* الإثنين - برتقالي */
        }

        .data-table .day-tue {
            background: rgba(34, 197, 94, 0.15) !important;
            /* الثلاثاء - أخضر */
        }

        .data-table .day-wed {
            background: rgba(59, 130, 246, 0.15) !important;
            /* الأربعاء - أزرق */
        }

        .data-table .day-thu {
            background: rgba(168, 85, 247, 0.15) !important;
            /* الخميس - بنفسجي */
        }

        /* تأثير عند مرور الماوس على العمود (اختياري) */
        .data-table td.day-sun:hover {
            background: rgba(239, 68, 68, 0.25) !important;
        }

        .data-table td.day-mon:hover {
            background: rgba(249, 115, 22, 0.25) !important;
        }

        .data-table td.day-tue:hover {
            background: rgba(34, 197, 94, 0.25) !important;
        }

        .data-table td.day-wed:hover {
            background: rgba(59, 130, 246, 0.25) !important;
        }

        .data-table td.day-thu:hover {
            background: rgba(168, 85, 247, 0.25) !important;
        }


        /* تأثير الـ Hover على الصفوف مع الحفاظ على شفافية الأعمدة */
        /* تأثير الـ Hover على الصفوف مع الحفاظ على شفافية الأعمدة */
        /* تمت إزالة قاعدة position: relative عند hover ونقلها لتكون دائمة */

        .data-table tbody tr:hover td::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.05);
            pointer-events: none;
        }

        .data-table th.time-header {
            font-size: 0.65rem;
            padding: 0.2rem 0.1rem;
            min-width: 32px;
        }

        .data-table td {
            position: relative;
            padding: 0;
            /* إزالة الحشوة تماماً */
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            height: 20px;
            /* تقليل الارتفاع (كان 24) */
        }

        .data-table tbody tr {
            transition: background 0.2s;
        }

        .data-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .data-table tbody tr.trainer-row {
            background: rgba(99, 102, 241, 0.08);
            border-bottom: 2px solid var(--color-accent);
        }

        .data-table tbody tr.separator-row td {
            height: 6px;
            padding: 0;
            background: transparent;
            border: none;
        }

        /* خلايا الأوقات - مضغوطة */
        /* خلايا الأوقات - مضغوطة جداً */
        .time-cell {
            width: 26px;
            height: 16px;
            /* تقليل الارتفاع (كان 18) */
            border-radius: 2px;
            margin: 0 auto;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            font-size: 0.5rem;
            /* تصغير الخط قليلاً */
            line-height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .time-cell.empty {
            background: rgba(255, 255, 255, 0.02);
        }

        .time-cell.theory {
            background: var(--color-theory);
        }

        .time-cell.practical {
            background: var(--color-practical);
        }

        .time-cell.blended {
            background: var(--color-blended);
        }

        .time-cell.target {
            border: 2px solid var(--color-target);
            box-shadow: 0 0 6px rgba(251, 191, 36, 0.5);
        }

        /* إصلاح الخط الأفقي غير المرغوب فيه */
        .day-cell::before,
        div.day-cell::before {
            content: none !important;
            display: none !important;
            width: 0 !important;
            height: 0 !important;
            border: none !important;
            background: transparent !important;
        }

        /* علامة المقرر المجزأ */
        .time-cell.split::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 0 0 0 100%;
            opacity: 0.7;
        }

        /* بالون الشعبة */
        .time-cell .cell-tooltip {
            position: absolute;
            bottom: 100%;
            right: 50%;
            transform: translateX(50%);
            background: var(--bg-card);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
            min-width: 180px;
            z-index: 100;
            box-shadow: var(--shadow-lg);
            display: none;
            text-align: right;
            font-size: 0.7rem;
        }

        .time-cell:hover .cell-tooltip {
            display: block;
        }

        /* خلية رقم المتدرب (مع Tooltip) */
        .trainee-id {
            position: relative;
            cursor: pointer;
            color: var(--color-accent);
            font-weight: 500;
        }

        .trainee-id:hover {
            text-decoration: underline;
        }

        /* ═══════════════════════════════════════════════════════════════
           تنسيق المجموعات المدمجة
           ═══════════════════════════════════════════════════════════════ */
        .merged-cell {
            text-align: center !important;
            cursor: pointer;
        }

        .merge-count {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--color-accent);
            background: rgba(99, 102, 241, 0.15);
            min-width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* تمييز صف المجموعة المدمجة */
        .data-table tbody tr.merged-group {
            border-right: 3px solid var(--color-accent);
        }

        .data-table tbody tr.merged-group .merge-count {
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
            }

            50% {
                box-shadow: 0 0 8px 2px rgba(99, 102, 241, 0.6);
            }
        }

        /* ═══════════════════════════════════════════════════════════════
           Tooltip المجموعات المدمجة
           ═══════════════════════════════════════════════════════════════ */
        .merged-cell {
            position: relative;
        }

        .merged-tooltip {
            position: fixed;
            z-index: 9999;
            background: var(--bg-card);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 0.75rem;
            min-width: 320px;
            max-width: 400px;
            max-height: 300px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            display: none;
            text-align: right;
            direction: rtl;
            pointer-events: none;
        }

        .merged-tooltip.visible {
            display: block;
            animation: tooltipFade 0.2s ease;
        }

        @keyframes tooltipFade {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes tooltipFade {
            from {
                opacity: 0;
                transform: translateX(50%) translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateX(50%) translateY(0);
            }
        }

        .merged-tooltip-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--color-accent);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .merged-tooltip-header i {
            width: 16px;
            height: 16px;
        }

        .merged-tooltip-list {
            max-height: 180px;
            overflow-y: auto;
            padding-left: 4px;
        }

        .merged-tooltip-row {
            display: grid;
            grid-template-columns: 24px 1fr 90px;
            gap: 8px;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.75rem;
            align-items: center;
        }

        .merged-tooltip-row:last-child {
            border-bottom: none;
        }

        .row-num {
            color: var(--text-muted);
            text-align: center;
            font-size: 0.65rem;
        }

        .row-name {
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .row-id {
            color: var(--color-accent);
            font-family: monospace;
            font-size: 0.7rem;
            text-align: left;
            direction: ltr;
        }

        .merged-tooltip-hint {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .merged-tooltip-hint i {
            width: 12px;
            height: 12px;
            color: var(--color-accent);
        }

        /* البالون */
        .tooltip {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-card);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            min-width: 280px;
            z-index: 100;
            box-shadow: var(--shadow-lg);
            display: none;
            text-align: right;
        }

        .trainee-id:hover .tooltip {
            display: block;
            animation: tooltipIn 0.2s ease;
        }

        @keyframes tooltipIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* أعمدة ثابتة للمحاذاة الصارمة */
        .col-id {
            width: 35px;
            min-width: 35px;
            max-width: 35px;
        }

        .col-name {
            width: 140px;
            min-width: 140px;
            max-width: 140px;
            text-align: right;
            padding-right: 0.5rem;
        }

        /* عمود القسم/التخصص */
        .col-dept {
            width: 80px;
            min-width: 80px;
            max-width: 80px;
            text-align: right;
            padding-right: 0.5rem;
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        /* تنسيق اسم المدرب/المتدرب */
        .trainer-name,
        .trainee-name {
            font-family: 'Cairo', sans-serif;
            font-size: 11px;
            font-weight: 400;
            color: #ffffff;
        }

        .col-stat {
            width: 45px;
            min-width: 45px;
            max-width: 45px;
        }

        .col-stat-wide {
            width: 90px;
            min-width: 90px;
            max-width: 90px;
        }

        /* 45 + 45 */

        /* ألوان البيانات */
        .text-contact {
            color: var(--color-practical);
            font-weight: 700;
        }

        .text-quota {
            color: var(--color-theory);
            font-weight: 700;
        }

        .text-credits {
            color: var(--color-accent);
            font-weight: 700;
        }

        /* شارات الأنواع (من التفضيلات) */
        .type-badge {
            display: inline-block;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: bold;
            margin-right: 2px;
        }

        .type-badge-theory {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        .type-badge-practical {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }

        .type-badge-blended {
            background: rgba(139, 92, 246, 0.2);
            color: #c4b5fd;
        }

        .type-badge-coop {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
        }

        /* تعديلات الجدول */
        .data-table {
            table-layout: fixed;
        }

        /* إجبار المتصفح على احترام العرض */

        /* تنسيق محتوى بالون الشعبة */
        .cell-tooltip-header {
            font-weight: 700;
            margin-bottom: 0.3rem;
            color: var(--color-accent);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.2rem;
            white-space: nowrap;
        }

        .cell-tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 0.1rem;
            color: var(--text-secondary);
        }

        .cell-tooltip-val {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* تنسيق خلية النصاب للمدرب */
        .quota-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.2rem;
            font-size: 0.75rem;
        }

        .quota-contact {
            color: var(--color-accent);
            font-weight: 700;
        }

        .quota-divider {
            color: var(--text-muted);
        }

        .quota-limit {
            color: var(--text-secondary);
        }

        .tooltip-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .tooltip-row:last-child {
            border-bottom: none;
        }

        .tooltip-icon {
            color: var(--text-muted);
            width: 20px;
            text-align: center;
        }

        .tooltip-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .tooltip-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .tooltip-courses {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .course-badge {
            background: rgba(99, 102, 241, 0.2);
            color: var(--color-accent);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        /* ═══════════════════════════════════════════════════════════════
           مفتاح الألوان
           ═══════════════════════════════════════════════════════════════ */
        .legend {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 0.75rem 1rem;
            background: var(--bg-glass);
            border-radius: var(--border-radius-sm);
            margin-right: auto;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* ═══════════════════════════════════════════════════════════════
           التحميل
           ═══════════════════════════════════════════════════════════════ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 26, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-color);
            border-top-color: var(--color-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ═══════════════════════════════════════════════════════════════
           الإشعارات (Toast)
           ═══════════════════════════════════════════════════════════════ */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }

        .toast {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: toastIn 0.3s ease;
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .toast-icon {
            font-size: 1.2rem;
        }

        .toast-message {
            color: var(--text-primary);
        }

        /* ═══════════════════════════════════════════════════════════════
           Timeline Styles - التصميم الجديد
           ═══════════════════════════════════════════════════════════════ */

        /* خلية اليوم (Timeline Container) */
        .day-cell {
            position: relative;
            min-width: 180px;
            width: 100%;
            /* ملء عرض الخلية بالكامل */
            height: 40px;
            background: transparent;
            /* شفاف - الخلفية تأتي من td.day-column */
            border-radius: 6px;
            overflow: hidden;
        }

        /* خط الوقت الخلفي */
        .day-cell::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-50%);
        }

        /* شريط المحاضرة */
        .session-bar {
            position: absolute;
            top: 4px;
            bottom: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 500;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            transition: all 0.2s ease;
            cursor: pointer;
            z-index: 1;
        }

        .session-bar:hover {
            transform: scaleY(1.1);
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .session-bar.theory {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .session-bar.practical {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .session-bar.blended {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .session-bar.coop {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        /* الشعبة المختارة - إطار ملون */
        .session-bar.selected {
            box-shadow: 0 0 0 2px var(--selection-color, #6366f1),
                0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* الشعبة المستهدفة - إطار أكثر وضوحاً */
        .session-bar.target {
            box-shadow: 0 0 0 3px var(--color-target),
                0 0 12px var(--color-target),
                0 2px 8px rgba(0, 0, 0, 0.3);
            animation: targetPulse 1.5s ease-in-out infinite;
        }

        @keyframes targetPulse {

            0%,
            100% {
                box-shadow: 0 0 0 3px var(--color-target), 0 0 12px var(--color-target);
            }

            50% {
                box-shadow: 0 0 0 4px var(--color-target), 0 0 20px var(--color-target);
            }
        }

        /* الشعبة الظاهرة (المختارة للعرض) - إطار أزرق مميز */
        .session-bar.visible-highlight {
            box-shadow: 0 0 0 2px #60a5fa,
                0 0 10px rgba(96, 165, 250, 0.6),
                0 2px 8px rgba(0, 0, 0, 0.3);
            transform: scaleY(1.05);
        }

        /* عند تطبيق الاثنين معاً - الشعبة ظاهرة ومستهدفة */
        .session-bar.visible-highlight.target {
            box-shadow: 0 0 0 3px var(--color-target),
                0 0 0 6px #60a5fa,
                0 0 15px var(--color-target),
                0 2px 8px rgba(0, 0, 0, 0.3);
            animation: targetPulse 1.5s ease-in-out infinite;
        }

        /* موضع الشعبة المستهدفة (الفراغ) */
        .target-slot {
            position: absolute;
            top: 4px;
            bottom: 4px;
            border: 2px dashed var(--color-target);
            border-radius: 4px;
            background: rgba(251, 191, 36, 0.15);
            z-index: 0;
        }

        /* صندوق الشعبة المستهدفة - متاح (أخضر/ذهبي) */
        .target-slot.available {
            border: 2px dashed var(--color-target);
            background: rgba(251, 191, 36, 0.2);
            animation: targetSlotPulse 1.5s ease-in-out infinite;
        }

        /* صندوق الشعبة المستهدفة - تعارض (أحمر) - يظهر فوق الشريط */
        .target-slot.conflict {
            border: 3px solid #ef4444;
            background: rgba(239, 68, 68, 0.35);
            animation: conflictPulse 1s ease-in-out infinite;
            z-index: 5;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
        }

        @keyframes targetSlotPulse {

            0%,
            100% {
                background: rgba(251, 191, 36, 0.15);
            }

            50% {
                background: rgba(251, 191, 36, 0.3);
            }
        }

        @keyframes conflictPulse {

            0%,
            100% {
                background: rgba(239, 68, 68, 0.2);
            }

            50% {
                background: rgba(239, 68, 68, 0.4);
            }
        }

        /* صناديق الفترات المعتمدة - سماوي */
        .freetime-period-slot {
            position: absolute;
            top: 2px;
            bottom: 2px;
            border-radius: 4px;
            z-index: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            cursor: help;
        }

        .freetime-period-slot .period-label {
            font-size: 0.6rem;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* متاح - سماوي */
        .freetime-period-slot.freetime-available {
            border: 2px dashed #22d3ee;
            background: rgba(34, 211, 238, 0.25);
            animation: freetimePulse 1.5s ease-in-out infinite;
            color: #67e8f9;
        }

        .freetime-period-slot.freetime-available:hover {
            background: rgba(34, 211, 238, 0.4);
            border-style: solid;
        }

        /* تعارض - برتقالي */
        .freetime-period-slot.freetime-conflict {
            border: 3px solid #f97316;
            background: rgba(249, 115, 22, 0.35);
            animation: freetimeConflictPulse 1s ease-in-out infinite;
            color: #fdba74;
            z-index: 6;
            box-shadow: 0 0 8px rgba(249, 115, 22, 0.6);
        }

        @keyframes freetimePulse {

            0%,
            100% {
                background: rgba(34, 211, 238, 0.2);
            }

            50% {
                background: rgba(34, 211, 238, 0.35);
            }
        }

        @keyframes freetimeConflictPulse {

            0%,
            100% {
                background: rgba(249, 115, 22, 0.25);
            }

            50% {
                background: rgba(249, 115, 22, 0.45);
            }
        }

        /* صناديق الفراغات المشتركة - أخضر متوهج */
        .free-slot {
            position: absolute;
            top: 2px;
            bottom: 2px;
            border: 2px dashed #22c55e;
            border-radius: 4px;
            background: rgba(34, 197, 94, 0.2);
            animation: freeSlotPulse 1.5s ease-in-out infinite;
            z-index: 1;
            pointer-events: auto;
            cursor: help;
        }

        .free-slot:hover {
            background: rgba(34, 197, 94, 0.35);
            border-style: solid;
        }

        @keyframes freeSlotPulse {

            0%,
            100% {
                background: rgba(34, 197, 94, 0.15);
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
            }

            50% {
                background: rgba(34, 197, 94, 0.3);
                box-shadow: 0 0 8px 2px rgba(34, 197, 94, 0.5);
            }
        }

        /* صفوف المتدربين المتاحين */
        .data-table tbody tr.available-row {
            background: rgba(34, 197, 94, 0.08);
        }

        .data-table tbody tr.available-row:hover {
            background: rgba(34, 197, 94, 0.15);
        }

        /* صفوف المتدربين المتعارضين */
        .data-table tbody tr.conflict-row {
            background: rgba(239, 68, 68, 0.08);
        }

        .data-table tbody tr.conflict-row:hover {
            background: rgba(239, 68, 68, 0.15);
        }

        /* ألوان الشعب المختارة */
        .selection-color-1 {
            --selection-color: #6366f1;
        }

        .selection-color-2 {
            --selection-color: #ec4899;
        }

        .selection-color-3 {
            --selection-color: #14b8a6;
        }

        .selection-color-4 {
            --selection-color: #f97316;
        }

        .selection-color-5 {
            --selection-color: #84cc16;
        }

        /* رؤوس الجدول الثابتة */
        .data-table thead {
            position: sticky;
            top: 0;
            z-index: 20;
            background: var(--bg-secondary);
        }

        /* الأعمدة الثابتة */
        .data-table .col-id,
        .data-table .col-name,
        .data-table .col-dept,
        .data-table .col-stat {
            position: sticky;
            background: var(--bg-secondary);
            z-index: 15;
        }

        .data-table .col-id {
            left: 0;
        }

        .data-table .col-name {
            left: 40px;
        }

        .data-table .col-dept {
            left: 220px;
            /* 40 + 180 */
        }

        .data-table .col-stat {
            left: 320px;
            /* 40 + 180 + 100 */
        }

        /* التمرير الأفقي */
        .data-table-wrapper {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 400px;
        }

        /* عرض أعمدة الأيام */
        .day-column {
            min-width: 180px;
            text-align: center;
            padding: 4px;
        }

        /* Tooltip للمحاضرات */
        .session-bar[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            border-radius: 6px;
            white-space: pre-line;
            font-size: 0.7rem;
            z-index: 100;
            pointer-events: none;
        }

        /* ═══════════════════════════════════════════════════════════════
           Multi-Select Component - مكون الاختيار المتعدد
           ═══════════════════════════════════════════════════════════════ */

        .multi-select {
            position: relative;
            min-width: 150px;
        }

        .multi-select-trigger {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .multi-select-trigger:hover {
            border-color: var(--color-accent);
        }

        .multi-select-trigger .count-badge {
            background: var(--color-accent);
            color: white;
            font-size: 0.7rem;
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* Dropdown is the highest */
        .multi-select-dropdown {
            z-index: 9999 !important;
            position: absolute;
            top: 100%;
            right: 0;
            /* Align to right for RTL */
            left: auto;
            min-width: 200px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-lg);
            display: none;
            max-height: 250px;
            overflow: hidden;
            font-size: 0.8rem;
        }

        .multi-select.open .multi-select-dropdown {
            display: block;
        }

        .multi-select-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .multi-select-search {
            flex: 1;
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.4rem 0.6rem;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .multi-select-search:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .multi-select-actions {
            display: flex;
            gap: 0.25rem;
        }

        .multi-select-actions button {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.3rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .multi-select-actions button:hover {
            background: var(--bg-glass);
            color: var(--color-accent);
        }

        .multi-select-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .multi-select-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .multi-select-option:hover {
            background: var(--bg-glass);
        }

        .multi-select-option.selected {
            background: rgba(99, 102, 241, 0.15);
        }

        .multi-select-option input {
            accent-color: var(--color-accent);
        }

        .multi-select-option .trainee-count {
            margin-right: auto;
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bg-glass);
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
        }

        /* ═══════════════════════════════════════════════════════════════
           Section Search Input - قائمة البحث عن الشعب (مشتركة)
           ═══════════════════════════════════════════════════════════════ */
        .section-search-input {
            position: relative;
            min-width: 160px;
        }

        .section-search-input input {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: 0.3rem 0.5rem;
            color: var(--text-primary);
            font-size: 0.75rem;
            font-family: var(--font-family);
        }

        .section-search-input input:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        /* الشعب الظاهرة - لون أزرق */
        .visible-section-input input {
            border-color: var(--color-accent);
        }

        .visible-section-input input:focus {
            box-shadow: 0 0 8px rgba(99, 102, 241, 0.3);
        }

        /* الشعب المستهدفة - لون ذهبي */
        .target-section-input input {
            border-color: var(--color-target);
        }

        .target-section-input input:focus {
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.3);
        }

        /* القائمة المنسدلة المشتركة */
        .section-search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            min-width: 280px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            font-size: 0.7rem;
        }

        .section-search-dropdown.show {
            display: block;
        }

        /* عناصر القائمة المنسدلة */
        .section-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.4rem 0.5rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s ease;
            font-size: 0.7rem;
        }

        .section-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .section-item:last-child {
            border-bottom: none;
        }

        .section-item .section-info {
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
        }

        .section-item .section-code {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.7rem;
        }

        .section-item .section-name {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }

        .section-item .trainee-badge {
            background: var(--color-accent);
            color: white;
            font-weight: 600;
            padding: 0.1rem 0.3rem;
            border-radius: 4px;
            font-size: 0.65rem;
        }

        /* Target dropdown specific */
        .target-section-dropdown .section-item:hover {
            background: rgba(251, 191, 36, 0.1);
        }

        .target-section-dropdown .section-item .trainee-badge {
            background: var(--color-target);
            color: #000;
        }

        /* ═══════════════════════════════════════════════════════════════
           Section Chips Inline - الشعب المختارة في نفس الصف
           ═══════════════════════════════════════════════════════════════ */
        .section-chips-inline {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            align-items: center;
        }

        .section-chip {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.2rem 0.4rem 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.65rem;
            animation: chipIn 0.2s ease;
        }

        /* الشعب الظاهرة - أزرق */
        .section-chip.visible {
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid var(--color-accent);
            color: var(--text-primary);
        }

        /* الشعب المستهدفة - ذهبي */
        .section-chip.target {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid var(--color-target);
            color: var(--text-primary);
        }

        .section-chip .chip-count {
            font-weight: 600;
            padding: 0.05rem 0.25rem;
            border-radius: 8px;
            font-size: 0.6rem;
        }

        .section-chip.visible .chip-count {
            background: var(--color-accent);
            color: white;
        }

        .section-chip.target .chip-count {
            background: var(--color-target);
            color: #000;
        }

        /* عدد المتدربين المتاحين للنقل - دائرة زرقاء متوهجة */
        .section-chip.target .chip-available {
            font-weight: 700;
            padding: 0.1rem 0.35rem;
            border-radius: 10px;
            font-size: 0.65rem;
            background: var(--color-accent);
            color: white;
            margin-right: 2px;
            animation: availablePulse 1.5s ease-in-out infinite;
            cursor: help;
        }

        @keyframes availablePulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
            }

            50% {
                box-shadow: 0 0 8px 3px rgba(99, 102, 241, 0.6);
            }
        }

        .section-chip .chip-ref {
            font-size: 0.55rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .section-chip .chip-remove {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            font-size: 0.8rem;
            line-height: 1;
        }

        .section-chip .chip-remove:hover {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        /* الفاصل بين الأقسام */
        .filter-divider {
            width: 1px;
            height: 24px;
            background: var(--border-color);
            margin: 0 0.5rem;
        }

        /* Target Chips - الشعب المستهدفة */
        .target-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        /* Multi-select List Items */
        .multi-select-list {
            max-height: 200px;
            overflow-y: auto;
            padding: 0.5rem 0;
        }

        /* تصميم مربع الاختيار المخصص - يعمل في كل المتصفحات */
        .multi-select-option {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.5rem 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
            color: var(--text-primary);
            position: relative;
        }

        .multi-select-option:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        /* إخفاء الـ checkbox الأصلي */
        .multi-select-option input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
            margin: 0;
            padding: 0;
        }

        /* مربع الاختيار المخصص */
        .custom-checkbox {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border: 2px solid var(--text-secondary);
            border-radius: 4px;
            background-color: transparent;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        /* حالة التحديد - الخلفية */
        .multi-select-option input[type="checkbox"]:checked+.custom-checkbox,
        .multi-select-option.checked .custom-checkbox {
            background-color: var(--color-accent);
            border-color: var(--color-accent);
        }

        /* علامة الصح */
        .multi-select-option input[type="checkbox"]:checked+.custom-checkbox::after,
        .multi-select-option.checked .custom-checkbox::after {
            content: '';
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
            margin-bottom: 2px;
        }

        /* تأثير عند المرور */
        .multi-select-option:hover .custom-checkbox {
            border-color: var(--color-accent);
        }

        /* نص الخيار */
        .option-text {
            flex: 1;
        }

        .target-chip {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid var(--color-target);
            border-radius: 20px;
            padding: 0.3rem 0.6rem 0.3rem 0.8rem;
            font-size: 0.8rem;
            animation: chipIn 0.2s ease;
        }

        @keyframes chipIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .target-chip .chip-count {
            background: var(--color-target);
            color: #000;
            font-weight: 600;
            padding: 0.1rem 0.35rem;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .target-chip .chip-remove {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.1rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .target-chip .chip-remove:hover {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .btn-home {
            background: rgba(99, 102, 241, 0.15);
            color: var(--color-accent);
            border: 1px solid var(--color-accent);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 1rem;
        }

        .btn-home:hover {
            background: var(--color-accent);
            color: white;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.4);
        }

        .btn-home i {
            width: 18px;
            height: 18px;
        }

        /* ═══════════════════════════════════════════════════════════════
           زر فراغات شعبة جديدة
           ═══════════════════════════════════════════════════════════════ */
        .availability-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(6, 182, 212, 0.2));
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.5);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 1rem;
        }

        .availability-btn:hover {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.4), rgba(6, 182, 212, 0.4));
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
            transform: translateY(-1px);
        }

        .availability-btn i {
            width: 18px;
            height: 18px;
        }

        /* زر فراغات شعبة جديدة - الإصدار السماوي */
        .availability-btn-cyan {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.2), rgba(6, 182, 212, 0.25));
            color: #22d3ee;
            border: 2px solid rgba(34, 211, 238, 0.5);
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .availability-btn-cyan:hover {
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.35), rgba(6, 182, 212, 0.4));
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.5);
            transform: translateY(-2px);
            border-color: #22d3ee;
        }

        .availability-btn-cyan i {
            width: 20px;
            height: 20px;
        }

        /* ═══════════════════════════════════════════════════════════════
           صفحة تحليل الفراغات
           ═══════════════════════════════════════════════════════════════ */
        .availability-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 1000;
            padding: 1rem;
            overflow: auto;
        }

        .availability-page.show {
            display: block;
        }

        .availability-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .availability-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .availability-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            flex: 1;
            text-align: center;
        }

        .close-btn {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.5);
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: #ef4444;
            color: white;
        }

        .close-btn i {
            width: 24px;
            height: 24px;
        }

        /* دليل الألوان */
        .availability-legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-color.trainers-color {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
        }

        .legend-color.trainees-color {
            background: linear-gradient(135deg, #10b981, #14b8a6);
        }

        .legend-color.percentage-color {
            background: linear-gradient(135deg, #f59e0b, #eab308);
        }

        /* جدول التحليل */
        .availability-table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .availability-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .availability-table th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 600;
            padding: 0.75rem 1rem;
            text-align: center;
            border-bottom: 2px solid var(--border-color);
        }

        .availability-table th.period-header {
            width: 120px;
            text-align: right;
        }

        .availability-table td {
            padding: 0.5rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .availability-table td.period-cell {
            text-align: right;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--text-primary);
            white-space: nowrap;
        }

        .period-time {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* محتوى الخلية - 3 صفوف */
        .availability-cell {
            display: flex;
            flex-direction: column;
            gap: 1px;
            padding: 0.2rem;
            border-radius: 8px;
            background: var(--bg-card);
        }

        .cell-trainers,
        .cell-trainees,
        .cell-percentage {
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.7rem;
        }

        .cell-trainers {
            background: rgba(99, 102, 241, 0.15);
            color: #818cf8;
        }

        .cell-trainees {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
        }

        .cell-percentage {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
        }

        /* ألوان خلفية الفترات */
        .period-group-1 {
            background: rgba(239, 68, 68, 0.05);
        }

        /* أحمر */
        .period-group-2 {
            background: rgba(249, 115, 22, 0.05);
        }

        /* برتقالي */
        .period-group-3 {
            background: rgba(234, 179, 8, 0.05);
        }

        /* أصفر */
        .period-group-4 {
            background: rgba(34, 197, 94, 0.05);
        }

        /* أخضر */
        .period-group-5 {
            background: rgba(6, 182, 212, 0.05);
        }

        /* سماوي */

        /* فاصل بين أيام الأسبوع */
        .day-separator td {
            border-top: 5px solid var(--bg-primary) !important;
        }

        /* خلية اليوم - فقط في صفحة التحليل */
        .availability-table .day-cell {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--text-primary);
            text-align: right;
            padding: 0.5rem 0.6rem;
            background: var(--bg-secondary);
            white-space: nowrap;
            width: 50px;
        }

        /* تنسيق رأس الفترة (عمودي) */
        .availability-table th.period-header {
            font-size: 0.75rem;
            padding: 0.5rem;
            min-width: 80px;
        }

        .availability-table th.period-header .period-time {
            display: block;
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* توسيط عناوين الفترات */
        .availability-table th.period-header {
            text-align: center;
        }

        /* عمود التسميات */
        .labels-header {
            font-size: 0.8rem;
            min-width: 138px;
            text-align: center;
        }

        .labels-cell {
            padding: 0.3rem;
            vertical-align: middle;
        }

        /* تنسيق عمود البيان ليشابه خلايا الفترات */
        .labels-cell-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 0.2rem;
            border-radius: 8px;
            background: var(--bg-card);
        }

        .label-row {
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-align: center;
        }

        .label-trainers {
            background: rgba(99, 102, 241, 0.15);
            color: #818cf8;
        }

        .label-trainees {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
        }

        .label-percentage {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
        }

        /* خلية بدون متدربين متاحين - إطار أحمر */
        .availability-cell.no-availability {
            border: 2px solid #ef4444;
            border-radius: 8px;
            box-shadow: 0 0 6px rgba(239, 68, 68, 0.3);
        }

        .availability-cell.no-availability .cell-trainees {
            background: rgba(239, 68, 68, 0.3);
            color: #f87171;
        }

        /* عدد المدربين = 0 - نص أحمر فقط */
        .cell-trainers.no-trainers {
            color: #ef4444 !important;
            background: rgba(239, 68, 68, 0.2);
        }

        /* خلية قابلة للنقر */
        .availability-cell.clickable {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .availability-cell.clickable:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.4);
        }

        /* خلية غير قابلة للنقر (حمراء) */
        .availability-cell.no-availability:not(.selected) {
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* خلية مختارة */
        .availability-cell.selected {
            border: 3px solid #22d3ee !important;
            box-shadow: 0 0 12px rgba(34, 211, 238, 0.5) !important;
            background: rgba(34, 211, 238, 0.1);
        }

        .availability-cell.selected::after {
            content: '✓';
            position: absolute;
            top: -8px;
            right: -8px;
            width: 18px;
            height: 18px;
            background: #22d3ee;
            color: #0f172a;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* جعل الخلية position: relative للعلامة */
        .availability-cell.clickable,
        .availability-cell.selected {
            position: relative;
        }

        /* أزرار صفحة التحليل */
        .availability-actions {
            display: flex;
            gap: 0.75rem;
            margin-right: auto;
        }

        .apply-periods-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
            transition: all 0.3s;
            opacity: 0.5;
        }

        .apply-periods-btn.active {
            opacity: 1;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-color: transparent;
        }

        .apply-periods-btn.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .reset-periods-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .reset-periods-btn:hover {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border-color: rgba(239, 68, 68, 0.3);
        }


        .top-bar {
            position: relative;
            z-index: 500;
            /* الحل الجذري: رفع الحاوية بالكامل */
            background: var(--bg-primary);
            /* ضمان خلفية للمنع الشفافية */
        }

        /* Filter Row Layout - Compact with ULTIMATE z-index fix */
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.75rem;
            padding: 0.4rem 0.75rem;
            background: var(--bg-card);
            border-radius: var(--border-radius-sm);
            margin-bottom: 0.25rem;
            position: relative;
            z-index: 50;
            /* الصفوف العادية */
        }

        /* الصف الأول (الفلاتر) يجب أن يكون أعلى من الصف الثاني */
        .top-bar>.filter-row:first-child,
        .filter-row:nth-child(1) {
            z-index: 60 !important;
        }

        /* منطقة الجداول تحت الفلاتر بشكل نهائي */
        .tables-container,
        .table-section,
        .data-table-wrapper {
            position: relative;
            z-index: 1 !important;
        }

        /* Multi-select container needs high z-index */
        .multi-select {
            position: relative;
            z-index: 999 !important;
        }

        /* Dropdown is the highest */
        .multi-select-dropdown {
            z-index: 9999 !important;
        }

        .filter-section {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 0.4rem;
        }

        .filter-section-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* تنسيق الصف العلوي */
        .control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .toggles-group {
            display: flex;
            gap: 1rem;
        }

        /* ═══════════════════════════════════════════════════════════════
           الجولة التفاعلية - Interactive Tour
           ═══════════════════════════════════════════════════════════════ */
        .tour-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            z-index: 9998;
            pointer-events: none;
        }

        .tour-overlay.active {
            display: block;
        }

        .tour-spotlight {
            display: none;
            position: fixed;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            z-index: 9999;
            pointer-events: none;
            transition: all 0.4s ease;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #22d3ee;
        }

        .tour-tooltip {
            display: none;
            position: fixed;
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 2px solid #22d3ee;
            border-radius: 12px;
            padding: 1.25rem;
            max-width: 320px;
            z-index: 10000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 20px rgba(34, 211, 238, 0.3);
        }

        .tour-tooltip.active {
            display: block;
            animation: tourFadeIn 0.3s ease;
        }

        @keyframes tourFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tour-step-indicator {
            color: #22d3ee;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .tour-title {
            color: #f1f5f9;
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .tour-description {
            color: #94a3b8;
            font-size: 0.85rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .tour-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
        }

        .tour-btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .tour-btn-next {
            background: #22d3ee;
            color: #0f172a;
            border: none;
        }

        .tour-btn-next:hover {
            background: #67e8f9;
            transform: translateY(-1px);
        }

        .tour-btn-prev {
            background: transparent;
            color: #94a3b8;
            border: 1px solid #475569;
        }

        .tour-btn-prev:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #f1f5f9;
        }

        .tour-btn-skip {
            background: transparent;
            color: #64748b;
            border: none;
            font-size: 0.75rem;
        }

        .tour-btn-skip:hover {
            color: #ef4444;
        }

        .tour-arrow {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #1e293b;
            border: 2px solid #22d3ee;
            transform: rotate(45deg);
        }

        .tour-arrow.top {
            top: -8px;
            border-right: none;
            border-bottom: none;
        }

        .tour-arrow.bottom {
            bottom: -8px;
            border-left: none;
            border-top: none;
        }

        .tour-arrow.left {
            left: -8px;
            border-right: none;
            border-top: none;
        }

        .tour-arrow.right {
            right: -8px;
            border-left: none;
            border-bottom: none;
        }

        /* زر إعادة الجولة */
        .restart-tour-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(34, 211, 238, 0.2);
            border: 1px solid rgba(34, 211, 238, 0.4);
            color: #22d3ee;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .restart-tour-btn:hover {
            background: rgba(34, 211, 238, 0.3);
            box-shadow: 0 0 15px rgba(34, 211, 238, 0.3);
        }

        .restart-tour-btn i {
            width: 16px;
            height: 16px;
        }
    </style>
</head>

<body>
    <!-- ═══════════════════════════════════════════════════════════════
         الجولة التفاعلية - Interactive Tour
         ═══════════════════════════════════════════════════════════════ -->
    <div class="tour-overlay" id="tourOverlay"></div>
    <div class="tour-spotlight" id="tourSpotlight"></div>
    <div class="tour-tooltip" id="tourTooltip">
        <div class="tour-arrow" id="tourArrow"></div>
        <div class="tour-step-indicator" id="tourStepIndicator"></div>
        <div class="tour-title" id="tourTitle"></div>
        <div class="tour-description" id="tourDescription"></div>
        <div class="tour-navigation">
            <button class="tour-btn tour-btn-skip" onclick="endTour()">تخطي الجولة</button>
            <div>
                <button class="tour-btn tour-btn-prev" id="tourPrevBtn" onclick="prevTourStep()">◄ السابق</button>
                <button class="tour-btn tour-btn-next" id="tourNextBtn" onclick="nextTourStep()">التالي ►</button>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         صفحة رفع الملفات
         ═══════════════════════════════════════════════════════════════ -->
    <div class="upload-page" id="uploadPage">
        <h1 class="upload-title">تطبيق جداول الشعب التدريبية</h1>

        <!-- بطاقات المميزات -->
        <div class="features-container">
            <div class="feature-card">
                <i data-lucide="scale" class="feature-icon"></i>
                <span class="feature-text">موازنة أعداد الشعب</span>
            </div>
            <div class="feature-card">
                <i data-lucide="calendar-clock" class="feature-icon"></i>
                <span class="feature-text">تغيير موعد شعبة</span>
            </div>
            <div class="feature-card">
                <i data-lucide="search" class="feature-icon"></i>
                <span class="feature-text">بحث مواعيد جديدة</span>
            </div>
        </div>

        <p class="upload-privacy">🔒 جميع البيانات تُعالج وتُخزن على جهازك ولا يتم رفع أو تخزين أي بيانات على السحابة
        </p>

        <div class="upload-container">
            <!-- ملف SS01 -->
            <div class="upload-zone" id="ss01Zone" data-file="ss01">
                <div class="upload-zone-icon"><i data-lucide="calendar"></i></div>
                <div class="upload-zone-title">ملف SS01</div>
                <div class="upload-zone-desc">جداول الوحدة التدريبية طولي
                </div>
                <div class="upload-zone-hint">اسحب وأفلت الملف هنا أو انقر للاختيار</div>
                <div class="upload-zone-success"><i data-lucide="check-circle-2"></i> تم الرفع بنجاح</div>

                <!-- زر الحذف -->
                <button class="delete-file-btn" onclick="event.stopPropagation(); deleteUploadedFile('ss01')"
                    title="حذف الملف">
                    <i data-lucide="trash-2"></i>
                </button>

                <!-- حاوية نتائج التحقق من SS01 -->
                <div id="ss01ValidationInfo"
                    style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 0.85em; text-align: right;">
                </div>

                <div class="upload-progress">
                    <div class="upload-progress-bar"></div>
                </div>
            </div>

            <!-- ملف SF01 -->
            <div class="upload-zone" id="sf01Zone" data-file="sf01">
                <div class="upload-zone-icon"><i data-lucide="file-text"></i></div>
                <div class="upload-zone-title">ملف SF01</div>
                <div class="upload-zone-desc">قائمة بالمتدربين المسجلين في شعبة تدريبية</div>
                <div class="upload-zone-hint">
                    اسحب وأفلت الملف هنا أو انقر للاختيار
                    <div
                        style="margin-top: 8px; font-size: 0.85em; color: #f59e0b; background: rgba(245, 158, 11, 0.1); padding: 4px 8px; border-radius: 4px;">
                        ⚠️ تنبيه: عند طلب التقرير، يجب اختيار <strong>(الكل)</strong> في جميع الخيارات
                    </div>
                </div>
                <div class="upload-zone-success"><i data-lucide="check-circle-2"></i> تم الرفع بنجاح</div>

                <!-- زر الحذف -->
                <button class="delete-file-btn" onclick="event.stopPropagation(); deleteUploadedFile('sf01')"
                    title="حذف الملف">
                    <i data-lucide="trash-2"></i>
                </button>

                <!-- حاوية نتائج التحقق -->
                <div id="sf01ValidationInfo"
                    style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 0.85em; text-align: right;">
                </div>

                <div class="upload-progress">
                    <div class="upload-progress-bar"></div>
                </div>
            </div>
        </div>

        <button class="upload-btn" id="startBtn">ابدأ</button>

        <input type="file" id="fileInput" accept=".csv" hidden>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         الصفحة الرئيسية
         ═══════════════════════════════════════════════════════════════ -->
    <div class="main-page" id="mainPage">

        <!-- الشريط العلوي -->
        <div class="top-bar">
            <!-- الصف الأول: مقسم إلى نصفين -->
            <div class="split-rows-container control-split-row">
                <!-- النصف الأيمن: أدوات التحكم -->
                <div class="section-row controls-row">
                    <!-- زر العودة للرئيسية -->
                    <button class="btn-home" onclick="goToUploadPage()" title="العودة للرئيسية">
                        <i data-lucide="home" style="width: 18px; height: 18px;"></i>
                    </button>

                    <!-- زر دليل الاستخدام -->
                    <button class="btn-help" onclick="startTour()" title="دليل الاستخدام">
                        <i data-lucide="help-circle" style="width: 18px; height: 18px;"></i>
                    </button>

                    <!-- مجموعة التبديل (متوسطة) -->
                    <div class="toggles-group">
                        <div class="toggle-container">
                            <div class="toggle" id="freeSlotsToggle" onclick="toggleFreeSlots()"></div>
                            <span class="toggle-label">تحديد الفراغات</span>
                        </div>
                        <div class="toggle-container">
                            <div class="toggle" id="mergeIdenticalToggle" onclick="toggleMergeIdentical()"></div>
                            <span class="toggle-label">دمج المتطابقين</span>
                        </div>
                        <div class="toggle-container">
                            <div class="toggle" id="freeOnlySwitch" onclick="toggleFreeOnly()"></div>
                            <span class="toggle-label">المتاحين فقط</span>
                        </div>
                    </div>
                </div>

                <!-- النصف الأيسر: فراغات شعبة جديدة -->
                <div class="section-row freetime-row">
                    <div class="section-input-group freetime-input-group">
                        <span class="filter-section-label freetime-label">
                            <i data-lucide="clock"
                                style="width: 16px; height: 16px; vertical-align: middle; margin-left: 4px;"></i>
                            فراغات شعبة جديدة
                        </span>
                        <button class="freetime-search-btn" onclick="showAvailabilityPage()"
                            title="تحليل الفترات المتاحة لفتح شعبة جديدة">
                            <i data-lucide="search"></i>
                            <span>البحث عن موعد</span>
                        </button>
                        <!-- زر إعادة تعيين الفترات المعتمدة -->
                        <button class="freetime-reset-btn" id="freetimeResetBtn" onclick="resetSelectedPeriods()"
                            title="إعادة تعيين الفترات المعتمدة" style="display: none;">
                            <i data-lucide="x-circle"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- الصف المقسم: الشعب الظاهرة والمستهدفة -->
            <div class="split-rows-container">
                <!-- النصف الأيمن: الشعب الظاهرة -->
                <div class="section-row visible-row">
                    <div class="section-input-group">
                        <span class="filter-section-label"><i data-lucide="list"
                                style="width: 16px; height: 16px; vertical-align: middle; margin-left: 4px;"></i> الشعب
                            الظاهرة</span>
                        <div class="section-search-input visible-section-input">
                            <input type="text" id="visibleSectionSearch" placeholder="ابحث عن شعبة..."
                                oninput="searchVisibleSections(this.value)" onfocus="showVisibleDropdown()"
                                autocomplete="off">
                            <div class="section-search-dropdown" id="visibleSectionDropdown"></div>
                        </div>
                    </div>
                    <div class="section-chips-inline" id="visibleChipsContainer"></div>
                </div>

                <!-- النصف الأيسر: الشعب المستهدفة -->
                <div class="section-row target-row">
                    <div class="section-input-group">
                        <span class="filter-section-label"><i data-lucide="target"
                                style="width: 16px; height: 16px; vertical-align: middle; margin-left: 4px;"></i> الشعب
                            المستهدفة</span>
                        <div class="section-search-input target-section-input">
                            <input type="text" id="targetSectionSearch" placeholder="ابحث عن شعبة..."
                                oninput="searchTargetSections(this.value)" onfocus="showTargetDropdown()"
                                autocomplete="off">
                            <div class="section-search-dropdown target-section-dropdown" id="targetSectionDropdown">
                            </div>
                        </div>
                    </div>
                    <div class="section-chips-inline" id="targetChipsContainer"></div>
                </div>
            </div>
        </div>

        <!-- منطقة الجداول -->
        <div class="tables-container">
            <!-- جدول المدربين -->
            <div class="table-section">
                <div class="table-header">
                    <span class="table-icon"><i data-lucide="presentation"></i></span>
                    <span class="table-title">المدربين</span>
                    <span class="table-count">2 مدرب</span>
                </div>

                <div class="data-table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th rowspan="2" class="col-id">#</th>
                                <th rowspan="2" class="col-name">المدرب</th>
                                <th rowspan="2" class="col-stat text-contact">اتصال</th>
                                <th rowspan="2" class="col-stat text-quota">النصابth>
                                <th class="day-header day-sun" colspan="4">الأحد</th>
                                <th class="day-header" colspan="4">الاثنين</th>
                                <th class="day-header" colspan="4">الثلاثاء</th>
                                <th class="day-header" colspan="4">الأربعاء</th>
                                <th class="day-header" colspan="4">الخميس</th>
                            </tr>
                            <tr>
                                <!-- الأحد -->
                                <th class="time-header">7:30</th>
                                <th class="time-header">9:15</th>
                                <th class="time-header">10:55</th>
                                <th class="time-header">12:40</th>
                                <!-- الاثنين -->
                                <th class="time-header">7:30</th>
                                <th class="time-header">9:15</th>
                                <th class="time-header">10:55</th>
                                <th class="time-header">12:40</th>
                                <!-- الثلاثاء -->
                                <th class="time-header">7:30</th>
                                <th class="time-header">9:15</th>
                                <th class="time-header">10:55</th>
                                <th class="time-header">12:40</th>
                                <!-- الأربعاء -->
                                <th class="time-header">7:30</th>
                                <th class="time-header">9:15</th>
                                <th class="time-header">10:55</th>
                                <th class="time-header">12:40</th>
                                <!-- الخميس -->
                                <th class="time-header">7:30</th>
                                <th class="time-header">9:15</th>
                                <th class="time-header">10:55</th>
                                <th class="time-header">12:40</th>
                            </tr>
                        </thead>
                        <tbody>
                            <td>1</td>
                            <td class="col-name">محمد يوسف الشبيلي</td>
                            <td class="text-contact">16</td>
                            <td class="text-quota">18</td>
                            <!-- الأحد -->
                            <td>
                                <div class="time-cell theory split">
                                    <div class="cell-tooltip">
                                        <div class="cell-tooltip-header">14894 - صيانة النظم</div>
                                        <div class="cell-tooltip-row"><span>النوع</span><span
                                                class="cell-tooltip-val">نظري</span></div>
                                        <div class="cell-tooltip-row"><span>القاعة</span><span
                                                class="cell-tooltip-val">A-101</span></div>
                                        <div class="cell-tooltip-row"><span>المسجلين</span><span
                                                class="cell-tooltip-val">24</span></div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="time-cell practical"></div>
                            </td>
                            <td>
                                <div class="time-cell empty"></div>
                            </td>
                            <td>
                                <div class="time-cell empty"></div>
                            </td>
                            <!-- الاثنين -->
                            <td>
                                <div class="time-cell practical"></div>
                            </td>
                            <td>
                                <div class="time-cell practical"></div>
                            </td>
                            <td>
                                <div class="time-cell theory target"></div>
                            </td>
                            <td>
                                <div class="time-cell empty"></div>
                            </td>
                            <!-- الثلاثاء -->
                            <td>
                                <div class="time-cell theory"></div>
                            </td>
                            <td>
                                <div class="time-cell practical"></div>
                            </td>
                            <td>
                                <div class="time-cell blended split">
                                    <div class="cell-tooltip">
                                        <div class="cell-tooltip-header">14905 - الآلات الدوارة</div>
                                        <div class="cell-tooltip-row"><span>النوع</span><span
                                                class="cell-tooltip-val">مدمج</span></div>
                                        <div class="cell-tooltip-row"><span>جزء</span><span
                                                class="cell-tooltip-val">2/2</span></div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="time-cell empty"></div>
                            </td>
                            <!-- الأربعاء -->
                            <td>
                                <div class="time-cell empty"></div>
                            </td>
                            <td>
                                <div class="time-cell practical"></div>
                            </td>
                            <td>
                                <div class="time-cell practical"></div>
                            </td>
                            <td>
                                <div class="time-cell empty"></div>
                            </td>
                            <!-- الخميس -->
                            <td>
                                <div class="time-cell theory"></div>
                            </td>
                            <td>
                                <div class="time-cell practical"></div>
                            </td>
                            <td>
                                <div class="time-cell practical"></div>
                            </td>
                            <td>
                                <div class="time-cell empty"></div>
                            </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- جدول المتدربين -->
            <div class="table-section">
                <div class="table-header">
                    <span class="table-icon"><i data-lucide="graduation-cap"></i></span>
                    <span class="table-title">المتدربين</span>
                    <span class="table-count">15 متدرب</span>
                </div>

                <div class="data-table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th rowspan="2" class="col-id">#</th>
                                <th rowspan="2" class="col-name">المتدرب</th>
                                <th rowspan="2" class="col-stat text-contact">الرقم</th>
                                <th rowspan="2" class="col-stat text-credits">س. م.</th>
                                <th class="day-header day-sun" colspan="4">الأحد</th>
                                <th class="day-header day-mon" colspan="4">الاثنين</th>
                                <th class="day-header day-tue" colspan="4">الثلاثاء</th>
                                <th class="day-header day-wed" colspan="4">الأربعاء</th>
                                <th class="day-header day-thu" colspan="4">الخميس</th>
                            </tr>
                            <tr>
                                <!-- الأحد -->
                                <th class="time-header">7:30</th>
                                <th class="time-header">9:15</th>
                                <th class="time-header">10:55</th>
                                <th class="time-header">12:40</th>
                                <!-- الاثنين -->
                                <th class="time-header">7:30</th>
                                <th class="time-header">9:15</th>
                                <th class="time-header">10:55</th>
                                <th class="time-header">12:40</th>
                                <!-- الثلاثاء -->
                                <th class="time-header">7:30</th>
                                <th class="time-header">9:15</th>
                                <th class="time-header">10:55</th>
                                <th class="time-header">12:40</th>
                                <!-- الأربعاء -->
                                <th class="time-header">7:30</th>
                                <th class="time-header">9:15</th>
                                <th class="time-header">10:55</th>
                                <th class="time-header">12:40</th>
                                <!-- الخميس -->
                                <th class="time-header">7:30</th>
                                <th class="time-header">9:15</th>
                                <th class="time-header">10:55</th>
                                <th class="time-header">12:40</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td class="col-name">
                                    <span class="trainee-id">
                                        444117138
                                        <div class="tooltip">
                                            <div class="tooltip-row">
                                                <span class="tooltip-icon"><i data-lucide="user"></i></span>
                                                <div>
                                                    <div class="tooltip-label">الاسم</div>
                                                    <div class="tooltip-value">فيصل يوسف العبدالجبار</div>
                                                </div>
                                            </div>
                                            <div class="tooltip-row">
                                                <span class="tooltip-icon"><i data-lucide="graduation-cap"></i></span>
                                                <div>
                                                    <div class="tooltip-label">التخصص</div>
                                                    <div class="tooltip-value">تقنية الصيانة الميكانيكية</div>
                                                </div>
                                            </div>
                                            <div class="tooltip-row">
                                                <span class="tooltip-icon"><i data-lucide="smartphone"></i></span>
                                                <div>
                                                    <div class="tooltip-label">الجوال</div>
                                                    <div class="tooltip-value">05xxxxxxxx</div>
                                                </div>
                                            </div>
                                            <div class="tooltip-row">
                                                <span class="tooltip-icon"><i data-lucide="book-open"></i></span>
                                                <div>
                                                    <div class="tooltip-label">المقررات</div>
                                                    <div class="tooltip-courses">
                                                        <span class="course-badge">صيانة النظم</span>
                                                        <span class="course-badge">الآلات الدوارة</span>
                                                        <span class="course-badge">الرسم الهندسي</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="tooltip-row">
                                                <span class="tooltip-icon"><i data-lucide="clock"></i></span>
                                                <div>
                                                    <div class="tooltip-label">الساعات المعتمدة</div>
                                                    <div class="tooltip-value">16 ساعة</div>
                                                </div>
                                            </div>
                                        </div>
                                    </span>
                                </td>
                                <td class="text-credits">16</td>
                                <!-- الأحد -->
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <!-- الاثنين -->
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty target"></div>
                                </td>
                                <td>
                                    <div class="time-cell theory"></div>
                                </td>
                                <!-- الثلاثاء -->
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <!-- الأربعاء -->
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <!-- الخميس -->
                                <td>
                                    <div class="time-cell theory"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td class="col-name">
                                    <span class="trainee-id">444117587</span>
                                </td>
                                <td class="text-credits">20</td>
                                <!-- الأحد -->
                                <td>
                                    <div class="time-cell theory"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <!-- الاثنين -->
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical target"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <!-- الثلاثاء -->
                                <td>
                                    <div class="time-cell theory"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell blended"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <!-- الأربعاء -->
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <!-- الخميس -->
                                <td>
                                    <div class="time-cell theory"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                            </tr>
                            <tr>
                                <td>3</td>
                                <td class="col-name">
                                    <span class="trainee-id">444117670</span>
                                </td>
                                <td class="text-credits">15</td>
                                <!-- الأحد -->
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell theory"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <!-- الاثنين -->
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty target"></div>
                                </td>
                                <td>
                                    <div class="time-cell theory"></div>
                                </td>
                                <!-- الثلاثاء -->
                                <td>
                                    <div class="time-cell theory"></div>
                                </td>
                                <td>
                                    <div class="time-cell theory"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <!-- الأربعاء -->
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <!-- الخميس -->
                                <td>
                                    <div class="time-cell theory"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         صفحة تحليل الفراغات
         ═══════════════════════════════════════════════════════════════ -->
    <div class="availability-page" id="availabilityPage">
        <div class="availability-container">
            <!-- الشريط العلوي -->
            <div class="availability-header">
                <button class="close-btn" onclick="hideAvailabilityPage()" title="إغلاق">
                    <i data-lucide="x"></i>
                </button>
                <h2 class="availability-title">الفترات المتاحة لفتح شعبة جديدة</h2>

                <!-- أزرار الإجراءات -->
                <div class="availability-actions">
                    <button class="reset-periods-btn" onclick="resetSelectedPeriods()" title="إعادة تعيين الاختيارات">
                        <i data-lucide="refresh-cw"></i>
                        <span>إعادة تعيين</span>
                    </button>
                    <button class="apply-periods-btn" onclick="applySelectedPeriodsToTables()" disabled
                        title="اعتماد الفترات المختارة">
                        <i data-lucide="check-circle"></i>
                        <span>اعتماد إظهار الفترات</span>
                    </button>
                </div>
            </div>

            <!-- الجدول -->
            <div class="availability-table-wrapper">
                <table class="availability-table" id="availabilityTable">
                    <thead id="availabilityTableHead">
                        <!-- يُملأ ديناميكياً -->
                    </thead>
                    <tbody id="availabilityTableBody">
                        <!-- يُملأ ديناميكياً -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- شاشة التحميل -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- الإشعارات -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ═══════════════════════════════════════════════════════════════
         JavaScript - التفاعلات الأساسية
         ═══════════════════════════════════════════════════════════════ -->
    <script>
        // المتغيرات
        let uploadedFiles = { ss01: null, sf01: null };
        let currentZone = null;
        let showFreeOnly = false; // إظهار المتدربين المتاحين فقط

        // فلاتر الأعمدة
        let columnFilters = {
            trainer: { name: [], dept: [] },
            trainee: { name: [], major: [] }
        };

        // العناصر
        const uploadPage = document.getElementById('uploadPage');
        const mainPage = document.getElementById('mainPage');
        const startBtn = document.getElementById('startBtn');
        const fileInput = document.getElementById('fileInput');
        const ss01Zone = document.getElementById('ss01Zone');
        const sf01Zone = document.getElementById('sf01Zone');
        // Removed old toggle reference

        // تبديل عرض المتاحين فقط
        function toggleFreeOnly() {
            // تبديل الحالة
            showFreeOnly = !showFreeOnly;
            updateFreeOnlyUI();

            // إعادة عرض الجدول
            renderTraineesTable();

            // إشعار المستخدم
            if (showFreeOnly) {
                showToast('عرض المتدربين المتاحين فقط', 'success');
            } else {
                showToast('عرض جميع المتدربين', 'info');
            }
            console.log('showFreeOnly changed to:', showFreeOnly);
        }

        function updateFreeOnlyUI() {
            const toggle = document.getElementById('freeOnlySwitch');
            if (toggle) {
                if (showFreeOnly) {
                    toggle.classList.add('active');
                } else {
                    toggle.classList.remove('active');
                }
            }
        }

        // ═══════════════════════════════════════════════════════════════
        //  دمج المتطابقين - تجميع المتدربين بنفس الشعب
        // ═══════════════════════════════════════════════════════════════
        let mergeIdentical = false;

        // تبديل وضع دمج المتطابقين
        function toggleMergeIdentical() {
            mergeIdentical = !mergeIdentical;
            updateMergeIdenticalUI();

            renderTraineesTable();

            if (mergeIdentical) {
                showToast('تم دمج المتدربين المتطابقين', 'success');
            } else {
                showToast('عرض كل متدرب في صف منفصل', 'info');
            }
        }

        function updateMergeIdenticalUI() {
            const toggle = document.getElementById('mergeIdenticalToggle');
            if (toggle) {
                if (mergeIdentical) {
                    toggle.classList.add('active');
                } else {
                    toggle.classList.remove('active');
                }
            }
        }

        // الحصول على مفتاح التجميع للمتدرب (الأرقام المرجعية مرتبة)
        function getTraineeGroupKey(trainee) {
            if (!trainee.registrations || trainee.registrations.length === 0) {
                return '';
            }
            // ترتيب الأرقام المرجعية وتحويلها لمفتاح نصي
            return [...trainee.registrations].map(r => r.refNum).sort().join(',');
        }

        // تجميع المتدربين المتطابقين
        function groupIdenticalTrainees(traineesArray) {
            const groups = {};

            traineesArray.forEach(trainee => {
                const key = getTraineeGroupKey(trainee);
                if (!groups[key]) {
                    groups[key] = {
                        key: key,
                        trainees: [],
                        registrations: trainee.registrations || [],
                        // سنستخدم جدول أول متدرب كممثل للمجموعة
                        representativeId: trainee.id
                    };
                }
                groups[key].trainees.push(trainee);
            });

            // تحويل لمصفوفة وترتيب حسب عدد المتدربين (الأكبر أولاً)
            return Object.values(groups).sort((a, b) => b.trainees.length - a.trainees.length);
        }

        // ═══════════════════════════════════════════════════════════════
        //  تحليل فراغات شعبة جديدة
        // ═══════════════════════════════════════════════════════════════
        // ملاحظة: يستخدم المتغير DAYS المعرف في قسم معالجة البيانات
        const PERIOD_DURATION = 50; // مدة الفترة بالدقائق
        const PERIOD_GAP = 1; // الفاصل بين الفترتين المتتاليتين

        // عرض صفحة التحليل
        function showAvailabilityPage() {
            if (visibleSections.length === 0) {
                showToast('يرجى اختيار شعبة واحدة على الأقل', 'error');
                return;
            }

            // لا نعيد تعيين الاختيارات - تبقى محفوظة حتى يضغط المستخدم على إعادة تعيين

            const page = document.getElementById('availabilityPage');
            if (page) {
                page.classList.add('show');
                generateAvailabilityTable();
                updateApplyButtonState();
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        }

        // إغلاق صفحة التحليل
        function hideAvailabilityPage() {
            const page = document.getElementById('availabilityPage');
            if (page) {
                page.classList.remove('show');
            }
        }

        // استخراج جميع أوقات البداية الفريدة من البيانات
        function extractUniqueStartTimes() {
            const startTimes = new Set();

            Object.values(sections).forEach(section => {
                // كل قسم لديه مصفوفة sessions
                if (section.sessions && section.sessions.length > 0) {
                    section.sessions.forEach(session => {
                        if (session.time && session.time !== ' - ') {
                            const [endStr, startStr] = session.time.split(' - ');
                            if (startStr && startStr.trim()) {
                                // استخدام parseTimeString للتعامل مع جميع تنسيقات الوقت
                                const mins = parseTimeString(startStr.trim());
                                if (mins > 0) startTimes.add(mins);
                            }
                        }
                    });
                }
            });

            console.log('⏰ أوقات البداية المستخرجة:', Array.from(startTimes).sort((a, b) => a - b).map(m => `${Math.floor(m / 60)}:${(m % 60).toString().padStart(2, '0')}`));
            return Array.from(startTimes).sort((a, b) => a - b);
        }

        // حساب تكرار كل وقت بداية
        function countStartTimeFrequency() {
            const frequency = {};

            Object.values(sections).forEach(section => {
                if (section.sessions && section.sessions.length > 0) {
                    section.sessions.forEach(session => {
                        if (session.time && session.time !== ' - ') {
                            const [endStr, startStr] = session.time.split(' - ');
                            if (startStr && startStr.trim()) {
                                // استخدام parseTimeString للتعامل مع جميع تنسيقات الوقت
                                const mins = parseTimeString(startStr.trim());
                                if (mins > 0) frequency[mins] = (frequency[mins] || 0) + 1;
                            }
                        }
                    });
                }
            });

            return frequency;
        }

        // إنشاء 10 فترات بناءً على الأوقات الفعلية
        function generateTimePeriods() {
            const periods = [];
            const startTimes = extractUniqueStartTimes();
            const frequency = countStartTimeFrequency();

            if (startTimes.length === 0) {
                console.log('لا توجد أوقات متاحة');
                return periods;
            }

            let currentEnd = 0;
            let periodCount = 0;

            while (periodCount < 10 && startTimes.length > 0) {
                let periodStart;

                if (periodCount % 2 === 0) {
                    // الفترات الفردية (1, 3, 5, 7, 9): نبحث عن أول وقت بداية ≥ currentEnd
                    const availableStarts = startTimes.filter(t => t >= currentEnd);
                    if (availableStarts.length === 0) {
                        // لا توجد أوقات متاحة، نستخدم currentEnd + فاصل
                        periodStart = currentEnd + 5;
                    } else {
                        // نختار الأكثر تكراراً من بين الأوقات المتاحة
                        periodStart = availableStarts.reduce((best, curr) =>
                            (frequency[curr] || 0) > (frequency[best] || 0) ? curr : best
                            , availableStarts[0]);
                    }
                } else {
                    // الفترات الزوجية (2, 4, 6, 8, 10): تبدأ بعد السابقة بدقيقة
                    periodStart = currentEnd + PERIOD_GAP;
                }

                const periodEnd = periodStart + PERIOD_DURATION;

                periods.push({
                    index: periodCount + 1,
                    start: periodStart,
                    end: periodEnd,
                    startStr: formatMinutesToTime(periodStart),
                    endStr: formatMinutesToTime(periodEnd),
                    groupClass: `period-group-${Math.ceil((periodCount + 1) / 2)}`
                });

                currentEnd = periodEnd;
                periodCount++;
            }

            return periods;
        }

        // تحويل الدقائق لتنسيق وقت (HH:MM)
        function formatMinutesToTime(mins) {
            const hours = Math.floor(mins / 60);
            const minutes = mins % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        // التحقق من تعارض وقت معين مع فترة محددة
        function isTimeConflict(sessionTime, periodStart, periodEnd) {
            if (!sessionTime || sessionTime === ' - ') return false;

            const [endStr, startStr] = sessionTime.split(' - ');
            if (!startStr || !endStr) return false;

            // استخدام parseTimeString للتعامل مع جميع تنسيقات الوقت
            const sessionStart = parseTimeString(startStr.trim());
            const sessionEnd = parseTimeString(endStr.trim());

            if (sessionStart === 0 && sessionEnd === 0) return false;

            // تعارض إذا كان هناك تداخل
            return !(sessionEnd <= periodStart || sessionStart >= periodEnd);
        }

        // حساب المتدربين المتاحين لفترة معينة في يوم معين
        // pool: قائمة IDs المتدربين للتصفية منها (null = الكل)
        function calculateTraineeAvailability(period, day, pool = null) {
            let available = 0;
            let total = 0;
            let availableIds = []; // قائمة IDs المتاحين

            // المتدربين من الشعب الظاهرة فقط
            let visibleTrainees = Object.values(trainees).filter(trainee => {
                if (!trainee.registrations) return false;
                return trainee.registrations.some(reg => visibleSections.includes(reg.refNum));
            });

            // إذا تم تمرير pool، التصفية منها فقط
            if (pool !== null) {
                visibleTrainees = visibleTrainees.filter(t => pool.includes(t.id));
            }

            visibleTrainees.forEach(trainee => {
                total++;
                let hasConflict = false;

                // فحص كل تسجيلات المتدرب
                if (trainee.registrations) {
                    for (const reg of trainee.registrations) {
                        const section = sections[reg.refNum];
                        if (section && section.sessions) {
                            // فحص كل جلسات الشعبة
                            for (const session of section.sessions) {
                                if (session.day === day) {
                                    if (isTimeConflict(session.time, period.start, period.end)) {
                                        hasConflict = true;
                                        break;
                                    }
                                }
                            }
                        }
                        if (hasConflict) break;
                    }
                }

                if (!hasConflict) {
                    available++;
                    availableIds.push(trainee.id);
                }
            });

            return { available, total, availableIds };
        }

        // حساب المدربين المتاحين لفترة معينة في يوم معين
        // pool: قائمة IDs المدربين للتصفية منها (null = الكل)
        function calculateTrainerAvailability(period, day, pool = null) {
            let available = 0;
            let total = 0;
            let availableIds = []; // قائمة IDs المتاحين

            // المدربين من الشعب الظاهرة
            let visibleTrainerIds = new Set();
            Object.values(sections).forEach(section => {
                if (visibleSections.includes(section.refNumber) && section.trainerId) {
                    visibleTrainerIds.add(section.trainerId);
                }
            });

            // إذا تم تمرير pool، التصفية منها فقط
            if (pool !== null) {
                visibleTrainerIds = new Set([...visibleTrainerIds].filter(id => pool.includes(id)));
            }

            visibleTrainerIds.forEach(trainerId => {
                total++;
                let hasConflict = false;

                // فحص كل الشعب التي يدرسها المدرب (من كائن sections)
                Object.values(sections).forEach(section => {
                    if (section.trainerId === trainerId && section.sessions) {
                        for (const session of section.sessions) {
                            if (session.day === day) {
                                if (isTimeConflict(session.time, period.start, period.end)) {
                                    hasConflict = true;
                                    return;
                                }
                            }
                        }
                    }
                });

                if (!hasConflict) {
                    available++;
                    availableIds.push(trainerId);
                }
            });

            return { available, total, availableIds };
        }

        // ═══════════════════════════════════════════════════════════════
        //  اختيار الفترات الديناميكي - Dynamic Period Selection
        // ═══════════════════════════════════════════════════════════════
        let selectedAvailabilityPeriods = []; // [{period: {...}, day: 'الأحد'}, ...]
        let filteredTraineePool = null; // null = الكل، [] = قائمة IDs
        let filteredTrainerPool = null;
        let cachedPeriods = []; // الفترات المخزنة مؤقتاً

        // تبديل اختيار فترة معينة
        function toggleAvailabilityPeriod(periodIndex, day) {
            const period = cachedPeriods.find(p => p.index === periodIndex);
            if (!period) return;

            // البحث عن الفترة في المختارة
            const existingIndex = selectedAvailabilityPeriods.findIndex(
                sp => sp.period.index === periodIndex && sp.day === day
            );

            if (existingIndex > -1) {
                // إزالة الاختيار
                selectedAvailabilityPeriods.splice(existingIndex, 1);
            } else {
                // التحقق من أن الخلية ليست حمراء
                const traineeData = calculateTraineeAvailability(period, day, filteredTraineePool);
                if (traineeData.available === 0) {
                    showToast('لا يمكن اختيار فترة بدون متدربين متاحين', 'error');
                    return;
                }
                // إضافة الاختيار
                selectedAvailabilityPeriods.push({ period, day });
            }

            // إعادة حساب الـ pools
            recalculateFilteredPools();

            // إعادة عرض الجدول
            generateAvailabilityTable();

            // تحديث حالة زر الاعتماد
            updateApplyButtonState();
        }

        // إعادة حساب قوائم المتاحين بناءً على الفترات المختارة
        function recalculateFilteredPools() {
            if (selectedAvailabilityPeriods.length === 0) {
                filteredTraineePool = null;
                filteredTrainerPool = null;
                return;
            }

            // البدء من الكل
            let currentTraineePool = null;
            let currentTrainerPool = null;

            // لكل فترة مختارة، تصفية المتاحين
            selectedAvailabilityPeriods.forEach((sp, index) => {
                const traineeData = calculateTraineeAvailability(sp.period, sp.day, currentTraineePool);
                const trainerData = calculateTrainerAvailability(sp.period, sp.day, currentTrainerPool);

                currentTraineePool = traineeData.availableIds;
                currentTrainerPool = trainerData.availableIds;
            });

            filteredTraineePool = currentTraineePool;
            filteredTrainerPool = currentTrainerPool;
        }

        // إعادة تعيين الاختيارات
        function resetSelectedPeriods() {
            selectedAvailabilityPeriods = [];
            filteredTraineePool = null;
            filteredTrainerPool = null;

            // مسح الفترات المعتمدة من الجداول الرئيسية
            appliedFreetimePeriods = [];

            generateAvailabilityTable();
            updateApplyButtonState();

            // إخفاء زر إعادة التعيين السريع
            updateFreetimeResetButton();

            // إعادة عرض الجداول لإزالة صناديق الفترات
            renderAllData();

            showToast('تم إعادة تعيين الاختيارات', 'info');
        }

        // تحديث حالة زر الاعتماد
        function updateApplyButtonState() {
            const btn = document.querySelector('.apply-periods-btn');
            if (btn) {
                if (selectedAvailabilityPeriods.length > 0) {
                    btn.classList.add('active');
                    btn.disabled = false;
                } else {
                    btn.classList.remove('active');
                    btn.disabled = true;
                }
            }
        }

        // تحديث ظهور زر إعادة التعيين السريع
        function updateFreetimeResetButton() {
            const btn = document.getElementById('freetimeResetBtn');
            if (btn) {
                if (appliedFreetimePeriods.length > 0) {
                    btn.style.display = 'flex';
                } else {
                    btn.style.display = 'none';
                }
                // إعادة تهيئة الأيقونات
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        }

        // اعتماد الفترات المختارة للعرض في الجداول الرئيسية
        function applySelectedPeriodsToTables() {
            if (selectedAvailabilityPeriods.length === 0) {
                showToast('لم يتم اختيار أي فترات', 'error');
                return;
            }

            // تخزين الفترات المعتمدة للعرض
            appliedFreetimePeriods = [...selectedAvailabilityPeriods];

            showToast(`تم اعتماد ${selectedAvailabilityPeriods.length} فترات`, 'success');

            // إغلاق صفحة التحليل
            hideAvailabilityPage();

            // إظهار زر إعادة التعيين السريع
            updateFreetimeResetButton();

            // إعادة عرض الجداول لإظهار الفترات
            renderAllData();
        }

        // الفترات المعتمدة للعرض على الجداول الرئيسية
        let appliedFreetimePeriods = []; // [{period: {...}, day: 'الأحد'}, ...]


        // إنشاء جدول التحليل
        function generateAvailabilityTable() {
            const thead = document.getElementById('availabilityTableHead');
            const tbody = document.getElementById('availabilityTableBody');
            if (!tbody || !thead) return;

            const periods = generateTimePeriods();
            cachedPeriods = periods; // تخزين مؤقت للاستخدام في toggleAvailabilityPeriod

            // إنشاء رأس الجدول (الفترات كأعمدة)
            let headerHtml = '<tr><th class="day-header">اليوم</th><th class="labels-header">البيان</th>';
            periods.forEach(period => {
                const groupNum = Math.ceil(period.index / 2);
                headerHtml += `<th class="period-header period-group-${groupNum}">
                    الفترة ${period.index}
                    <span class="period-time">${period.startStr} - ${period.endStr}</span>
                </th>`;
            });
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;

            // إنشاء صفوف الجدول (الأيام كصفوف)
            let bodyHtml = '';
            DAYS.forEach((day, dayIndex) => {
                // صف اليوم
                bodyHtml += `<tr class="day-row ${dayIndex > 0 ? 'day-separator' : ''}">`;

                // خلية اليوم (تمتد على 3 صفوف فرعية)
                bodyHtml += `<td class="day-cell">${day}</td>`;

                // خلية التسميات (3 صفوف) - بنفس تنسيق خلايا الفترات
                bodyHtml += `<td class="labels-cell">
                    <div class="labels-cell-content">
                        <div class="label-row label-trainers">المدربين المتاحين</div>
                        <div class="label-row label-trainees">المتدربين المتاحين</div>
                        <div class="label-row label-percentage">نسبة المتدربين</div>
                    </div>
                </td>`;

                // خلايا الفترات
                periods.forEach(period => {
                    // استخدام الـ pool للحساب الديناميكي
                    const traineeData = calculateTraineeAvailability(period, day, filteredTraineePool);
                    const trainerData = calculateTrainerAvailability(period, day, filteredTrainerPool);
                    const percentage = traineeData.total > 0
                        ? Math.round((traineeData.available / traineeData.total) * 100)
                        : 0;

                    // تحديد إذا كانت الخلية بدون متدربين متاحين
                    const noAvailabilityClass = traineeData.available === 0 ? 'no-availability' : '';

                    // تحديد إذا كان عدد المدربين المتاحين = 0
                    const noTrainersClass = trainerData.available === 0 ? 'no-trainers' : '';

                    // تحديد إذا كانت الخلية مختارة
                    const isSelected = selectedAvailabilityPeriods.some(
                        sp => sp.period.index === period.index && sp.day === day
                    );
                    const selectedClass = isSelected ? 'selected' : '';

                    // كلاس قابل للنقر (إذا كان هناك متدربين متاحين أو الخلية مختارة)
                    const clickableClass = (traineeData.available > 0 || isSelected) ? 'clickable' : '';

                    const groupNum = Math.ceil(period.index / 2);

                    bodyHtml += `<td class="period-group-${groupNum}">
                        <div class="availability-cell ${noAvailabilityClass} ${selectedClass} ${clickableClass}" 
                             onclick="toggleAvailabilityPeriod(${period.index}, '${day}')">
                            <div class="cell-trainers ${noTrainersClass}">${trainerData.available}/${trainerData.total}</div>
                            <div class="cell-trainees">${traineeData.available}/${traineeData.total}</div>
                            <div class="cell-percentage">${percentage}%</div>
                        </div>
                    </td>`;
                });

                bodyHtml += '</tr>';
            });

            tbody.innerHTML = bodyHtml;
        }

        // ═══════════════════════════════════════════════════════════════
        //  تحديد الفراغات المشتركة
        // ═══════════════════════════════════════════════════════════════
        let showFreeSlots = false;
        const END_OF_DAY = 16 * 60; // 16:00 = 960 دقيقة (4 مساءً)
        const MIN_FREE_SLOT = 50; // الحد الأدنى للفراغ بالدقائق

        // تبديل وضع تحديد الفراغات
        function toggleFreeSlots() {
            showFreeSlots = !showFreeSlots;
            updateFreeSlotsUI();

            // إعادة عرض الجداول
            renderAllData();

            if (showFreeSlots) {
                showToast('تحديد الفراغات المشتركة', 'success');
            } else {
                showToast('إخفاء الفراغات', 'info');
            }
        }

        function updateFreeSlotsUI() {
            const toggle = document.getElementById('freeSlotsToggle');
            if (toggle) {
                if (showFreeSlots) {
                    toggle.classList.add('active');
                } else {
                    toggle.classList.remove('active');
                }
            }
        }

        // حساب الفراغات المشتركة لجميع المتدربين والمدربين (من الشعب الظاهرة)
        function calculateSharedFreeSlots() {
            if (visibleSections.length === 0) return {};

            // تجميع جميع المحاضرات لكل يوم
            const allBusySlots = {};
            DAYS.forEach(day => allBusySlots[day] = []);

            // جمع محاضرات المتدربين من الشعب الظاهرة
            Object.values(trainees).forEach(trainee => {
                // تحقق من أن المتدرب مسجل في إحدى الشعب الظاهرة
                const hasVisibleSection = trainee.registrations.some(r => visibleSections.includes(r.refNum));
                if (!hasVisibleSection) return;

                const schedule = getTraineeSchedule(trainee.id);
                DAYS.forEach(day => {
                    const daySchedule = schedule.schedule[day] || {};
                    Object.keys(daySchedule).forEach(time => {
                        const [endStr, startStr] = time.split(' - ');
                        const start = parseTimeString(startStr);
                        const end = parseTimeString(endStr);
                        allBusySlots[day].push({ start, end });
                    });
                });
            });

            // جمع محاضرات المدربين من الشعب الظاهرة
            Object.values(trainers).forEach(trainer => {
                // تحقق من أن المدرب يدرّس إحدى الشعب الظاهرة
                const hasVisibleSection = trainer.sections.some(ref => visibleSections.includes(ref));
                if (!hasVisibleSection) return;

                const schedule = getTrainerSchedule(trainer.id);
                DAYS.forEach(day => {
                    const daySchedule = schedule.schedule[day] || {};
                    Object.keys(daySchedule).forEach(time => {
                        const [endStr, startStr] = time.split(' - ');
                        const start = parseTimeString(startStr);
                        const end = parseTimeString(endStr);
                        allBusySlots[day].push({ start, end });
                    });
                });
            });

            // حساب الفراغات لكل يوم
            const freeSlots = {};
            DAYS.forEach(day => {
                freeSlots[day] = findFreeSlots(allBusySlots[day]);
            });

            return freeSlots;
        }

        // إيجاد الفراغات من قائمة الفترات المشغولة
        function findFreeSlots(busySlots) {
            if (busySlots.length === 0) {
                // إذا لا توجد محاضرات، لا توجد فراغات لحسابها
                return [];
            }

            // ترتيب الفترات المشغولة
            const sorted = [...busySlots].sort((a, b) => a.start - b.start);

            // دمج الفترات المتداخلة
            const merged = [];
            let current = { ...sorted[0] };

            for (let i = 1; i < sorted.length; i++) {
                if (sorted[i].start <= current.end) {
                    // تداخل - توسيع الفترة الحالية
                    current.end = Math.max(current.end, sorted[i].end);
                } else {
                    merged.push(current);
                    current = { ...sorted[i] };
                }
            }
            merged.push(current);

            // البحث عن الفراغات
            const freeSlots = [];

            // بداية اليوم = وقت أول محاضرة (ديناميكي)
            // لا نحسب فراغ قبل أول محاضرة - البداية من أول محاضرة

            // فراغات بين المحاضرات فقط
            for (let i = 0; i < merged.length - 1; i++) {
                const gap = merged[i + 1].start - merged[i].end;
                if (gap >= MIN_FREE_SLOT) {
                    freeSlots.push({ start: merged[i].end, end: merged[i + 1].start });
                }
            }

            // فراغ بعد آخر محاضرة حتى نهاية اليوم (16:00)
            const lastEnd = merged[merged.length - 1].end;
            if (END_OF_DAY > lastEnd) {
                const gap = END_OF_DAY - lastEnd;
                if (gap >= MIN_FREE_SLOT) {
                    freeSlots.push({ start: lastEnd, end: END_OF_DAY });
                }
            }

            return freeSlots;
        }

        // تنسيق الدقائق إلى وقت مقروء (مثل 7:30)
        function minutesToTimeString(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}:${mins.toString().padStart(2, '0')}`;
        }
        // تهيئة صفحة الرفع
        function initUploadPage() {
            [ss01Zone, sf01Zone].forEach(zone => {
                zone.addEventListener('click', () => {
                    currentZone = zone.dataset.file;
                    fileInput.click();
                });

                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('dragover');
                });

                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('dragover');
                });

                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('dragover');
                    currentZone = zone.dataset.file;
                    handleFile(e.dataTransfer.files[0]);
                });
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    handleFile(e.target.files[0]);
                }
            });

            // تحميل الملفات المحفوظة من IndexedDB
            loadCachedFiles();
        }

        // ═══════════════════════════════════════════════════════════════
        //  IndexedDB للحفظ الدائم (أفضل من localStorage للملفات الكبيرة)
        // ═══════════════════════════════════════════════════════════════
        const DB_NAME = 'TraineeSlotsDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'files';
        let db = null;

        // فتح قاعدة البيانات
        function openDatabase() {
            return new Promise((resolve, reject) => {
                if (db) {
                    resolve(db);
                    return;
                }

                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        database.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
            });
        }

        // حفظ الملف في IndexedDB
        async function saveFileToCache(fileType, content) {
            try {
                const database = await openDatabase();
                const transaction = database.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);

                store.put({
                    id: fileType,
                    content: content,
                    timestamp: new Date().toISOString()
                });

                console.log(`💾 تم حفظ ${fileType} في IndexedDB`);
            } catch (e) {
                console.warn('خطأ في حفظ IndexedDB:', e);
            }
        }

        // حذف الملف من IndexedDB وإعادة تعيين الواجهة
        async function deleteUploadedFile(fileType) {
            try {
                // حذف من IndexedDB
                const database = await openDatabase();
                const transaction = database.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                store.delete(fileType);

                // حذف من الذاكرة
                uploadedFiles[fileType] = null;

                // إعادة تعيين واجهة المستخدم
                const zone = document.getElementById(fileType + 'Zone');
                if (zone) {
                    zone.classList.remove('uploaded');
                    zone.querySelector('.upload-zone-title').textContent =
                        fileType === 'ss01' ? 'ملف SS01' : 'ملف SF01';

                    // إخفاء معلومات التحقق
                    const validationInfo = document.getElementById(fileType + 'ValidationInfo');
                    if (validationInfo) {
                        validationInfo.style.display = 'none';
                        validationInfo.innerHTML = '';
                    }
                }

                // تحديث حالة زر ابدأ
                checkFilesReady();

                console.log(`🗑️ تم حذف ${fileType} من IndexedDB`);
                showToast(`تم حذف ملف ${fileType.toUpperCase()}`, 'success');
            } catch (e) {
                console.error('خطأ في حذف الملف:', e);
                showToast('حدث خطأ في حذف الملف', 'error');
            }
        }

        // متغير حالة التحقق من ملف SF01
        let isSF01Valid = false;

        // التحقق من صحة ملف SF01
        function validateSF01(csvText) {
            const rows = parseCSV(csvText);
            const departments = new Set();
            const uniqueTrainees = new Set();

            rows.forEach(row => {
                if (row['القسم']) {
                    departments.add(row['القسم'].trim());
                }
                // رقم المتدرب الفريد
                const traineeId = row['رقم المتدرب'] || row['TRAINEE_ID'] || '';
                if (traineeId.trim()) {
                    uniqueTrainees.add(traineeId.trim());
                }
            });

            const deptList = Array.from(departments);
            const traineeCount = uniqueTrainees.size; // عدد المتدربين الفريدين
            const hasGeneralStudies = deptList.includes('الدراسات العامة');
            isSF01Valid = hasGeneralStudies;

            const infoBox = document.getElementById('sf01ValidationInfo');
            if (infoBox) {
                infoBox.style.display = 'block';
                const items = deptList.map(d => {
                    const isGeneral = d === 'الدراسات العامة';
                    const bgColor = isGeneral ? 'rgba(16, 185, 129, 0.2)' : 'rgba(99, 102, 241, 0.15)';
                    const textColor = isGeneral ? '#10b981' : '#a5b4fc';
                    const border = isGeneral ? '1px solid #10b981' : '1px solid rgba(99, 102, 241, 0.3)';
                    return `<span style="display: inline-block; background: ${bgColor}; color: ${textColor}; border: ${border}; padding: 3px 10px; border-radius: 12px; margin: 2px; font-size: 0.8em; white-space: nowrap;">${d}</span>`;
                }).join('');

                const warning = !hasGeneralStudies ?
                    `<div style="color: #ef4444; margin-top: 10px; font-weight: bold; text-align: center;">
                        ⚠️ خطأ: قسم "الدراسات العامة" مفقود!
                    </div>` : '';

                infoBox.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 8px; font-size: 0.9em;">👥 عدد المتدربين: ${traineeCount}</div>
                    <div style="font-weight: bold; margin-bottom: 8px; font-size: 0.9em;">✅ الأقسام (${deptList.length}):</div>
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 4px;">
                        ${items}
                    </div>
                    ${warning}
                `;
            }

            if (!hasGeneralStudies) {
                showToast('تنبيه: ملف SF01 لا يحتوي على "الدراسات العامة"', 'error');
            }
        }

        // التحقق من ملف SS01 وعرض معلومات الأقسام
        function validateSS01(content) {
            const data = parseCSV(content);
            const departments = new Set();
            const uniqueSections = new Set();

            // استخراج الأقسام والشعب الفريدة
            data.forEach(row => {
                const dept = row['القسم'] || row['DEPT'] || row['Department'] || '';
                if (dept.trim()) {
                    departments.add(dept.trim());
                }
                // الرقم المرجعي للشعبة
                const refNum = row['الرقم المرجعي'] || row['REF_NUM'] || '';
                if (refNum.trim()) {
                    uniqueSections.add(refNum.trim());
                }
            });

            const deptList = Array.from(departments).sort();
            const sectionCount = uniqueSections.size; // عدد الشعب الفريدة

            const infoBox = document.getElementById('ss01ValidationInfo');
            if (infoBox) {
                infoBox.style.display = 'block';
                const items = deptList.map(d => {
                    const bgColor = 'rgba(99, 102, 241, 0.15)';
                    const textColor = '#a5b4fc';
                    const border = '1px solid rgba(99, 102, 241, 0.3)';
                    return `<span style="display: inline-block; background: ${bgColor}; color: ${textColor}; border: ${border}; padding: 3px 10px; border-radius: 12px; margin: 2px; font-size: 0.8em; white-space: nowrap;">${d}</span>`;
                }).join('');

                infoBox.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 8px; font-size: 0.9em;">📊 عدد الشعب: ${sectionCount}</div>
                    <div style="font-weight: bold; margin-bottom: 8px; font-size: 0.9em;">✅ الأقسام (${deptList.length}):</div>
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 4px;">
                        ${items}
                    </div>
                `;
            }
        }

        // تحميل الملفات المحفوظة من IndexedDB
        async function loadCachedFiles() {
            try {
                const database = await openDatabase();
                const transaction = database.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);

                const ss01Request = store.get('ss01');
                const sf01Request = store.get('sf01');

                ss01Request.onsuccess = () => {
                    if (ss01Request.result) {
                        uploadedFiles.ss01 = { cached: true, content: ss01Request.result.content };
                        const ss01Zone = document.getElementById('ss01Zone');
                        if (ss01Zone) {
                            ss01Zone.classList.add('uploaded');
                            ss01Zone.querySelector('.upload-zone-title').textContent = 'SS01 ✓ (محفوظ)';
                        }
                        console.log('📂 تم تحميل SS01 من IndexedDB');
                        // التحقق من الملف المحفوظ أيضاً
                        validateSS01(ss01Request.result.content);
                        checkFilesReady();
                    }
                };

                sf01Request.onsuccess = () => {
                    if (sf01Request.result) {
                        uploadedFiles.sf01 = { cached: true, content: sf01Request.result.content };
                        const sf01Zone = document.getElementById('sf01Zone');
                        if (sf01Zone) {
                            sf01Zone.classList.add('uploaded');
                            sf01Zone.querySelector('.upload-zone-title').textContent = 'SF01 ✓ (محفوظ)';
                        }
                        console.log('📂 تم تحميل SF01 من IndexedDB');
                        // التحقق من الملف المحفوظ أيضاً
                        validateSF01(sf01Request.result.content);
                        checkFilesReady();
                    }
                };
            } catch (e) {
                console.warn('خطأ في تحميل IndexedDB:', e);
            }
        }

        // معالجة الملف
        function handleFile(file) {
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showToast('يرجى اختيار ملف CSV فقط', 'error');
                return;
            }

            // التأكد من المنطقة الحالية
            if (!currentZone) {
                // افتراضياً نستخدم ss01 إذا لم يتم التحديد (حالة نادرة)
                if (!uploadedFiles.ss01) currentZone = 'ss01';
                else currentZone = 'sf01';
            }

            const zone = document.getElementById(currentZone + 'Zone');
            if (!zone) return;

            // محاكاة الرفع
            const progressBar = zone.querySelector('.upload-progress-bar');
            const progress = zone.querySelector('.upload-progress');
            progress.style.display = 'block';

            // قراءة محتوى الملف
            const reader = new FileReader();
            reader.onload = function (e) {
                const fileContent = e.target.result;

                // التحقق الفوري لملف SF01
                if (currentZone === 'sf01') {
                    validateSF01(fileContent);
                }

                // التحقق الفوري لملف SS01
                if (currentZone === 'ss01') {
                    validateSS01(fileContent);
                }

                // حفظ في localStorage
                saveFileToCache(currentZone, fileContent);

                // حفظ الملف مع المحتوى
                uploadedFiles[currentZone] = { file, content: fileContent };

                zone.classList.add('uploaded');
                progress.style.display = 'none';
                progressBar.style.width = '100%';

                checkFilesReady();
                showToast(`تم رفع ${currentZone.toUpperCase()} بنجاح وحفظه`, 'success');
            };

            reader.onerror = function () {
                progress.style.display = 'none';
                showToast('فشل في قراءة الملف', 'error');
            };

            // Start reading with progress simulation
            let width = 0;
            const interval = setInterval(() => {
                width += 20;
                progressBar.style.width = width + '%';
                if (width >= 100) {
                    clearInterval(interval);
                }
            }, 30);

            reader.readAsText(file);
        }

        // التحقق من جاهزية الملفات
        function checkFilesReady() {
            // نتحقق من وجود الملفات فقط، صحة المحتوى يتم التحقق منها عند البدء
            if (uploadedFiles.ss01 && uploadedFiles.sf01) {
                startBtn.classList.add('active');
            } else {
                startBtn.classList.remove('active');
            }
        }

        // بدء التحليل
        async function startAnalysis() {
            // التحقق التفصيلي مع رسائل خطأ
            if (!uploadedFiles.ss01) {
                showToast('يجب رفع ملف SS01 (جدول الوحدة الأسبوعي)', 'error');
                return;
            }
            if (!uploadedFiles.sf01) {
                showToast('يجب رفع ملف SF01 (قائمة تسجيل المتدربين)', 'error');
                return;
            }

            // التحقق من صحة ملف SF01 (وجود الدراسات العامة)
            if (!isSF01Valid) {
                showToast('❌ عذراً، لا يمكن البدء.', 'error');
                setTimeout(() => {
                    showToast('يجب أن يحتوي ملف SF01 على قسم "الدراسات العامة". راجع نتائج التحقق.', 'error');
                }, 1500);
                return;
            }

            // معالجة الملفات
            const success = await processUploadedFiles();

            if (success) {
                // إخفاء صفحة الرفع وإظهار الرئيسية
                const uploadPageEl = document.getElementById('uploadPage');
                const mainPageEl = document.getElementById('mainPage');

                if (uploadPageEl && mainPageEl) {
                    uploadPageEl.style.display = 'none';
                    mainPageEl.style.display = 'flex';
                    mainPageEl.scrollIntoView();

                    // تشغيل الجولة التفاعلية عند أول استخدام
                    alert('✅ وصلت لهذه النقطة - سيبدأ التور الآن!');
                    const tourCompleted = localStorage.getItem('tourCompleted');
                    console.log('🎯 Tour check:', tourCompleted ? 'مكتمل' : 'لم يتم');
                    if (!tourCompleted) {
                        setTimeout(() => {
                            console.log('🚀 بدء الجولة التفاعلية...');
                            startTour();
                        }, 500);
                    }
                } else {
                    console.error('Elements missing:', { uploadPageEl, mainPageEl });
                    showToast('حدث خطأ في عرض الصفحة الرئيسية', 'error');
                }
            }
        }



        // إزالة الـ chips
        document.querySelectorAll('.chip-remove').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.target.closest('.chip').remove();
            });
        });

        // عرض/إخفاء التحميل
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // عرض الإشعارات
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';

            const icons = {
                success: 'check-circle',
                error: 'x-circle',
                info: 'info'
            };

            toast.innerHTML = `
                <span class="toast-icon"><i data-lucide="${icons[type]}"></i></span>
                <span class="toast-message">${message}</span>
            `;

            container.appendChild(toast);

            // تهيئة أيقونة Lucide داخل هذا الإشعار
            if (window.lucide) {
                lucide.createIcons({
                    root: toast,
                    nameAttr: 'data-lucide'
                });
            }

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ═══════════════════════════════════════════════════════════════
        //  معالجة البيانات - Data Processing
        // ═══════════════════════════════════════════════════════════════

        // الثوابت
        const DAYS = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس'];

        // هياكل البيانات الرئيسية
        let sections = {};      // الشعب (من SS01)
        let trainees = {};      // المتدربين (من SF01)
        let trainers = {};      // المدربين (مستخرج من SS01)
        let allTimeSlots = new Set(); // جميع الأوقات الفريدة
        let sortedTimeSlots = []; // الأوقات المرتبة (تُملأ بعد التحليل)

        // بيانات الفلاتر (تُستخرج ديناميكياً)
        let departments = new Set();      // الأقسام
        let coursePrefixes = new Set();   // رموز المقررات (حروف فقط)
        let scheduleTypes = new Set();    // أنواع الشعب
        let courses = new Map();          // المقررات مع عدد الشعب

        // حالة الفلاتر المختارة
        let selectedFilters = {
            departments: [],      // الأقسام المختارة
            prefixes: [],         // الرموز المختارة
            scheduleTypes: []     // أنواع الجدولة المختارة
        };

        // الشعب المستهدفة
        let targetSections = [];  // أرقام الشعب المستهدفة

        // النطاق الزمني الديناميكي
        let timeRangeStart = 0;  // بالدقائق من منتصف الليل
        let timeRangeEnd = 0;    // بالدقائق من منتصف الليل
        let timeRangeMinutes = 0; // إجمالي الدقائق


        // ═══════════════════════════════════════════════════════════════
        //  دوال Timeline
        // ═══════════════════════════════════════════════════════════════

        // تحويل نص الوقت "0730" أو "730" إلى دقائق
        function parseTimeString(timeStr) {
            if (!timeStr) return 0;

            // إزالة المسافات
            timeStr = timeStr.trim();

            // التعامل مع تنسيق HH:MM
            if (timeStr.includes(':')) {
                const parts = timeStr.split(':');
                const hours = parseInt(parts[0]) || 0;
                const mins = parseInt(parts[1]) || 0;
                return hours * 60 + mins;
            }

            // التعامل مع التنسيق الرقمي (3 أو 4 أرقام)
            // "800" = 8:00, "0800" = 8:00, "1030" = 10:30
            if (timeStr.length === 3) {
                // "800" -> "0800"
                timeStr = '0' + timeStr;
            }

            if (timeStr.length >= 4) {
                const hours = parseInt(timeStr.substring(0, 2)) || 0;
                const mins = parseInt(timeStr.substring(2, 4)) || 0;
                return hours * 60 + mins;
            }

            return 0;
        }

        // حساب النطاق الزمني من البيانات
        function calculateTimeRange() {
            let minTime = Infinity;
            let maxTime = 0;

            Object.values(sections).forEach(section => {
                section.sessions.forEach(session => {
                    if (!session.time) return;
                    const [endStr, startStr] = session.time.split(' - ');
                    const start = parseTimeString(startStr);
                    const end = parseTimeString(endStr);

                    if (start < minTime) minTime = start;
                    if (end > maxTime) maxTime = end;
                });
            });

            // إضافة هامش
            timeRangeStart = minTime - 10;
            timeRangeEnd = maxTime + 10;
            timeRangeMinutes = timeRangeEnd - timeRangeStart;

            console.log(`⏰ النطاق الزمني: ${Math.floor(timeRangeStart / 60)}:${timeRangeStart % 60} - ${Math.floor(timeRangeEnd / 60)}:${timeRangeEnd % 60}`);
        }

        // تحويل وقت لنسبة مئوية من عرض الخلية
        function timeToPercent(timeStr) {
            const mins = parseTimeString(timeStr);
            return ((mins - timeRangeStart) / timeRangeMinutes) * 100;
        }

        // تحويل مدة لنسبة مئوية
        function durationToPercent(startStr, endStr) {
            const start = parseTimeString(startStr);
            const end = parseTimeString(endStr);
            return ((end - start) / timeRangeMinutes) * 100;
        }

        // إنشاء خلية Timeline ليوم معين
        function createTimelineCell(daySessions, targetSectionsList = [], showTargetSlots = false, currentDay = null) {
            let bars = '';
            let targetSlots = '';

            // معالجة الجلسات الموجودة
            if (daySessions && daySessions.length > 0) {
                daySessions.forEach(session => {
                    if (!session.time) return;

                    const [endStr, startStr] = session.time.split(' - ');
                    const left = timeToPercent(startStr);
                    const width = durationToPercent(startStr, endStr);
                    const type = getCellType(session.scheduleType);

                    // التحقق من الشعبة المستهدفة
                    const isTarget = targetSectionsList.includes(session.refNumber);
                    const targetClass = isTarget ? ' target' : '';

                    // التحقق من الشعبة الظاهرة (المختارة للعرض)
                    const isVisible = visibleSections.length > 0 && visibleSections.includes(session.refNumber);
                    const visibleClass = isVisible ? ' visible-highlight' : '';

                    // تنسيق الوقت للعرض (0730 → 7:30)
                    const formatTime = (t) => t ? `${parseInt(t.slice(0, 2))}:${t.slice(2)}` : '';
                    const timeDisplay = `${formatTime(startStr)} - ${formatTime(endStr)}`;

                    // Tooltip تفصيلي
                    // الحصول على عدد المتدربين من بيانات الشعبة
                    const sectionData = sections[session.refNumber];
                    const enrolledCount = sectionData ? sectionData.enrolled : 0;

                    const tooltipLines = [
                        `📋 الرقم المرجعي: ${session.refNumber || '-'}`,
                        `📚 ${session.courseCode || ''} - ${session.courseName || ''}`,
                        `⏰ ${timeDisplay}`,
                        `📝 ${session.scheduleType || '-'}`,
                        session.trainerName ? `👨‍🏫 ${session.trainerName}` : '',
                        session.room ? `🏫 القاعة: ${session.room}` : '',
                        `👥 المتدربين: ${enrolledCount}`
                    ].filter(Boolean).join('\n');

                    bars += `<div class="session-bar ${type}${targetClass}${visibleClass}" 
                        style="right: ${left}%; width: ${width}%;"
                        title="${tooltipLines}"
                        data-ref="${session.refNumber}">
                        ${session.courseCode || ''}
                    </div>`;
                });
            }

            // إضافة صناديق الشعب المستهدفة (إظهار موقعها حتى لو لم تكن مسجلة)
            if (showTargetSlots && targetSectionsList.length > 0 && currentDay) {
                targetSectionsList.forEach(refNum => {
                    const section = sections[refNum];
                    if (!section) return;

                    // البحث عن جلسات الشعبة المستهدفة في هذا اليوم فقط
                    section.sessions.forEach(targetSession => {
                        if (!targetSession.time) return;
                        // التحقق من أن الجلسة في نفس اليوم
                        if (targetSession.day !== currentDay) return;

                        const [endStr, startStr] = targetSession.time.split(' - ');
                        const left = timeToPercent(startStr);
                        const width = durationToPercent(startStr, endStr);

                        // التحقق من وجود تعارض (هل هناك جلسة أخرى في نفس الوقت؟)
                        const hasConflict = daySessions && daySessions.some(s => {
                            if (!s.time || s.refNumber === refNum) return false;
                            const [sEnd, sStart] = s.time.split(' - ');
                            // تحقق من التداخل الزمني
                            return !(endStr <= sStart || startStr >= sEnd);
                        });

                        const conflictClass = hasConflict ? 'conflict' : 'available';
                        const tooltipText = hasConflict ?
                            `⚠️ تعارض - ${section.courseCode} (${refNum})` :
                            `✅ متاح - ${section.courseCode} (${refNum})`;

                        targetSlots += `<div class="target-slot ${conflictClass}" 
                            style="right: ${left}%; width: ${width}%;"
                            title="${tooltipText}"
                            data-ref="${refNum}">
                        </div>`;
                    });
                });
            }

            // إضافة صناديق الفراغات المشتركة (أخضر متوهج)
            let freeSlotsHtml = '';
            if (showFreeSlots && currentDay && visibleSections.length > 0) {
                const sharedFreeSlots = calculateSharedFreeSlots();
                const dayFreeSlots = sharedFreeSlots[currentDay] || [];

                dayFreeSlots.forEach(slot => {
                    // تحويل الدقائق إلى نص وقت (مثل "0730")
                    const startTimeStr = String(Math.floor(slot.start / 60)).padStart(2, '0') +
                        String(slot.start % 60).padStart(2, '0');
                    const endTimeStr = String(Math.floor(slot.end / 60)).padStart(2, '0') +
                        String(slot.end % 60).padStart(2, '0');

                    const left = timeToPercent(startTimeStr);
                    const width = ((slot.end - slot.start) / timeRangeMinutes) * 100;

                    // تنسيق الوقت للعرض
                    const startDisplay = minutesToTimeString(slot.start);
                    const endDisplay = minutesToTimeString(slot.end);
                    const duration = slot.end - slot.start;

                    const tooltipText = `✅ فراغ متاح\nمن ${startDisplay} إلى ${endDisplay}\n(${duration} دقيقة)`;

                    freeSlotsHtml += `<div class="free-slot" 
                        style="right: ${left}%; width: ${width}%;"
                        title="${tooltipText}">
                    </div>`;
                });
            }

            // إضافة صناديق الفترات المعتمدة (سماوي)
            let freetimePeriodHtml = '';
            if (appliedFreetimePeriods.length > 0 && currentDay) {
                // تصفية الفترات التي تنطبق على هذا اليوم
                const dayPeriods = appliedFreetimePeriods.filter(sp => sp.day === currentDay);

                dayPeriods.forEach(sp => {
                    const period = sp.period;

                    // تحويل الفترة لنص وقت (مثل "0730")
                    const startTimeStr = String(Math.floor(period.start / 60)).padStart(2, '0') +
                        String(period.start % 60).padStart(2, '0');
                    const endTimeStr = String(Math.floor(period.end / 60)).padStart(2, '0') +
                        String(period.end % 60).padStart(2, '0');

                    const left = timeToPercent(startTimeStr);
                    const width = ((period.end - period.start) / timeRangeMinutes) * 100;

                    // التحقق من وجود تعارض مع الجلسات الموجودة
                    const hasConflict = daySessions && daySessions.some(s => {
                        if (!s.time) return false;
                        const [sEnd, sStart] = s.time.split(' - ');
                        const sessionStart = parseInt(sStart.substring(0, 2)) * 60 + parseInt(sStart.substring(2, 4));
                        const sessionEnd = parseInt(sEnd.substring(0, 2)) * 60 + parseInt(sEnd.substring(2, 4));
                        // تحقق من التداخل الزمني
                        return !(period.end <= sessionStart || period.start >= sessionEnd);
                    });

                    const conflictClass = hasConflict ? 'freetime-conflict' : 'freetime-available';
                    const statusIcon = hasConflict ? '⚠️' : '✅';
                    const statusText = hasConflict ? 'تعارض' : 'متاح';
                    const tooltipText = `${statusIcon} ${statusText} - الفترة ${period.index}\nمن ${period.startStr} إلى ${period.endStr}`;

                    freetimePeriodHtml += `<div class="freetime-period-slot ${conflictClass}" 
                        style="right: ${left}%; width: ${width}%;"
                        title="${tooltipText}">
                        <span class="period-label">ف${period.index}</span>
                    </div>`;
                });
            }

            // تحديد كلاس اليوم
            const dayMap = { 'الأحد': 'day-sun', 'الإثنين': 'day-mon', 'الثلاثاء': 'day-tue', 'الأربعاء': 'day-wed', 'الخميس': 'day-thu' };
            const dayClass = (currentDay && dayMap[currentDay]) ? dayMap[currentDay] : '';

            return `<td class="day-column ${dayClass}"><div class="day-cell">${freeSlotsHtml}${freetimePeriodHtml}${targetSlots}${bars}</div></td>`;
        }

        // ═══════════════════════════════════════════════════════════════
        function parseCSV(text) {
            const lines = text.split(/\r?\n/).filter(line => line.trim());
            if (lines.length === 0) return [];

            const result = [];
            const headers = parseCSVLine(lines[0]);

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === 0) continue;

                const row = {};
                headers.forEach((header, idx) => {
                    row[header.trim()] = values[idx]?.trim() || '';
                });
                result.push(row);
            }

            return result;
        }

        // معالجة سطر CSV مع دعم علامات الاقتباس
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++; // تخطي علامة الاقتباس المزدوجة
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);

            return result;
        }

        // ═══════════════════════════════════════════════════════════════
        //  2. معالجة ملف SS01 (جداول الشعب)
        // ═══════════════════════════════════════════════════════════════
        function parseSS01(data) {
            sections = {};
            trainers = {};

            data.forEach(row => {
                const refNum = row['الرقم المرجعي'];
                if (!refNum) return;

                const day = row['اليوم'];
                const time = row['الوقت'];
                const trainerId = row['رقم المدرب'];
                const trainerName = row['اسم المدرب'];

                // جمع الأوقات الفريدة
                if (time) {
                    allTimeSlots.add(time);
                }

                // إذا الشعبة موجودة، أضف الجلسة
                if (sections[refNum]) {
                    // تأكد من عدم تكرار الجلسة
                    const exists = sections[refNum].sessions.some(s =>
                        s.day === day && s.time === time
                    );
                    if (!exists && day && time) {
                        sections[refNum].sessions.push({ day, time });
                    }
                } else {
                    // إنشاء شعبة جديدة
                    sections[refNum] = {
                        refNumber: refNum,
                        courseCode: row['المقرر'] || '',
                        courseName: row['اسم المقرر'] || '',
                        trainerId: trainerId || '',
                        trainerName: trainerName || '',
                        scheduleType: row['نوع الجدولة'] || row['نوع الشعبة'] || '',
                        creditHours: parseInt(row['الساعات المعتمدة']) || 0,
                        contactHours: parseInt(row['ساعات الاتصال']) || 0,
                        lectureHours: parseInt(row['ساعات المحاضرة']) || 0,
                        labHours: parseInt(row['ساعات المختبر']) || 0,
                        otherHours: parseInt(row['ساعات أخرى']) || 0,
                        department: row['القسم'] || '',
                        building: row['مبنى'] || '',
                        room: row['قاعة'] || '',
                        capacity: parseInt(row['سعة']) || 0,
                        enrolled: parseInt(row['مسجلين']) || 0,
                        sessions: day && time ? [{ day, time }] : []
                    };
                }

                // بناء قائمة المدربين
                if (trainerId && trainerName) {
                    if (!trainers[trainerId]) {
                        trainers[trainerId] = {
                            id: trainerId,
                            name: trainerName,
                            sections: []
                        };
                    }
                    if (!trainers[trainerId].sections.includes(refNum)) {
                        trainers[trainerId].sections.push(refNum);
                    }
                }

                // استخراج بيانات الفلاتر
                const dept = row['القسم'];
                const courseCode = row['المقرر'];
                const schedType = row['نوع الشعبة'] || row['نوع الجدولة'];

                if (dept) departments.add(dept);
                if (schedType) scheduleTypes.add(schedType);

                // استخراج رمز المقرر (الحروف فقط)
                if (courseCode) {
                    const prefix = courseCode.replace(/[-\d]/g, '').trim();
                    if (prefix) coursePrefixes.add(prefix);

                    // تتبع المقررات مع عدد شعبها
                    if (!courses.has(courseCode)) {
                        courses.set(courseCode, {
                            code: courseCode,
                            name: row['اسم المقرر'] || '',
                            sectionCount: 0
                        });
                    }
                    courses.get(courseCode).sectionCount++;
                }
            });

            console.log(`✅ تم تحميل ${Object.keys(sections).length} شعبة`);
            console.log(`✅ تم تحميل ${Object.keys(trainers).length} مدرب`);
            console.log(`📁 ${departments.size} قسم | ${coursePrefixes.size} رمز | ${scheduleTypes.size} نوع شعبة`);
        }

        // ═══════════════════════════════════════════════════════════════
        //  3. معالجة ملف SF01 (تسجيل المتدربين)
        // ═══════════════════════════════════════════════════════════════
        function parseSF01(data) {
            trainees = {};

            data.forEach(row => {
                const traineeId = row['رقم المتدرب'];
                const refNum = row['الرقم المرجعي'];

                if (!traineeId) return;

                // قراءة الساعات المعتمدة من SF01
                const creditHours = parseInt(row['الساعات المعتمدة']) || 0;

                if (trainees[traineeId]) {
                    // إضافة تسجيل جديد للمتدرب الموجود
                    if (refNum) {
                        const exists = trainees[traineeId].registrations.some(r => r.refNum === refNum);
                        if (!exists) {
                            trainees[traineeId].registrations.push({ refNum, creditHours });
                        }
                    }
                } else {
                    // إنشاء متدرب جديد
                    trainees[traineeId] = {
                        id: traineeId,
                        name: row['إسم المتدرب'] || '',
                        department: row['القسم'] || '',
                        major: row['التخصص'] || '',
                        program: row['برنامج'] || '',
                        phone: row['رقم الجوال'] || '',
                        status: row['حالة المتدرب'] || '',
                        trainingType: row['نوع التدريب'] || '',
                        registrations: refNum ? [{ refNum, creditHours }] : []
                    };
                }
            });

            console.log(`✅ تم تحميل ${Object.keys(trainees).length} متدرب`);
        }

        // ═══════════════════════════════════════════════════════════════
        //  4. الحصول على جدول المتدرب
        // ═══════════════════════════════════════════════════════════════
        function getTraineeSchedule(traineeId) {
            const trainee = trainees[traineeId];
            if (!trainee) return {};

            const schedule = {};
            DAYS.forEach(day => schedule[day] = {});

            let totalCreditHours = 0;

            trainee.registrations.forEach(reg => {
                const refNum = reg.refNum;
                const section = sections[refNum];
                if (!section) return;

                // جمع الساعات المعتمدة من التسجيل (SF01) وليس من الشعبة (SS01)
                totalCreditHours += reg.creditHours;

                section.sessions.forEach(session => {
                    if (!schedule[session.day]) schedule[session.day] = {};

                    schedule[session.day][session.time] = {
                        refNumber: refNum,
                        courseCode: section.courseCode,
                        courseName: section.courseName,
                        trainerName: section.trainerName,
                        scheduleType: section.scheduleType,
                        room: section.room
                    };
                });
            });

            return {
                schedule,
                totalCreditHours,
                registrationCount: trainee.registrations.length
            };
        }

        // ═══════════════════════════════════════════════════════════════
        //  5. الحصول على جدول المدرب
        // ═══════════════════════════════════════════════════════════════
        function getTrainerSchedule(trainerId) {
            const trainer = trainers[trainerId];
            if (!trainer) return {};

            const schedule = {};
            DAYS.forEach(day => schedule[day] = {});

            let totalSections = trainer.sections.length;
            let totalMinutes = 0;
            let totalQuota = 0;

            trainer.sections.forEach(refNum => {
                const section = sections[refNum];
                if (!section) return;

                // حساب الدقائق الفعلية من الجلسات لهذه الشعبة
                let sectionMinutes = 0;
                section.sessions.forEach(session => {
                    if (!session.time) return;
                    const [endStr, startStr] = session.time.split(' - ');
                    const start = parseTimeString(startStr);
                    const end = parseTimeString(endStr);
                    sectionMinutes += (end - start);

                    if (!schedule[session.day]) schedule[session.day] = {};

                    schedule[session.day][session.time] = {
                        refNumber: refNum,
                        courseCode: section.courseCode,
                        courseName: section.courseName,
                        scheduleType: section.scheduleType,
                        enrolled: section.enrolled,
                        room: section.room
                    };
                });

                totalMinutes += sectionMinutes;

                // حساب ساعات الاتصال لهذه الشعبة
                const sectionContactHours = sectionMinutes / 50;

                // حساب النصاب بناءً على نوع الشعبة
                const scheduleType = (section.scheduleType || '').toLowerCase();

                if (scheduleType.includes('ذاتي')) {
                    // الذاتي لا يُحسب ضمن النصاب
                    // لا إضافة
                } else if (scheduleType.includes('عملي') || scheduleType.includes('تعاوني')) {
                    // العملي والتعاوني: 3 ساعات اتصال = 2 نصاب
                    totalQuota += (sectionContactHours * 2) / 3;
                } else if (scheduleType.includes('مدمج')) {
                    // المدمج: يعتمد على نوع المقرر الأصلي
                    const theoryHours = (section.lectureHours || 0) + (section.otherHours || 0);
                    const practicalHours = section.labHours || 0;

                    if (practicalHours > 0 && theoryHours === 0) {
                        // مقرر عملي بحت مدمج → 3:2
                        totalQuota += (sectionContactHours * 2) / 3;
                    } else {
                        // مقرر نظري أو مختلط مدمج → 1:1
                        totalQuota += sectionContactHours;
                    }
                } else {
                    // النظري (افتراضي): 1 ساعة اتصال = 1 نصاب
                    totalQuota += sectionContactHours;
                }
            });

            // تحويل الدقائق إلى ساعات اتصال (كل 50 دقيقة = ساعة)
            // مع تقريب إلى خانة عشرية واحدة
            const totalContactHours = Math.round((totalMinutes / 50) * 10) / 10;
            totalQuota = Math.round(totalQuota * 10) / 10;

            return {
                schedule,
                totalSections,
                totalContactHours,
                totalQuota
            };
        }

        // ═══════════════════════════════════════════════════════════════
        //  6. تحديد فراغات المتدرب
        // ═══════════════════════════════════════════════════════════════
        function getTraineeFreeSlots(traineeId) {
            const { schedule } = getTraineeSchedule(traineeId);
            const freeSlots = {};

            DAYS.forEach(day => {
                freeSlots[day] = TIME_SLOTS.filter(slot =>
                    !schedule[day] || !schedule[day][slot]
                );
            });

            return freeSlots;
        }

        // ═══════════════════════════════════════════════════════════════
        //  7. التحقق من توفر المتدرب لشعبة معينة
        // ═══════════════════════════════════════════════════════════════
        function isTraineeAvailableForSection(traineeId, sectionRefNum) {
            const section = sections[sectionRefNum];
            if (!section) return false;

            const freeSlots = getTraineeFreeSlots(traineeId);

            // يجب أن يكون فارغاً في جميع جلسات الشعبة
            return section.sessions.every(session =>
                freeSlots[session.day]?.includes(session.time)
            );
        }

        // ═══════════════════════════════════════════════════════════════
        //  8. المعالجة الرئيسية عند رفع الملفات
        // ═══════════════════════════════════════════════════════════════
        async function processUploadedFiles() {
            try {
                showLoading(true);

                // قراءة ملف SS01 (من الذاكرة أو من الملف)
                let ss01Text;
                if (uploadedFiles.ss01.content) {
                    ss01Text = uploadedFiles.ss01.content;
                } else if (uploadedFiles.ss01.text) {
                    ss01Text = await uploadedFiles.ss01.text();
                } else {
                    throw new Error('SS01 content not found');
                }
                const ss01Data = parseCSV(ss01Text);
                parseSS01(ss01Data);

                // قراءة ملف SF01 (من الذاكرة أو من الملف)
                let sf01Text;
                if (uploadedFiles.sf01.content) {
                    sf01Text = uploadedFiles.sf01.content;
                } else if (uploadedFiles.sf01.text) {
                    sf01Text = await uploadedFiles.sf01.text();
                } else {
                    throw new Error('SF01 content not found');
                }
                const sf01Data = parseCSV(sf01Text);
                parseSF01(sf01Data);

                // ترتيب الأوقات وحفظها عالمياً
                sortedTimeSlots = Array.from(allTimeSlots).sort((a, b) => {
                    const timeA = a.split(' - ')[0];
                    const timeB = b.split(' - ')[0];
                    return timeA.localeCompare(timeB);
                });

                console.log('⏰ الأوقات المتاحة:', sortedTimeSlots);

                // حساب النطاق الزمني
                calculateTimeRange();

                // عرض البيانات
                renderAllData();

                showLoading(false);

                // بدء الجولة التفاعلية عند أول استخدام
                const tourCompleted = localStorage.getItem('tourCompleted');
                console.log('🎯 Tour check:', tourCompleted ? 'مكتمل' : 'لم يتم');
                if (!tourCompleted) {
                    setTimeout(() => {
                        console.log('🚀 بدء الجولة التفاعلية...');
                        startTour();
                    }, 800);
                }

                return true;
            } catch (error) {
                console.error('خطأ في معالجة الملفات:', error);
                showLoading(false);
                showToast('حدث خطأ في معالجة الملفات', 'error');
                return false;
            }
        }

        // تفعيل توهج جذب الانتباه للشعب الظاهرة
        function triggerAttentionGlow() {
            const visibleRow = document.querySelector('.section-row.visible-row');
            if (!visibleRow) return;

            // إضافة كلاس التوهج
            visibleRow.classList.add('attention-glow');

            // إظهار رسالة إرشادية
            setTimeout(() => {
                showToast('👆 اختر شعبة من "الشعب الظاهرة" للبدء', 'info');
            }, 500);

            // إزالة التوهج بعد 6 ثوانٍ
            setTimeout(() => {
                removeAttentionGlow();
            }, 6000);
        }

        // إزالة توهج جذب الانتباه
        function removeAttentionGlow() {
            const visibleRow = document.querySelector('.section-row.visible-row');
            if (visibleRow) {
                visibleRow.classList.remove('attention-glow');
            }
        }

        // ═══════════════════════════════════════════════════════════════
        //  عرض البيانات في الجداول
        // ═══════════════════════════════════════════════════════════════
        function renderAllData() {
            updateTableHeaders();
            renderTrainersTable();
            renderTraineesTable();
            populateMultiSelectLists(); // تصحيح اسم الدالة
            updateCounts();
        }

        // تحديث العدادات
        function updateCounts() {
            const trainersCount = document.querySelector('.table-section:first-child .table-count');
            const traineesCount = document.querySelector('.table-section:last-child .table-count');

            if (trainersCount) {
                trainersCount.textContent = `${Object.keys(trainers).length} مدرب`;
            }
            if (traineesCount) {
                traineesCount.textContent = `${Object.keys(trainees).length} متدرب`;
            }
        }

        // تحديث رؤوس الجداول ديناميكياً (Timeline)
        function updateTableHeaders() {
            const tables = document.querySelectorAll('.data-table');

            // خريطة أسماء الأيام للكلاسات
            const dayMap = ['day-sun', 'day-mon', 'day-tue', 'day-wed', 'day-thu'];

            tables.forEach(table => {
                const thead = table.querySelector('thead');
                if (!thead) return;

                const isTrainersTable = table.closest('.table-section')?.querySelector('.table-title')?.textContent?.includes('المدربين');

                // إضافة كلاس مميز للرأس
                thead.classList.remove('trainer-header', 'trainee-header');
                thead.classList.add(isTrainersTable ? 'trainer-header' : 'trainee-header');

                // تحديد نوع الجدول والأعمدة القابلة للفلترة
                const type = isTrainersTable ? 'trainer' : 'trainee';
                const nameCol = isTrainersTable ? 'المدرب' : 'المتدرب';
                const deptCol = isTrainersTable ? 'القسم' : 'التخصص';

                // صف واحد فقط بـ 5 أعمدة للأيام
                let headerRow = `<tr>
                    <th class="col-id">#</th>
                    
                    <!-- عمود الاسم مع فلتر -->
                    <th class="col-name">
                        <div class="th-filter-wrapper">
                            <span>${nameCol}</span>
                            <button id="btn-filter-${type}-name"
                                    class="column-filter-btn ${columnFilters[type].name.length > 0 ? 'active' : ''}" 
                                    onclick="toggleColumnFilter(event, '${type}', 'name')">
                                <i data-lucide="filter"></i>
                            </button>
                        </div>
                    </th>

                    <!-- عمود القسم/التخصص مع فلتر -->
                    <th class="col-dept">
                         <div class="th-filter-wrapper">
                            <span>${deptCol}</span>
                             <button id="btn-filter-${type}-${isTrainersTable ? 'dept' : 'major'}"
                                    class="column-filter-btn ${columnFilters[type].dept ? (columnFilters[type].dept.length > 0 ? 'active' : '') : (columnFilters[type].major.length > 0 ? 'active' : '')}" 
                                    onclick="toggleColumnFilter(event, '${type}', '${isTrainersTable ? 'dept' : 'major'}')">
                                <i data-lucide="filter"></i>
                            </button>
                        </div>
                    </th>

                    ${isTrainersTable ?
                        '<th class="col-stat text-contact">اتصال</th><th class="col-stat text-quota">النصاب</th>' :
                        '<th class="col-stat text-contact">الرقم</th><th class="col-stat text-credits">س. م.</th>'}`;

                DAYS.forEach((day, idx) => {
                    // إضافة كلاس اليوم المناسب للرأس
                    headerRow += `<th class="day-header day-column ${dayMap[idx] || ''}">${day}</th>`;
                });
                headerRow += '</tr>';

                thead.innerHTML = headerRow;

                // إعادة تفعيل الأيقونات
                if (window.lucide) {
                    lucide.createIcons({
                        root: thead
                    });
                }
            });

            console.log('✅ تم تحديث رؤوس الجداول (Timeline) مع الفلاتر');
        }

        // ═══════════════════════════════════════════════════════════════
        //  نسخ قائمة المتدربين المدمجين (Double-click)
        // ═══════════════════════════════════════════════════════════════
        document.addEventListener('dblclick', async function (e) {
            // نسخ قائمة المجموعة المدمجة
            const mergeCount = e.target.closest('.merge-count');
            if (mergeCount && mergeCount.dataset.copy) {
                try {
                    await navigator.clipboard.writeText(mergeCount.dataset.copy);
                    showToast('تم نسخ قائمة المتدربين للحافظة', 'success');
                } catch (err) {
                    console.error('فشل النسخ:', err);
                    showToast('فشل في النسخ', 'error');
                }
                return;
            }

            // نسخ رقم المتدرب الفردي
            const traineeIdCell = e.target.closest('.trainee-id-cell');
            if (traineeIdCell && traineeIdCell.dataset.copy) {
                try {
                    await navigator.clipboard.writeText(traineeIdCell.dataset.copy);
                    showToast('تم نسخ رقم المتدرب: ' + traineeIdCell.dataset.copy, 'success');
                } catch (err) {
                    console.error('فشل النسخ:', err);
                    showToast('فشل في النسخ', 'error');
                }
            }
        });

        // ═══════════════════════════════════════════════════════════════
        //  إظهار/إخفاء Tooltip المجموعات المدمجة (position: fixed)
        // ═══════════════════════════════════════════════════════════════
        document.addEventListener('mouseenter', function (e) {
            if (!e.target || !e.target.closest) return;
            const mergedCell = e.target.closest('.merged-cell');
            if (mergedCell) {
                const tooltip = mergedCell.querySelector('.merged-tooltip');
                if (tooltip) {
                    const rect = mergedCell.getBoundingClientRect();
                    const tooltipHeight = 300; // max-height
                    const spaceBelow = window.innerHeight - rect.bottom;

                    // تحديد الموقع: فوق أو تحت
                    if (spaceBelow < tooltipHeight && rect.top > tooltipHeight) {
                        // إظهار فوق
                        tooltip.style.top = 'auto';
                        tooltip.style.bottom = (window.innerHeight - rect.top + 8) + 'px';
                    } else {
                        // إظهار تحت
                        tooltip.style.bottom = 'auto';
                        tooltip.style.top = (rect.bottom + 8) + 'px';
                    }

                    // التوسيط أفقياً
                    tooltip.style.left = (rect.left + rect.width / 2 - 160) + 'px'; // 160 = نصف min-width

                    tooltip.classList.add('visible');
                }
            }
        }, true);

        document.addEventListener('mouseleave', function (e) {
            if (!e.target || !e.target.closest) return;
            const mergedCell = e.target.closest('.merged-cell');
            if (mergedCell) {
                const tooltip = mergedCell.querySelector('.merged-tooltip');
                if (tooltip) {
                    tooltip.classList.remove('visible');
                }
            }
        }, true);

        // ═══════════════════════════════════════════════════════════════
        //  منطق فلاتر الأعمدة
        // ═══════════════════════════════════════════════════════════════

        // متغير لتخزين الفلتر النشط حالياً
        let activeFilterContext = null;

        // تهيئة قائمة الفلتر العامة (مرة واحدة)
        function initGlobalFilterDropdown() {
            if (document.getElementById('global-column-filter')) return;

            const dropdown = document.createElement('div');
            dropdown.id = 'global-column-filter';
            dropdown.className = 'column-filter-dropdown';

            // الهيكل الداخلي
            // الهيكل الداخلي
            dropdown.innerHTML = `
                <div class="column-filter-header">
                    <input type="text" class="column-filter-search" 
                           placeholder="بحث..." 
                           id="global-filter-search">
                    <button class="column-filter-action-btn btn-select-all" id="global-filter-select-all" title="تحديد الكل">
                         <i data-lucide="check-check"></i>
                    </button>
                    <button class="column-filter-action-btn btn-clear-all" id="global-filter-clear-all" title="مسح التحديد">
                         <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="column-filter-options" id="global-filter-options"></div>
             `;

            // إعادة تهيئة الأيقونات
            if (window.lucide) window.lucide.createIcons({ root: dropdown });

            document.body.appendChild(dropdown);

            // منع إغلاق القائمة عند النقر داخلها
            dropdown.addEventListener('click', (e) => e.stopPropagation());

            // ربط أحداث البحث والأزرار
            document.getElementById('global-filter-search').addEventListener('input', (e) => {
                if (activeFilterContext) filterColumnSearch(e.target, activeFilterContext.type, activeFilterContext.field);
            });

            document.getElementById('global-filter-select-all').addEventListener('click', () => {
                if (activeFilterContext) selectAllColumnFilter(activeFilterContext.type, activeFilterContext.field);
            });

            document.getElementById('global-filter-clear-all').addEventListener('click', () => {
                if (activeFilterContext) clearColumnFilter(activeFilterContext.type, activeFilterContext.field);
            });
        }

        // الانتقال لصفحة الرفع
        function goToUploadPage() {
            document.getElementById('mainPage').classList.remove('active');
            setTimeout(() => {
                document.getElementById('uploadPage').style.display = 'flex';
                document.getElementById('mainPage').style.display = 'none';

                // إعادة تفعيل الأنيميشن
                requestAnimationFrame(() => {
                    document.getElementById('uploadPage').classList.add('active');
                });
            }, 300);
        }

        // بدء التطبيق
        document.getElementById('startBtn').addEventListener('click', async () => {
            const success = await processUploadedFiles();
            if (success) {
                document.getElementById('uploadPage').classList.remove('active');
                setTimeout(() => {
                    document.getElementById('uploadPage').style.display = 'none';
                    document.getElementById('mainPage').style.display = 'flex';
                    requestAnimationFrame(() => {
                        document.getElementById('mainPage').classList.add('active');
                        // إعادة تهيئة الأيقونات للتأكد من ظهورها في الصفحة الرئيسية
                        if (window.lucide) window.lucide.createIcons();
                    });
                }, 300);
            }
        });

        // تهيئة الأيقونات عند التحميل الأولي
        document.addEventListener('DOMContentLoaded', () => {
            if (window.lucide) window.lucide.createIcons();

            // مزامنة حالة الأزرار
            updateFreeOnlyUI();
            updateMergeIdenticalUI();
            updateFreeSlotsUI();
        });

        // فتح قائمة الفلتر
        function toggleColumnFilter(event, type, field) {
            event.stopPropagation();
            initGlobalFilterDropdown();

            const dropdown = document.getElementById('global-column-filter');
            // العثور على الزر بدقة
            const buttonId = `btn-filter-${type}-${field}`;
            let button = document.getElementById(buttonId);

            // Fallback
            if (!button && event.currentTarget) button = event.currentTarget;

            if (!button) {
                console.error('Filter button not found:', buttonId);
                return;
            }

            // إذا ضغطنا على نفس الزر والقائمة مفتوحة -> أغلقها
            if (activeFilterContext &&
                activeFilterContext.type === type &&
                activeFilterContext.field === field &&
                dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                activeFilterContext = null;
                return;
            }

            // تحديث السياق
            activeFilterContext = { type, field, button };

            // تنظيف حقل البحث
            const searchInput = document.getElementById('global-filter-search');
            if (searchInput) searchInput.value = '';

            // بناء الخيارات
            buildColumnFilterOptions(type, field);

            // إعادة حساب الموقع
            repositionDropdown(dropdown, button);

            dropdown.classList.add('show');
        }

        function repositionDropdown(dropdown, button) {
            const btnRect = button.getBoundingClientRect();
            const dropdownWidth = 350;

            let top = btnRect.bottom + 5;
            let left = btnRect.right - dropdownWidth;

            if (left < 10) left = 10;
            if (top + 300 > window.innerHeight) top = btnRect.top - 310;

            dropdown.style.top = `${top}px`;
            dropdown.style.left = `${left}px`;
            dropdown.style.right = 'auto';
        }

        // إغلاق الفلاتر عند النقر خارجها
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.column-filter-dropdown') && !event.target.closest('.column-filter-btn')) {
                document.querySelectorAll('.column-filter-dropdown').forEach(d => d.classList.remove('show'));
            }
        });

        // إغلاق القوائم عند التمرير (لأنها ثابتة ولا تتحرك مع الجدول)
        window.addEventListener('scroll', () => {
            document.querySelectorAll('.column-filter-dropdown.show').forEach(d => d.classList.remove('show'));
        }, true);

        // بناء خيارات الفلتر
        function buildColumnFilterOptions(type, field) {
            const container = document.getElementById('global-filter-options');
            if (!container) return;

            let values = new Set();

            try {
                if (type === 'trainer') {
                    if (field === 'name') Object.values(trainers).forEach(t => values.add(t.name));
                    else if (field === 'dept') Object.values(trainers).forEach(t => t.sections.forEach(ref => { const d = sections[ref]?.department; if (d) values.add(d); }));
                } else if (type === 'trainee') {
                    if (field === 'name') Object.values(trainees).forEach(t => values.add(t.name));
                    else if (field === 'major') Object.values(trainees).forEach(t => { if (t.major) values.add(t.major); });
                }
            } catch (err) {
                console.error('Error building filter options:', err);
            }

            const sortedValues = [...values].sort();
            const currentSelection = columnFilters[type][field];

            let html = '';
            if (sortedValues.length === 0) {
                html = '<div style="padding:10px; text-align:center; color:#666;">لا توجد بيانات</div>';
            } else {
                sortedValues.forEach(val => {
                    const isChecked = currentSelection.includes(val);
                    html += `
                        <label class="column-filter-option">
                            <input type="checkbox" value="${val}" 
                                   ${isChecked ? 'checked' : ''} 
                                   onchange="applyColumnFilter('${type}', '${field}', this.value, this.checked)">
                            <span>${val}</span>
                        </label>
                    `;
                });
            }
            container.innerHTML = html;
        }

        // البحث
        function filterColumnSearch(input, type, field) {
            const filterText = input.value.toLowerCase();
            const options = document.querySelectorAll(`#global-filter-options .column-filter-option`);
            options.forEach(option => {
                const text = option.querySelector('span').textContent.toLowerCase();
                option.style.display = text.includes(filterText) ? 'flex' : 'none';
            });
        }

        // تطبيق الفلتر
        function applyColumnFilter(type, field, value, isChecked) {
            if (isChecked) {
                if (!columnFilters[type][field].includes(value)) columnFilters[type][field].push(value);
            } else {
                columnFilters[type][field] = columnFilters[type][field].filter(v => v !== value);
            }
            updateAndRender(type, field, true);
        }

        // اختيار الكل
        function selectAllColumnFilter(type, field) {
            const container = document.getElementById('global-filter-options');
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:not(:checked)');

            checkboxes.forEach(cb => {
                if (getComputedStyle(cb.closest('label')).display !== 'none') {
                    cb.checked = true;
                    if (!columnFilters[type][field].includes(cb.value)) {
                        columnFilters[type][field].push(cb.value);
                    }
                }
            });
            updateAndRender(type, field, true);
        }

        // مسح الكل
        function clearColumnFilter(type, field) {
            columnFilters[type][field] = [];
            updateAndRender(type, field, true);
        }

        function updateAndRender(type, field, keepDropdownOpen = false) {
            // تحديث الجدول
            updateTableHeaders();
            if (type === 'trainer') renderTrainersTable();
            else renderTraineesTable();

            if (keepDropdownOpen && activeFilterContext) {
                // إعادة العثور على الزر وإعادة التموضع
                setTimeout(() => {
                    const buttonId = `btn-filter-${activeFilterContext.type}-${activeFilterContext.field}`;
                    const newButton = document.getElementById(buttonId);

                    if (newButton) {
                        activeFilterContext.button = newButton;
                        const dropdown = document.getElementById('global-column-filter');
                        repositionDropdown(dropdown, newButton);
                    } else {
                        // الزر اختفى
                        const d = document.getElementById('global-column-filter');
                        if (d) d.classList.remove('show');
                        activeFilterContext = null;
                    }
                }, 0);
            } else {
                // إغلاق افتراضي إذا لم نطلب الإبقاء
                if (!keepDropdownOpen) {
                    const d = document.getElementById('global-column-filter');
                    if (d) d.classList.remove('show');
                    activeFilterContext = null;
                }
            }
        }

        // الحصول على نوع الخلية بناءً على نوع الجدولة
        function getCellType(scheduleType) {
            if (!scheduleType) return 'empty';
            const type = scheduleType.toLowerCase();
            if (type.includes('نظري')) return 'theory';
            if (type.includes('عملي')) return 'practical';
            if (type.includes('مدمج') || type.includes('تعاوني')) return 'blended';
            return 'theory';
        }

        // الحصول على رمز نوع الشعبة مع اللون (للقوائم المنسدلة)
        function getTypeCode(scheduleType) {
            if (!scheduleType) return '';
            const type = scheduleType.toLowerCase();
            if (type.includes('نظري')) return '<span style="color: #3b82f6; font-weight: bold;">ن</span>';
            if (type.includes('عملي')) return '<span style="color: #10b981; font-weight: bold;">ع</span>';
            if (type.includes('مدمج')) return '<span style="color: #8b5cf6; font-weight: bold;">م</span>';
            if (type.includes('ذاتي')) return '<span style="color: #6b7280; font-weight: bold;">ذ</span>';
            if (type.includes('تعاوني')) return '<span style="color: #f59e0b; font-weight: bold;">ت</span>';
            return '';
        }

        // الحصول على رمز اليوم
        function getDayCode(dayName) {
            if (!dayName) return '';
            const day = dayName.toLowerCase();
            if (day.includes('أحد') || day.includes('احد')) return 'ح';
            if (day.includes('اثن') || day.includes('إثن')) return 'ن';
            if (day.includes('ثلاث')) return 'ث';
            if (day.includes('أربع') || day.includes('اربع')) return 'ر';
            if (day.includes('خميس')) return 'خ';
            return dayName.charAt(0);
        }

        // إنشاء مربعات الجلسات (يوم + وقت) للقوائم المنسدلة
        function getSessionBadges(sessions) {
            if (!sessions || sessions.length === 0) return '';
            return sessions.map(s => {
                const dayCode = getDayCode(s.day);
                const time = formatTimeForDisplay(s.time);
                return `<span style="background: rgba(99,102,241,0.2); border-radius: 4px; padding: 0.1rem 0.25rem; font-size: 0.6rem; margin-right: 2px;">${dayCode} ${time}</span>`;
            }).join('');
        }

        // تحويل الوقت للعرض (من - إلى)
        function formatTimeForDisplay(time) {
            if (!time) return '';
            // الوقت يأتي بصيغة "1240 - 1100" (نهاية - بداية)
            const parts = time.split(' - ');
            if (parts.length === 2) {
                const endTime = parts[0];   // 1240
                const startTime = parts[1]; // 1100
                const formatTime = (t) => {
                    if (t && t.length === 4) {
                        return t.substring(0, 2) + ':' + t.substring(2);
                    }
                    return t;
                };
                return `${formatTime(startTime)}-${formatTime(endTime)}`;
            }
            // إذا كان الوقت بصيغة أخرى
            const singleTime = parts[0];
            if (singleTime && singleTime.length === 4) {
                return singleTime.substring(0, 2) + ':' + singleTime.substring(2);
            }
            return time;
        }

        // إنشاء خلية الجدول
        function createScheduleCell(slotData, isTarget = false) {
            if (!slotData) {
                return `<td><div class="time-cell empty${isTarget ? ' target' : ''}"></div></td>`;
            }

            const cellType = getCellType(slotData.scheduleType);
            const targetClass = isTarget ? ' target' : '';
            const tooltip = `${slotData.courseCode}\n${slotData.courseName}\n${slotData.trainerName || ''}`;

            return `<td>
                <div class="time-cell ${cellType}${targetClass}" title="${tooltip}">
                    <span class="cell-content">${slotData.courseCode || ''}</span>
                </div>
            </td>`;
        }

        // عرض جدول المدربين (Timeline)
        function renderTrainersTable() {
            const tbody = document.querySelector('.table-section:first-child .data-table tbody');
            if (!tbody) {
                console.error('لم يتم العثور على جدول المدربين');
                return;
            }

            tbody.innerHTML = '';
            let index = 1;

            // إذا لم يتم اختيار شعبة، إظهار رسالة
            if (visibleSections.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="empty-table-message">
                            <i data-lucide="search"></i>
                            اختر شعبة لإظهار البيانات
                        </td>
                    </tr>`;
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            // تصفية وترتيب المدربين
            let filteredTrainers = Object.values(trainers);

            // 1. فلترة بناءً على الشعب الظاهرة
            if (visibleSections.length > 0) {
                filteredTrainers = filteredTrainers.filter(trainer => {
                    return trainer.sections.some(refNum => visibleSections.includes(refNum));
                });
            }

            // 2. فلترة الأعمدة (المدرب والقسم)
            if (columnFilters.trainer.name.length > 0) {
                filteredTrainers = filteredTrainers.filter(t => columnFilters.trainer.name.includes(t.name));
            }
            if (columnFilters.trainer.dept.length > 0) {
                filteredTrainers = filteredTrainers.filter(t => {
                    const depts = [...new Set(
                        t.sections.map(refNum => sections[refNum]?.department).filter(Boolean)
                    )];
                    // يجب أن يكون لديه قسم واحد على الأقل من الأقسام المختارة
                    return depts.some(d => columnFilters.trainer.dept.includes(d));
                });
            }

            // 3. فلترة المدربين المتاحين للفترات المعتمدة
            if (showFreeOnly && appliedFreetimePeriods.length > 0) {
                filteredTrainers = filteredTrainers.filter(trainer => {
                    const schedule = getTrainerSchedule(trainer.id);

                    for (const sp of appliedFreetimePeriods) {
                        const period = sp.period;
                        const day = sp.day;

                        // فحص جلسات هذا اليوم
                        const daySchedule = schedule.schedule[day] || {};
                        for (const [time, data] of Object.entries(daySchedule)) {
                            const [sEnd, sStart] = time.split(' - ');
                            const sessionStart = parseInt(sStart.substring(0, 2)) * 60 + parseInt(sStart.substring(2, 4));
                            const sessionEnd = parseInt(sEnd.substring(0, 2)) * 60 + parseInt(sEnd.substring(2, 4));

                            // تحقق من التداخل الزمني
                            if (!(period.end <= sessionStart || period.start >= sessionEnd)) {
                                return false; // يوجد تعارض
                            }
                        }
                    }
                    return true; // لا يوجد تعارض - متاح
                });
            }

            // ترتيب المدربين حسب عدد الساعات (تنازلياً)
            const sortedTrainers = filteredTrainers.sort((a, b) => {
                const schedA = getTrainerSchedule(a.id);
                const schedB = getTrainerSchedule(b.id);
                return schedB.totalContactHours - schedA.totalContactHours;
            });

            sortedTrainers.forEach(trainer => {
                const scheduleData = getTrainerSchedule(trainer.id);
                const row = document.createElement('tr');

                // الحصول على أقسام المدرب الفريدة من الشعب التي يدرسها
                const trainerDepts = [...new Set(
                    trainer.sections.map(refNum => sections[refNum]?.department).filter(Boolean)
                )].join(' / ');

                // بناء خلايا الجدول الأساسية
                let cells = `
                    <td class="col-id">${index}</td>
                    <td class="col-name trainer-name" title="${trainer.name}">${trainer.name}</td>
                    <td class="col-dept" title="${trainerDepts}">${trainerDepts}</td>
                    <td class="col-stat text-contact">${scheduleData.totalContactHours}</td>
                    <td class="col-stat text-quota">${scheduleData.totalQuota}</td>
                `;

                // إضافة خلايا Timeline للأيام
                DAYS.forEach(day => {
                    // تجميع جلسات اليوم
                    const daySessions = [];
                    Object.entries(scheduleData.schedule[day] || {}).forEach(([time, data]) => {
                        daySessions.push({
                            time,
                            refNumber: data.refNumber,
                            courseCode: data.courseCode,
                            courseName: data.courseName,
                            scheduleType: data.scheduleType,
                            room: data.room
                        });
                    });
                    cells += createTimelineCell(daySessions, targetSections, false, day);
                });

                row.innerHTML = cells;
                tbody.appendChild(row);
                index++;
            });

            console.log(`✅ تم عرض ${sortedTrainers.length} مدرب (Timeline)`);
        }

        // عرض جدول المتدربين (Timeline)
        function renderTraineesTable() {
            const tbody = document.querySelector('.table-section:last-child .data-table tbody');
            if (!tbody) {
                console.error('لم يتم العثور على جدول المتدربين');
                return;
            }

            tbody.innerHTML = '';
            let index = 1;

            // إذا لم يتم اختيار شعبة، إظهار رسالة
            if (visibleSections.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="empty-table-message">
                            <i data-lucide="search"></i>
                            اختر شعبة لإظهار البيانات
                        </td>
                    </tr>`;
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            // تصفية المتدربين بناءً على الشعب الظاهرة
            let filteredTrainees = Object.values(trainees);

            // 1. فلترة بناءً على الشعب الظاهرة
            if (visibleSections.length > 0) {
                filteredTrainees = filteredTrainees.filter(trainee => {
                    return trainee.registrations.some(r => visibleSections.includes(r.refNum));
                });
            }

            // 2. فلترة الأعمدة (المتدرب والتخصص)
            if (columnFilters.trainee.name.length > 0) {
                filteredTrainees = filteredTrainees.filter(t => columnFilters.trainee.name.includes(t.name));
            }
            if (columnFilters.trainee.major.length > 0) {
                filteredTrainees = filteredTrainees.filter(t => columnFilters.trainee.major.includes(t.major));
            }

            // دالة حساب التعارض مع الشعب المستهدفة
            function hasConflictWithTarget(trainee) {
                if (targetSections.length === 0) return false;

                const schedule = getTraineeSchedule(trainee.id);

                for (const targetRefNum of targetSections) {
                    const targetSection = sections[targetRefNum];
                    if (!targetSection) continue;

                    for (const targetSession of targetSection.sessions) {
                        if (!targetSession.time || !targetSession.day) continue;
                        const [targetEnd, targetStart] = targetSession.time.split(' - ');

                        // التحقق من وجود جلسة في نفس اليوم والوقت
                        const daySchedule = schedule.schedule[targetSession.day] || {};
                        for (const [time, data] of Object.entries(daySchedule)) {
                            if (data.refNumber === targetRefNum) continue;
                            const [sEnd, sStart] = time.split(' - ');
                            // تحقق من التداخل الزمني
                            if (!(targetEnd <= sStart || targetStart >= sEnd)) {
                                return true; // يوجد تعارض
                            }
                        }
                    }
                }
                return false; // لا يوجد تعارض
            }

            // دالة فحص التعارض مع الفترات المعتمدة
            function hasConflictWithFreetimePeriods(trainee) {
                if (appliedFreetimePeriods.length === 0) return false;

                const schedule = getTraineeSchedule(trainee.id);

                for (const sp of appliedFreetimePeriods) {
                    const period = sp.period;
                    const day = sp.day;

                    // فحص جلسات هذا اليوم
                    const daySchedule = schedule.schedule[day] || {};
                    for (const [time, data] of Object.entries(daySchedule)) {
                        const [sEnd, sStart] = time.split(' - ');
                        const sessionStart = parseInt(sStart.substring(0, 2)) * 60 + parseInt(sStart.substring(2, 4));
                        const sessionEnd = parseInt(sEnd.substring(0, 2)) * 60 + parseInt(sEnd.substring(2, 4));

                        // تحقق من التداخل الزمني
                        if (!(period.end <= sessionStart || period.start >= sessionEnd)) {
                            return true; // يوجد تعارض
                        }
                    }
                }
                return false; // لا يوجد تعارض
            }

            // فلترة المتدربين المتاحين فقط إذا كان الخيار مفعلاً
            if (showFreeOnly && targetSections.length > 0) {
                filteredTrainees = filteredTrainees.filter(trainee => !hasConflictWithTarget(trainee));
            }

            // فلترة المتدربين المتاحين للفترات المعتمدة
            if (showFreeOnly && appliedFreetimePeriods.length > 0) {
                filteredTrainees = filteredTrainees.filter(trainee => !hasConflictWithFreetimePeriods(trainee));
            }

            // ترتيب المتدربين: المتاحين أولاً ثم حسب عدد الساعات
            const sortedTrainees = filteredTrainees.sort((a, b) => {
                const conflictA = hasConflictWithTarget(a) ? 1 : 0;
                const conflictB = hasConflictWithTarget(b) ? 1 : 0;

                // إذا لم يكن هناك شعب مستهدفة، رتب حسب الساعات فقط
                if (targetSections.length === 0) {
                    const schedA = getTraineeSchedule(a.id);
                    const schedB = getTraineeSchedule(b.id);
                    return schedB.totalCreditHours - schedA.totalCreditHours;
                }

                // المتاحين (بدون تعارض) أولاً
                if (conflictA !== conflictB) {
                    return conflictA - conflictB;
                }

                // ثم حسب عدد الساعات
                const schedA = getTraineeSchedule(a.id);
                const schedB = getTraineeSchedule(b.id);
                return schedB.totalCreditHours - schedA.totalCreditHours;
            });

            // عرض جميع المتدربين المفلترين (بدون حد)
            const displayTrainees = sortedTrainees;

            // هل يوجد شعب مستهدفة؟
            const showTargetSlots = targetSections.length > 0;

            // ═══════════════════════════════════════════════════════════
            // عرض مع دمج المتطابقين
            // ═══════════════════════════════════════════════════════════
            if (mergeIdentical) {
                // تجميع المتدربين المتطابقين
                const groups = groupIdenticalTrainees(displayTrainees);

                groups.forEach(group => {
                    // استخدام أول متدرب كممثل للمجموعة
                    const representative = group.trainees[0];
                    const scheduleData = getTraineeSchedule(representative.id);
                    const row = document.createElement('tr');

                    // تحديد ما إذا كان هناك تعارض (أي متدرب في المجموعة = المجموعة كلها)
                    const hasConflict = hasConflictWithTarget(representative);
                    if (hasConflict) {
                        row.classList.add('conflict-row');
                    } else if (showTargetSlots) {
                        row.classList.add('available-row');
                    }

                    // إضافة class للمجموعات المتعددة
                    if (group.trainees.length > 1) {
                        row.classList.add('merged-group');
                    }

                    // قائمة المتدربين للـ tooltip (رقم | ID | اسم)
                    const traineeList = group.trainees.map((t, i) => `${i + 1}. ${t.id} - ${t.name}`).join('\n');
                    const tooltipText = `💡 انقر مرتين على الرقم لنسخ القائمة\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\nالمتدربين (${group.trainees.length}):\n${traineeList}`;

                    // بيانات النسخ (اسم [TAB] رقم) لكل سطر
                    const copyData = group.trainees.map(t => `${t.name}\t${t.id}`).join('\n');

                    // الحصول على التخصص (جميع المتدربين في المجموعة من نفس التخصص)
                    const traineeMajor = group.trainees[0]?.major || '';

                    // بناء خلايا الجدول الأساسية
                    let cells = `
                        <td class="col-id">${index}</td>
                        <td class="col-name merged-cell" title="${tooltipText.replace(/"/g, '&quot;')}">
                            <span class="merge-count" data-copy="${copyData.replace(/"/g, '&quot;')}">${group.trainees.length}</span>
                        </td>
                        <td class="col-dept" title="${traineeMajor}">${traineeMajor}</td>
                        <td class="col-stat text-contact">-</td>
                        <td class="col-stat text-credits">${scheduleData.totalCreditHours}</td>
                    `;

                    // إضافة خلايا Timeline للأيام
                    DAYS.forEach(day => {
                        const daySessions = [];
                        Object.entries(scheduleData.schedule[day] || {}).forEach(([time, data]) => {
                            daySessions.push({
                                time,
                                refNumber: data.refNumber,
                                courseCode: data.courseCode,
                                courseName: data.courseName,
                                trainerName: data.trainerName,
                                scheduleType: data.scheduleType,
                                room: data.room
                            });
                        });
                        cells += createTimelineCell(daySessions, targetSections, showTargetSlots, day);
                    });

                    row.innerHTML = cells;
                    tbody.appendChild(row);
                    index++;
                });

                console.log(`✅ تم عرض ${groups.length} مجموعة من ${displayTrainees.length} متدرب (مدمج)`);

                // تحديث أيقونات Lucide في الـ tooltips الجديدة
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
            // ═══════════════════════════════════════════════════════════
            // عرض عادي (كل متدرب في صف)
            // ═══════════════════════════════════════════════════════════
            else {
                displayTrainees.forEach(trainee => {
                    const scheduleData = getTraineeSchedule(trainee.id);
                    const row = document.createElement('tr');

                    // تحديد ما إذا كان هناك تعارض
                    const hasConflict = hasConflictWithTarget(trainee);
                    if (hasConflict) {
                        row.classList.add('conflict-row');
                    } else if (showTargetSlots) {
                        row.classList.add('available-row');
                    }

                    // بناء خلايا الجدول الأساسية
                    let cells = `
                        <td class="col-id">${index}</td>
                        <td class="col-name trainee-name" title="${trainee.name}\n${trainee.phone || ''}">${trainee.name}</td>
                        <td class="col-dept" title="${trainee.major || ''}">${trainee.major || ''}</td>
                        <td class="col-stat text-contact trainee-id-cell" style="font-size: 0.65rem; cursor: pointer;" data-copy="${trainee.id}" title="انقر مرتين للنسخ">${trainee.id}</td>
                        <td class="col-stat text-credits">${scheduleData.totalCreditHours}</td>
                    `;

                    // إضافة خلايا Timeline للأيام
                    DAYS.forEach(day => {
                        // تجميع جلسات اليوم
                        const daySessions = [];
                        Object.entries(scheduleData.schedule[day] || {}).forEach(([time, data]) => {
                            daySessions.push({
                                time,
                                refNumber: data.refNumber,
                                courseCode: data.courseCode,
                                courseName: data.courseName,
                                trainerName: data.trainerName,
                                scheduleType: data.scheduleType,
                                room: data.room
                            });
                        });
                        cells += createTimelineCell(daySessions, targetSections, showTargetSlots, day);
                    });

                    row.innerHTML = cells;
                    tbody.appendChild(row);
                    index++;
                });

                console.log(`✅ تم عرض ${displayTrainees.length} متدرب (Timeline)`);
            }
        }
        // ═══════════════════════════════════════════════════════════════
        //  Multi-Select Component Functions
        // ═══════════════════════════════════════════════════════════════

        // Toggle dropdown visibility
        function toggleMultiSelect(filterId) {
            const container = document.getElementById(filterId);
            const wasOpen = container.classList.contains('open');

            // Close all other dropdowns
            document.querySelectorAll('.multi-select.open').forEach(el => {
                el.classList.remove('open');
            });

            // Toggle this one
            if (!wasOpen) {
                container.classList.add('open');
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            // لا تغلق القائمة إذا كان النقر على أي عنصر داخل القائمة المنسدلة
            if (e.target.closest('.multi-select-dropdown')) {
                return;
            }
            if (!e.target.closest('.multi-select')) {
                document.querySelectorAll('.multi-select.open').forEach(el => {
                    el.classList.remove('open');
                });
            }
            // إغلاق قائمة الشعب الظاهرة
            if (!e.target.closest('.visible-section-input')) {
                hideVisibleDropdown();
            }
            // إغلاق قائمة الشعب المستهدفة
            if (!e.target.closest('.target-section-input')) {
                hideTargetDropdown();
            }
        });

        // Filter options in multi-select
        function filterMultiSelect(input, filterId) {
            const searchTerm = input.value.toLowerCase();
            const list = document.getElementById(filterId.replace('Filter', 'List'));

            list.querySelectorAll('.multi-select-option').forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Select all options
        function selectAllMulti(filterId) {
            const list = document.getElementById(filterId.replace('Filter', 'List'));
            list.querySelectorAll('input[type="checkbox"]:not(:checked)').forEach(cb => {
                if (cb.closest('.multi-select-option').style.display !== 'none') {
                    cb.checked = true;
                }
            });
            updateMultiSelectState(filterId);
        }

        // Clear all selections
        function clearAllMulti(filterId) {
            const list = document.getElementById(filterId.replace('Filter', 'List'));
            list.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                cb.checked = false;
            });
            updateMultiSelectState(filterId);
        }

        // Update trigger text and count badge
        function updateMultiSelectState(filterId) {
            console.log('🔵 [updateMultiSelectState] بداية التنفيذ، filterId:', filterId);

            const container = document.getElementById(filterId);
            const list = document.getElementById(filterId.replace('Filter', 'List'));
            const trigger = container.querySelector('.multi-select-trigger span:first-child');
            const badge = container.querySelector('.count-badge');

            const checked = list.querySelectorAll('input[type="checkbox"]:checked');
            const count = checked.length;

            console.log('📊 [updateMultiSelectState] checked elements:', checked);
            console.log('📊 [updateMultiSelectState] count:', count);

            if (count === 0) {
                trigger.textContent = 'الكل';
                badge.style.display = 'none';
                console.log('🟡 [updateMultiSelectState] لا توجد اختيارات');
            } else {
                // Get text from the label span with .option-text class
                const firstText = checked[0].closest('label').querySelector('.option-text').textContent;
                trigger.textContent = count === 1 ? firstText : `${count} مختار`;
                badge.textContent = count;
                badge.style.display = 'inline';
                console.log('🟢 [updateMultiSelectState] تم اختيار:', count, 'أول عنصر:', firstText);
            }

            // تحديث الـ class على كل label لعرض علامة الصح بشكل صحيح
            list.querySelectorAll('.multi-select-option').forEach(label => {
                const checkbox = label.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    label.classList.add('checked');
                } else {
                    label.classList.remove('checked');
                }
            });

            // Apply cascading filters
            applyCascadingFilters();
        }

        // ═══════════════════════════════════════════════════════════════
        //  فلاتر متتالية (AND logic) - جميع الشروط يجب أن تتحقق
        // ═══════════════════════════════════════════════════════════════

        // جمع القيم المختارة من فلتر معين
        function getSelectedValues(filterId) {
            const list = document.getElementById(filterId.replace('Filter', 'List'));
            if (!list) return [];
            const checked = list.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checked).map(cb => cb.value);
        }

        // تطبيق الفلاتر المتتالية
        function applyCascadingFilters() {
            // جمع جميع القيم المختارة
            selectedFilters.departments = getSelectedValues('departmentFilter');
            selectedFilters.prefixes = getSelectedValues('prefixFilter');
            selectedFilters.scheduleTypes = getSelectedValues('scheduleTypeFilter');

            console.log('🔍 الفلاتر المطبقة:', selectedFilters);

            // إعادة عرض الجداول
            if (Object.keys(trainers).length > 0) {
                renderTrainersTable();
                renderTraineesTable();
            }
        }

        // التحقق من تطابق الشعبة مع الفلاتر (AND logic)
        function sectionMatchesFilters(section) {
            // إذا لم تُختر أي قيم من فلتر، يُعتبر مطابقاً
            // إذا اختيرت قيم، يجب أن تكون الشعبة ضمنها

            // فلتر القسم
            if (selectedFilters.departments.length > 0) {
                if (!selectedFilters.departments.includes(section.department)) {
                    return false;
                }
            }

            // فلتر رمز المقرر (الحروف فقط)
            if (selectedFilters.prefixes.length > 0) {
                const coursePrefix = (section.courseCode || '').replace(/[-\d]/g, '').trim();
                if (!selectedFilters.prefixes.includes(coursePrefix)) {
                    return false;
                }
            }

            // فلتر نوع الشعبة
            if (selectedFilters.scheduleTypes.length > 0) {
                if (!selectedFilters.scheduleTypes.includes(section.scheduleType)) {
                    return false;
                }
            }

            // كل الفلاتر تطابقت
            return true;
        }

        // Populate multi-select lists
        function populateMultiSelectLists() {
            // Department list
            const deptList = document.getElementById('departmentList');
            if (deptList) {
                deptList.innerHTML = '';
                Array.from(departments).sort().forEach(dept => {
                    deptList.innerHTML += `
                        <label class="multi-select-option" onclick="event.stopPropagation()">
                            <input type="checkbox" value="${dept}" onchange="event.stopPropagation(); updateMultiSelectState('departmentFilter')">
                            <span class="custom-checkbox"></span>
                            <span class="option-text">${dept}</span>
                        </label>`;
                });
            }

            // Course prefix list
            const prefixList = document.getElementById('prefixList');
            if (prefixList) {
                prefixList.innerHTML = '';
                Array.from(coursePrefixes).sort().forEach(prefix => {
                    prefixList.innerHTML += `
                        <label class="multi-select-option" onclick="event.stopPropagation()">
                            <input type="checkbox" value="${prefix}" onchange="event.stopPropagation(); updateMultiSelectState('prefixFilter')">
                            <span class="custom-checkbox"></span>
                            <span class="option-text">${prefix}</span>
                        </label>`;
                });
            }

            // Schedule type list
            const typeList = document.getElementById('scheduleTypeList');
            if (typeList) {
                typeList.innerHTML = '';
                Array.from(scheduleTypes).sort().forEach(type => {
                    typeList.innerHTML += `
                        <label class="multi-select-option" onclick="event.stopPropagation()">
                            <input type="checkbox" value="${type}" onchange="event.stopPropagation(); updateMultiSelectState('scheduleTypeFilter')">
                            <span class="custom-checkbox"></span>
                            <span class="option-text">${type}</span>
                        </label>`;
                });
            }

            console.log(`✅ تم تحديث الفلاتر: ${departments.size} قسم، ${coursePrefixes.size} رمز، ${scheduleTypes.size} نوع`);
        }

        // ═══════════════════════════════════════════════════════════════
        //  Visible Sections - الشعب الظاهرة (تحدد المدربين والمتدربين المعروضين)
        // ═══════════════════════════════════════════════════════════════

        let visibleSections = [];  // أرقام الشعب الظاهرة

        function showVisibleDropdown() {
            const dropdown = document.getElementById('visibleSectionDropdown');
            if (dropdown) {
                dropdown.classList.add('show');
                searchVisibleSections(document.getElementById('visibleSectionSearch').value);
            }
        }

        function hideVisibleDropdown() {
            const dropdown = document.getElementById('visibleSectionDropdown');
            if (dropdown) dropdown.classList.remove('show');
        }

        function searchVisibleSections(searchTerm) {
            const dropdown = document.getElementById('visibleSectionDropdown');
            if (!dropdown) return;

            const term = searchTerm.toLowerCase();

            // Filter sections based on search term
            let filteredSections = Object.values(sections).filter(section => {
                const searchable = `${section.refNumber} ${section.courseCode} ${section.courseName}`.toLowerCase();
                return searchable.includes(term);
            });

            // Sort by enrolled count (descending - most first)
            filteredSections = filteredSections.sort((a, b) => b.enrolled - a.enrolled);

            // Limit to 30 results
            filteredSections = filteredSections.slice(0, 30);

            // Build dropdown HTML
            dropdown.innerHTML = filteredSections.length === 0 ?
                '<div style="padding: 0.5rem; text-align: center; color: var(--text-muted); font-size: 0.7rem;">لا توجد نتائج</div>' :
                filteredSections.map(section => {
                    const typeCode = getTypeCode(section.scheduleType);
                    const sessionBadges = getSessionBadges(section.sessions);
                    const trainerName = section.trainerName ? ` - ${section.trainerName}` : '';

                    // حساب العدد الفعلي من SF01
                    const actualCount = Object.values(trainees).filter(t =>
                        t.registrations.some(r => r.refNum === section.refNumber)
                    ).length;

                    // إذا كان العدد الفعلي أقل، إظهار الفرق
                    const countDisplay = actualCount < section.enrolled
                        ? `<span style="color: #f59e0b;">${actualCount}</span>/${section.enrolled}`
                        : `${section.enrolled}`;

                    return `
                        <div class="section-item" onclick="addVisibleSection('${section.refNumber}')">
                            <div class="section-info">
                                <span class="section-code">${section.refNumber} - ${section.courseCode} ${typeCode}</span>
                                <span class="section-sessions">${sessionBadges}</span>
                                <span class="section-name">${section.courseName}${trainerName}</span>
                            </div>
                            <span class="trainee-badge">${countDisplay}</span>
                        </div>`;
                }).join('');

            if (searchTerm) {
                dropdown.classList.add('show');
            }
        }

        function addVisibleSection(refNumber) {
            if (visibleSections.includes(refNumber)) {
                showToast('الشعبة مضافة مسبقاً', 'info');
                return;
            }

            visibleSections.push(refNumber);

            // إزالة توهج جذب الانتباه عند اختيار شعبة
            removeAttentionGlow();

            updateVisibleChips();
            renderAllData();
            // لا نغلق القائمة - نتركها مفتوحة للاختيار المتعدد
            showToast('تمت إضافة الشعبة', 'success');
            // تحديث عدد المتاحين في chips المستهدفة
            updateTargetChips();
        }

        function removeVisibleSection(refNumber) {
            const index = visibleSections.indexOf(refNumber);
            if (index > -1) {
                visibleSections.splice(index, 1);
                updateVisibleChips();
                renderAllData();
                // تحديث عدد المتاحين في chips المستهدفة
                updateTargetChips();
            }
        }

        // ═══════════════════════════════════════════════════════════════
        //  بحث أوقات الفراغ - Freetime Search (placeholder)
        // ═══════════════════════════════════════════════════════════════
        function showFreetimeDropdown() {
            // TODO: سيتم تنفيذ هذه الدالة لاحقاً
            console.log('showFreetimeDropdown - placeholder');
        }

        function searchFreetimeSlots(searchTerm) {
            // TODO: سيتم تنفيذ هذه الدالة لاحقاً
            console.log('searchFreetimeSlots:', searchTerm);
        }

        function updateVisibleChips() {
            const container = document.getElementById('visibleChipsContainer');
            if (!container) return;

            container.innerHTML = visibleSections.map(refNum => {
                const section = sections[refNum];
                if (!section) return '';

                // إنشاء tooltip تفصيلي
                const sessionsText = section.sessions.map(s => {
                    const dayCode = getDayCode(s.day);
                    const timeStr = formatTimeForDisplay(s.time);
                    return `${dayCode} ${timeStr}`;
                }).join(' | ');

                const tooltipLines = [
                    `📋 الرقم المرجعي: ${refNum}`,
                    `📚 ${section.courseCode} - ${section.courseName}`,
                    `📝 نوع: ${section.scheduleType || '-'}`,
                    `⏰ ${sessionsText}`,
                    section.trainerName ? `👨‍🏫 ${section.trainerName}` : '',
                    `👥 المسجلين: ${section.enrolled}`
                ].filter(Boolean).join('\n');

                return `
                    <div class="section-chip visible" title="${tooltipLines}">
                        <span class="chip-ref">${refNum}</span>
                        <span>${section.courseCode}</span>
                        <span class="chip-count">${section.enrolled}</span>
                        <button class="chip-remove" onclick="removeVisibleSection('${refNum}')">×</button>
                    </div>`;
            }).join('');
        }

        // ═══════════════════════════════════════════════════════════════
        //  Target Section Search Functions - الشعب المستهدفة
        // ═══════════════════════════════════════════════════════════════

        function showTargetDropdown() {
            const dropdown = document.getElementById('targetSectionDropdown');
            if (dropdown) {
                dropdown.classList.add('show');
                searchTargetSections(document.getElementById('targetSectionSearch').value);
            }
        }

        function hideTargetDropdown() {
            const dropdown = document.getElementById('targetSectionDropdown');
            if (dropdown) dropdown.classList.remove('show');
        }

        function searchTargetSections(searchTerm) {
            const dropdown = document.getElementById('targetSectionDropdown');
            if (!dropdown) return;

            const term = searchTerm.toLowerCase();

            // Filter sections based on search term
            let filteredSections = Object.values(sections).filter(section => {
                const searchable = `${section.refNumber} ${section.courseCode} ${section.courseName}`.toLowerCase();
                return searchable.includes(term);
            });

            // Sort by enrolled count (ascending - least first)
            filteredSections = filteredSections.sort((a, b) => a.enrolled - b.enrolled);

            // Limit to 30 results
            filteredSections = filteredSections.slice(0, 30);

            // Build dropdown HTML
            dropdown.innerHTML = filteredSections.length === 0 ?
                '<div style="padding: 0.5rem; text-align: center; color: var(--text-muted); font-size: 0.7rem;">لا توجد نتائج</div>' :
                filteredSections.map(section => {
                    const typeCode = getTypeCode(section.scheduleType);
                    const sessionBadges = getSessionBadges(section.sessions);
                    const trainerName = section.trainerName ? ` - ${section.trainerName}` : '';
                    return `
                        <div class="section-item" onclick="addTargetSection('${section.refNumber}')">
                            <div class="section-info">
                                <span class="section-code">${section.refNumber} - ${section.courseCode} ${typeCode}</span>
                                <span class="section-sessions">${sessionBadges}</span>
                                <span class="section-name">${section.courseName}${trainerName}</span>
                            </div>
                            <span class="trainee-badge">${section.enrolled}</span>
                        </div>`;
                }).join('');

            if (searchTerm) {
                dropdown.classList.add('show');
            }
        }

        function addTargetSection(refNumber) {
            if (targetSections.includes(refNumber)) {
                showToast('الشعبة مضافة مسبقاً', 'info');
                return;
            }

            targetSections.push(refNumber);
            updateTargetChips();
            renderAllData();
            // لا نغلق القائمة - نتركها مفتوحة للاختيار المتعدد
            showToast('تمت إضافة الشعبة المستهدفة', 'success');
        }

        function removeTargetSection(refNumber) {
            const index = targetSections.indexOf(refNumber);
            if (index > -1) {
                targetSections.splice(index, 1);
                updateTargetChips();
                renderAllData();
            }
        }

        function updateTargetChips() {
            const container = document.getElementById('targetChipsContainer');
            if (!container) return;

            container.innerHTML = targetSections.map(refNum => {
                const section = sections[refNum];
                if (!section) return '';

                // حساب عدد المتدربين المتاحين للنقل (من الشعب الظاهرة)
                const availableCount = countAvailableForTarget(refNum);

                // إنشاء tooltip تفصيلي
                const sessionsText = section.sessions.map(s => {
                    const dayCode = getDayCode(s.day);
                    const timeStr = formatTimeForDisplay(s.time);
                    return `${dayCode} ${timeStr}`;
                }).join(' | ');

                const tooltipLines = [
                    `📋 الرقم المرجعي: ${refNum}`,
                    `📚 ${section.courseCode} - ${section.courseName}`,
                    `📝 نوع: ${section.scheduleType || '-'}`,
                    `⏰ ${sessionsText}`,
                    section.trainerName ? `👨‍🏫 ${section.trainerName}` : '',
                    `👥 المسجلين: ${section.enrolled}`,
                    `✅ متاحين للنقل: ${availableCount}`
                ].filter(Boolean).join('\n');

                // عرض عدد المتاحين فقط إذا كانت هناك شعب ظاهرة
                const availableBadge = visibleSections.length > 0
                    ? `<span class="chip-available" title="متاحين للنقل من الشعب الظاهرة">${availableCount}</span>`
                    : '';

                return `
                    <div class="section-chip target" title="${tooltipLines}">
                        <span class="chip-ref">${refNum}</span>
                        <span>${section.courseCode}</span>
                        <span class="chip-count">${section.enrolled}</span>
                        ${availableBadge}
                        <button class="chip-remove" onclick="removeTargetSection('${refNum}')">×</button>
                    </div>`;
            }).join('');
        }

        // ═══════════════════════════════════════════════════════════════
        //  حساب عدد المتدربين المتاحين للنقل لشعبة مستهدفة محددة
        // ═══════════════════════════════════════════════════════════════
        function countAvailableForTarget(targetRefNum) {
            // إذا لم تكن هناك شعب ظاهرة، لا نحسب
            if (visibleSections.length === 0) return 0;

            const targetSection = sections[targetRefNum];
            if (!targetSection) return 0;

            // الحصول على المتدربين من الشعب الظاهرة
            const visibleTrainees = Object.values(trainees).filter(trainee => {
                return trainee.registrations.some(r => visibleSections.includes(r.refNum));
            });

            // حساب المتدربين الذين ليس لديهم تعارض مع هذه الشعبة المستهدفة
            let availableCount = 0;

            visibleTrainees.forEach(trainee => {
                const hasConflict = hasConflictWithSpecificTarget(trainee, targetRefNum);
                if (!hasConflict) {
                    availableCount++;
                }
            });

            return availableCount;
        }

        // التحقق من تعارض متدرب مع شعبة مستهدفة محددة
        function hasConflictWithSpecificTarget(trainee, targetRefNum) {
            const targetSection = sections[targetRefNum];
            if (!targetSection) return false;

            const schedule = getTraineeSchedule(trainee.id);

            for (const targetSession of targetSection.sessions) {
                if (!targetSession.time || !targetSession.day) continue;
                const [targetEnd, targetStart] = targetSession.time.split(' - ');

                // التحقق من وجود جلسة في نفس اليوم والوقت
                const daySchedule = schedule.schedule[targetSession.day] || {};
                for (const [time, data] of Object.entries(daySchedule)) {
                    if (data.refNumber === targetRefNum) continue;
                    const [sEnd, sStart] = time.split(' - ');
                    // تحقق من التداخل الزمني
                    if (!(targetEnd <= sStart || targetStart >= sEnd)) {
                        return true; // يوجد تعارض
                    }
                }
            }
            return false; // لا يوجد تعارض
        }

        // ═══════════════════════════════════════════════════════════════
        //  Cascading Filters
        // ═══════════════════════════════════════════════════════════════

        function getSelectedValues(filterId) {
            const list = document.getElementById(filterId.replace('Filter', 'List'));
            if (!list) return [];
            const checked = list.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checked).map(cb => cb.value);
        }

        function applyCascadingFilters() {
            const selectedDepts = getSelectedValues('departmentFilter');
            const selectedPrefixes = getSelectedValues('prefixFilter');
            const selectedTypes = getSelectedValues('scheduleTypeFilter');

            // Update selectedFilters state
            selectedFilters.departments = selectedDepts;
            selectedFilters.prefixes = selectedPrefixes;
            selectedFilters.scheduleTypes = selectedTypes;

            // Re-render tables with filters
            renderAllData();
        }

        // Check if a section matches current filters
        function sectionMatchesFilters(section) {
            // If no filters selected, show all
            const hasDeptFilter = selectedFilters.departments.length > 0;
            const hasPrefixFilter = selectedFilters.prefixes.length > 0;
            const hasTypeFilter = selectedFilters.scheduleTypes.length > 0;

            if (!hasDeptFilter && !hasPrefixFilter && !hasTypeFilter) {
                return true;
            }

            // Check department
            if (hasDeptFilter && !selectedFilters.departments.includes(section.department)) {
                return false;
            }

            // Check prefix (extract letters from course code)
            if (hasPrefixFilter) {
                const prefix = section.courseCode.replace(/[-\d]/g, '').trim();
                if (!selectedFilters.prefixes.includes(prefix)) {
                    return false;
                }
            }

            // Check schedule type
            if (hasTypeFilter && !selectedFilters.scheduleTypes.includes(section.scheduleType)) {
                return false;
            }

            return true;
        }

        // تم نقل toggleFreeOnly للأعلى مع المتغيرات العامة        // ═══════════════════════════════════════════════════════════════
        //  Populate filters (updated)
        // ═══════════════════════════════════════════════════════════════
        function populateFilters() {
            populateMultiSelectLists();

            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // التهيئة
        initUploadPage();

        // نسخ رقم المتدرب بالنقر المزدوج
        document.addEventListener('dblclick', (e) => {
            const traineeId = e.target.closest('.trainee-id');
            if (traineeId) {
                const id = traineeId.textContent.trim().split('\n')[0].trim();
                navigator.clipboard.writeText(id).then(() => {
                    showToast(`تم نسخ الرقم: ${id}`, 'success');
                });
            }
        });

        // للتجربة: عرض الصفحة الرئيسية مباشرة (اضغط Ctrl+Shift+D)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                uploadPage.style.display = 'none';
                mainPage.style.display = 'flex';
            }
        });

        // ═══════════════════════════════════════════════════════════════
        //  الجولة التفاعلية - Interactive Tour
        // ═══════════════════════════════════════════════════════════════
        const TOUR_STORAGE_KEY = 'tourCompleted';
        let currentTourStep = 0;
        let tourActive = false;

        const tourSteps = [
            {
                selector: '.section-row.visible-row',
                title: 'الشعب الظاهرة',
                description: 'اختر شعبة من هنا لعرض جداول المدربين والمتدربين المسجلين فيها. يمكنك اختيار أكثر من شعبة.',
                position: 'bottom'
            },
            {
                selector: '.section-row.target-row',
                title: 'الشعب المستهدفة',
                description: 'حدد شعبة مستهدفة لمعرفة من يستطيع الانضمام إليها. ستظهر التعارضات بلون مختلف في الجداول.',
                position: 'bottom'
            },
            {
                selector: '.freetime-search-btn',
                title: 'البحث عن موعد',
                description: 'ابحث عن أفضل الأوقات لفتح شعبة جديدة بناءً على فراغات المتدربين والمدربين.',
                position: 'bottom'
            },
            {
                selector: '#freeOnlySwitch',
                title: 'المتاحين فقط',
                description: 'فعّل هذا الخيار لإظهار المتدربين والمدربين المتاحين فقط (بدون تعارضات مع الشعب المستهدفة).',
                position: 'bottom'
            },
            {
                selector: '.table-section:first-of-type',
                title: 'جدول المدربين',
                description: 'هنا تظهر جداول المدربين مع ساعات الاتصال والنصاب. الألوان تدل على نوع الجلسة (نظري/عملي).',
                position: 'bottom'
            },
            {
                selector: '.table-section:last-of-type',
                title: 'جدول المتدربين',
                description: 'هنا تظهر جداول المتدربين مع الساعات المعتمدة. يمكنك استخدام الفلاتر لتصفية القائمة.',
                position: 'top'
            }
        ];

        function startTour() {
            currentTourStep = 0;
            tourActive = true;
            document.getElementById('tourOverlay').classList.add('active');
            document.getElementById('tourTooltip').classList.add('active');
            showTourStep(0);
        }

        function endTour() {
            tourActive = false;
            document.getElementById('tourOverlay').classList.remove('active');
            document.getElementById('tourTooltip').classList.remove('active');
            document.getElementById('tourSpotlight').style.display = 'none';
            localStorage.setItem(TOUR_STORAGE_KEY, 'true');
        }

        function nextTourStep() {
            if (currentTourStep < tourSteps.length - 1) {
                currentTourStep++;
                showTourStep(currentTourStep);
            } else {
                endTour();
                showToast('🎉 أنت جاهز! ابدأ باختيار شعبة من "الشعب الظاهرة"', 'success');
            }
        }

        function prevTourStep() {
            if (currentTourStep > 0) {
                currentTourStep--;
                showTourStep(currentTourStep);
            }
        }

        function showTourStep(stepIndex) {
            const step = tourSteps[stepIndex];
            const element = document.querySelector(step.selector);

            if (!element) {
                console.warn('Tour element not found:', step.selector);
                nextTourStep();
                return;
            }

            // تحديث المحتوى
            document.getElementById('tourStepIndicator').textContent = `الخطوة ${stepIndex + 1} من ${tourSteps.length}`;
            document.getElementById('tourTitle').textContent = step.title;
            document.getElementById('tourDescription').textContent = step.description;

            // تحديث أزرار التنقل
            document.getElementById('tourPrevBtn').style.display = stepIndex === 0 ? 'none' : 'inline-block';
            document.getElementById('tourNextBtn').textContent = stepIndex === tourSteps.length - 1 ? 'إنهاء ✓' : 'التالي ►';

            // تحديد موقع العنصر
            const rect = element.getBoundingClientRect();
            const spotlight = document.getElementById('tourSpotlight');
            const tooltip = document.getElementById('tourTooltip');
            const arrow = document.getElementById('tourArrow');

            // إضاءة العنصر
            spotlight.style.display = 'block';
            spotlight.style.top = (rect.top + window.scrollY - 5) + 'px';
            spotlight.style.left = (rect.left - 5) + 'px';
            spotlight.style.width = (rect.width + 10) + 'px';
            spotlight.style.height = (rect.height + 10) + 'px';

            // إزالة كلاسات السهم السابقة
            arrow.className = 'tour-arrow';

            // تحديد موقع التلميح
            const tooltipWidth = 320;
            const tooltipHeight = 180;
            let tooltipTop, tooltipLeft;

            if (step.position === 'bottom') {
                tooltipTop = rect.bottom + 15;
                tooltipLeft = rect.left + (rect.width / 2) - (tooltipWidth / 2);
                arrow.classList.add('top');
                arrow.style.left = '50%';
                arrow.style.transform = 'translateX(-50%) rotate(45deg)';
            } else if (step.position === 'top') {
                tooltipTop = rect.top - tooltipHeight - 15;
                tooltipLeft = rect.left + (rect.width / 2) - (tooltipWidth / 2);
                arrow.classList.add('bottom');
                arrow.style.left = '50%';
                arrow.style.transform = 'translateX(-50%) rotate(45deg)';
            }

            // التأكد من عدم خروج التلميح من الشاشة
            if (tooltipLeft < 10) tooltipLeft = 10;
            if (tooltipLeft + tooltipWidth > window.innerWidth - 10) {
                tooltipLeft = window.innerWidth - tooltipWidth - 10;
            }
            if (tooltipTop < 10) tooltipTop = rect.bottom + 15;

            tooltip.style.top = tooltipTop + 'px';
            tooltip.style.left = tooltipLeft + 'px';

            // التمرير للعنصر إذا لزم الأمر
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // التحقق من عرض الجولة عند أول استخدام
        function checkFirstTimeTour() {
            const tourCompleted = localStorage.getItem(TOUR_STORAGE_KEY);

            // إذا كانت هذه المرة الأولى، ابدأ الجولة مباشرة
            if (!tourCompleted) {
                setTimeout(() => {
                    startTour();
                }, 500); // تأخير بسيط لضمان تحميل العناصر
            }
        }

    </script>
</body>

</html>