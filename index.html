<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فراغات المتدربين والمدربين</title>

    <!-- Google Fonts - Cairo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* ═══════════════════════════════════════════════════════════════
           المتغيرات والجذر
           ═══════════════════════════════════════════════════════════════ */
        :root {
            /* الألوان الأساسية */
            --bg-primary: #0a0e1a;
            --bg-secondary: #111827;
            --bg-card: rgba(30, 41, 59, 0.7);
            --bg-glass: rgba(255, 255, 255, 0.05);

            /* ألوان النص */
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;

            /* ألوان الأنواع */
            --color-theory: #3b82f6;
            /* نظري - أزرق */
            --color-practical: #10b981;
            /* عملي - أخضر */
            --color-blended: #8b5cf6;
            /* مدمج - بنفسجي */
            --color-self: #6b7280;
            /* ذاتي - رمادي */
            --color-coop: #f59e0b;
            /* تعاوني - برتقالي */

            /* ألوان التفاعل */
            --color-accent: #6366f1;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-target: #fbbf24;
            /* الوقت المستهدف */

            /* التدرجات */
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-header: linear-gradient(90deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);

            /* الظلال */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 20px rgba(99, 102, 241, 0.3);

            /* الحدود */
            --border-color: rgba(255, 255, 255, 0.1);
            --border-radius: 12px;
            --border-radius-sm: 8px;

            /* الخط */
            --font-family: 'Cairo', sans-serif;
        }

        /* ═══════════════════════════════════════════════════════════════
           إعادة التعيين والأساسيات
           ═══════════════════════════════════════════════════════════════ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* الخلفية المتحركة */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(59, 130, 246, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: -1;
        }

        /* ═══════════════════════════════════════════════════════════════
           صفحة الرفع
           ═══════════════════════════════════════════════════════════════ */
        .upload-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .upload-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .upload-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 3rem;
            text-align: center;
        }

        .upload-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
            max-width: 900px;
            width: 100%;
            margin-bottom: 2rem;
        }

        .upload-zone {
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-zone:hover {
            border-color: var(--color-accent);
            background: rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .upload-zone.dragover {
            border-color: var(--color-accent);
            background: rgba(99, 102, 241, 0.15);
        }

        .upload-zone.uploaded {
            border-color: var(--color-success);
            border-style: solid;
        }

        .upload-zone-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .upload-zone-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .upload-zone-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .upload-zone-hint {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .upload-zone-success {
            display: none;
            color: var(--color-success);
            font-weight: 600;
        }

        .upload-zone.uploaded .upload-zone-success {
            display: block;
        }

        .upload-zone.uploaded .upload-zone-hint {
            display: none;
        }

        .upload-progress {
            width: 100%;
            height: 4px;
            background: var(--bg-secondary);
            border-radius: 2px;
            margin-top: 1rem;
            overflow: hidden;
            display: none;
        }

        .upload-progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .upload-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 1rem 3rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: var(--font-family);
            transition: all 0.3s ease;
            opacity: 0.5;
            pointer-events: none;
        }

        .upload-btn.active {
            opacity: 1;
            pointer-events: auto;
        }

        .upload-btn.active:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        /* ═══════════════════════════════════════════════════════════════
           الصفحة الرئيسية
           ═══════════════════════════════════════════════════════════════ */
        .main-page {
            display: none;
            flex-direction: column;
            height: 100vh;
        }

        /* الشريط العلوي - 3 صفوف */
        /* الشريط العلوي - مضغوط للغاية */
        .top-bar {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 0.2rem 0.5rem;
            /* أقل ما يمكن */
        }

        .control-row {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            /* محاذاة لليسار (RTL) */
            padding-bottom: 0.1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            min-height: 24px;
            /* زيادة طفيفة */
        }

        .toggles-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .section-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            min-height: 30px;
        }

        .section-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 280px;
        }

        .vertical-divider {
            width: 1px;
            height: 16px;
            background: var(--border-color);
            margin: 0 0.8rem;
        }

        /* Safe Split Layout Wrapper */
        .split-rows-container {
            display: flex;
            width: 100%;
            gap: 4px;
            margin-bottom: 0.25rem;
        }

        /* Force section rows to share width when inside the wrapper */
        .split-rows-container .section-row {
            flex: 1;
            width: 50%;
            margin-bottom: 0;
            min-width: 0;
            /* Allow shrinking if needed */
        }

        /* Distinct styles for each half */
        .section-row.visible-row {
            background: rgba(30, 41, 59, 0.6) !important;
            border: 1px solid rgba(147, 51, 234, 0.2);
        }

        .section-row.target-row {
            background: rgba(60, 40, 20, 0.4) !important;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        /* Layout Adjustments for condensed width */
        .split-rows-container .section-input-group {
            min-width: auto;
            /* Override default 280px min-width to prevent overflow */
            flex: 1;
        }

        .split-rows-container .section-search-input {
            flex: 1;
        }

        .split-rows-container .section-search-input input {
            width: 100%;
            /* Fill available space */
            min-width: 60px;
        }

        /* الفلاتر */
        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .filter-select {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.3rem 0.6rem;
            border-radius: var(--border-radius-sm);
            font-family: var(--font-family);
            font-size: 0.8rem;
            min-width: 120px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-select:hover,
        .filter-select:focus {
            border-color: var(--color-accent);
            outline: none;
        }

        /* الشعب المختارة (Chips) */
        .chips-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            flex: 1;
        }

        .chips-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .chip {
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid var(--color-accent);
            color: var(--text-primary);
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: chipIn 0.2s ease;
        }

        @keyframes chipIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .chip-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            font-size: 1rem;
            line-height: 1;
            transition: color 0.2s;
        }

        .chip-remove:hover {
            color: var(--color-danger);
        }

        .add-chip-btn {
            background: var(--bg-glass);
            border: 1px dashed var(--border-color);
            color: var(--text-secondary);
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            font-family: var(--font-family);
            transition: all 0.2s ease;
        }

        .add-chip-btn:hover {
            border-color: var(--color-accent);
            color: var(--text-primary);
        }

        /* الشعبة المستهدفة */
        .target-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius-sm);
        }

        .target-icon {
            font-size: 1.2rem;
        }

        .target-label {
            color: var(--color-target);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: auto;
        }

        .toggle-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            /* تكبير الخط (+20%) */
        }

        .toggle {
            position: relative;
            width: 32px;
            /* تكبير العرض (+~20%) */
            height: 16px;
            /* تكبير الارتفاع */
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle.active {
            background: var(--color-accent);
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 12px;
            /* تكبير الكرة */
            height: 12px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle.active::after {
            transform: translateX(16px);
        }

        /* مفتاح الألوان - مضغوط */
        .legend {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.2rem;
            font-size: 0.6rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 8px !important;
            height: 8px !important;
            min-width: 8px;
            min-height: 8px;
            border-radius: 2px;
        }

        /* ═══════════════════════════════════════════════════════════════
           فلاتر الأعمدة (داخل الرؤوس)
           ═══════════════════════════════════════════════════════════════ */
        .th-filter-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
        }

        .column-filter-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .column-filter-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .column-filter-btn.active {
            color: var(--color-accent);
            background: rgba(99, 102, 241, 0.1);
        }

        .column-filter-btn i {
            width: 14px;
            height: 14px;
        }

        .column-filter-dropdown {
            position: fixed;
            /* Fixed to viewport to avoid overflow clipping */
            top: 0;
            left: 0;
            width: 350px;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-lg);
            padding: 0.5rem;
            z-index: 9999;
            /* Very high z-index */
            display: none;
            flex-direction: column;
            gap: 0.5rem;
            animation: fadeIn 0.1s ease-out;
            text-align: right;
        }

        .column-filter-dropdown.show {
            display: flex;
        }

        .column-filter-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .column-filter-search {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.4rem;
            border-radius: 4px;
            font-family: var(--font-family);
            font-size: 0.8rem;
        }

        .column-filter-search:focus {
            border-color: var(--color-accent);
            outline: none;
        }

        .column-filter-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .column-filter-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .column-filter-action-btn i {
            width: 16px;
            height: 16px;
        }

        .btn-select-all:hover {
            color: var(--color-accent);
        }

        .btn-clear-all:hover {
            color: var(--color-danger);
        }

        .column-filter-options {
            max-height: 200px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .column-filter-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.3rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .column-filter-option:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .column-filter-option input[type="checkbox"] {
            accent-color: var(--color-accent);
        }

        .column-filter-option span {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* ═══════════════════════════════════════════════════════════════
           منطقة الجداول - مضغوطة
           ═══════════════════════════════════════════════════════════════ */
        .tables-container {
            flex: 1;
            overflow: hidden;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
        }

        .table-section {
            margin-bottom: 0.3rem;
        }

        /* جدول المدربين - تقليص الارتفاع لإعطاء مساحة أكبر للمتدربين */
        .table-section:first-child .data-table-wrapper {
            max-height: 35vh;
        }

        /* جدول المتدربين - زيادة الارتفاع */
        .table-section:last-child .data-table-wrapper {
            min-height: 55vh;
            max-height: 65vh;
        }

        /* إزالة الصفوف المنفصلة للعناوين - دمجها inline */
        .table-header {
            display: none;
        }

        /* الجدول */
        .data-table-wrapper {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            overflow: auto;
            border: 1px solid var(--border-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        .data-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 600;
            padding: 0.3rem 0.2rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        /* تمييز رؤوس الجداول */
        .trainer-header th {
            background: rgba(30, 58, 138, 0.4) !important;
            /* أزرق غامق */
            border-top: 3px solid #3b82f6;
        }

        .trainee-header th {
            background: rgba(6, 78, 59, 0.4) !important;
            /* أخضر غامق */
            border-top: 3px solid #10b981;
        }

        /* ألوان الأيام - تلوين الأعمدة بالكامل */
        .data-table th.day-header {
            font-weight: 700;
        }

        /* تلوين الأعمدة - باستخدام الكلاسات لضمان الدقة */
        .data-table .day-sun {
            background: rgba(239, 68, 68, 0.15) !important;
            /* الأحد - أحمر */
        }

        .data-table .day-mon {
            background: rgba(249, 115, 22, 0.15) !important;
            /* الإثنين - برتقالي */
        }

        .data-table .day-tue {
            background: rgba(34, 197, 94, 0.15) !important;
            /* الثلاثاء - أخضر */
        }

        .data-table .day-wed {
            background: rgba(59, 130, 246, 0.15) !important;
            /* الأربعاء - أزرق */
        }

        .data-table .day-thu {
            background: rgba(168, 85, 247, 0.15) !important;
            /* الخميس - بنفسجي */
        }

        /* تأثير عند مرور الماوس على العمود (اختياري) */
        .data-table td.day-sun:hover {
            background: rgba(239, 68, 68, 0.25) !important;
        }

        .data-table td.day-mon:hover {
            background: rgba(249, 115, 22, 0.25) !important;
        }

        .data-table td.day-tue:hover {
            background: rgba(34, 197, 94, 0.25) !important;
        }

        .data-table td.day-wed:hover {
            background: rgba(59, 130, 246, 0.25) !important;
        }

        .data-table td.day-thu:hover {
            background: rgba(168, 85, 247, 0.25) !important;
        }


        /* تأثير الـ Hover على الصفوف مع الحفاظ على شفافية الأعمدة */
        /* تأثير الـ Hover على الصفوف مع الحفاظ على شفافية الأعمدة */
        /* تمت إزالة قاعدة position: relative عند hover ونقلها لتكون دائمة */

        .data-table tbody tr:hover td::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.05);
            pointer-events: none;
        }

        .data-table th.time-header {
            font-size: 0.65rem;
            padding: 0.2rem 0.1rem;
            min-width: 32px;
        }

        .data-table td {
            position: relative;
            padding: 0;
            /* إزالة الحشوة تماماً */
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            height: 20px;
            /* تقليل الارتفاع (كان 24) */
        }

        .data-table tbody tr {
            transition: background 0.2s;
        }

        .data-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .data-table tbody tr.trainer-row {
            background: rgba(99, 102, 241, 0.08);
            border-bottom: 2px solid var(--color-accent);
        }

        .data-table tbody tr.separator-row td {
            height: 6px;
            padding: 0;
            background: transparent;
            border: none;
        }

        /* خلايا الأوقات - مضغوطة */
        /* خلايا الأوقات - مضغوطة جداً */
        .time-cell {
            width: 26px;
            height: 16px;
            /* تقليل الارتفاع (كان 18) */
            border-radius: 2px;
            margin: 0 auto;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            font-size: 0.5rem;
            /* تصغير الخط قليلاً */
            line-height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .time-cell.empty {
            background: rgba(255, 255, 255, 0.02);
        }

        .time-cell.theory {
            background: var(--color-theory);
        }

        .time-cell.practical {
            background: var(--color-practical);
        }

        .time-cell.blended {
            background: var(--color-blended);
        }

        .time-cell.target {
            border: 2px solid var(--color-target);
            box-shadow: 0 0 6px rgba(251, 191, 36, 0.5);
        }

        /* إصلاح الخط الأفقي غير المرغوب فيه */
        .day-cell::before,
        div.day-cell::before {
            content: none !important;
            display: none !important;
            width: 0 !important;
            height: 0 !important;
            border: none !important;
            background: transparent !important;
        }

        /* علامة المقرر المجزأ */
        .time-cell.split::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 0 0 0 100%;
            opacity: 0.7;
        }

        /* بالون الشعبة */
        .time-cell .cell-tooltip {
            position: absolute;
            bottom: 100%;
            right: 50%;
            transform: translateX(50%);
            background: var(--bg-card);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
            min-width: 180px;
            z-index: 100;
            box-shadow: var(--shadow-lg);
            display: none;
            text-align: right;
            font-size: 0.7rem;
        }

        .time-cell:hover .cell-tooltip {
            display: block;
        }

        /* خلية رقم المتدرب (مع Tooltip) */
        .trainee-id {
            position: relative;
            cursor: pointer;
            color: var(--color-accent);
            font-weight: 500;
        }

        .trainee-id:hover {
            text-decoration: underline;
        }

        /* ═══════════════════════════════════════════════════════════════
           تنسيق المجموعات المدمجة
           ═══════════════════════════════════════════════════════════════ */
        .merged-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            cursor: pointer;
        }

        .merge-count {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--color-accent);
            background: rgba(99, 102, 241, 0.15);
            min-width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .merge-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            white-space: nowrap;
        }

        /* تمييز صف المجموعة المدمجة */
        .data-table tbody tr.merged-group {
            border-right: 3px solid var(--color-accent);
        }

        .data-table tbody tr.merged-group .merge-count {
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
            }

            50% {
                box-shadow: 0 0 8px 2px rgba(99, 102, 241, 0.6);
            }
        }

        /* البالون */
        .tooltip {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-card);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            min-width: 280px;
            z-index: 100;
            box-shadow: var(--shadow-lg);
            display: none;
            text-align: right;
        }

        .trainee-id:hover .tooltip {
            display: block;
            animation: tooltipIn 0.2s ease;
        }

        @keyframes tooltipIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* أعمدة ثابتة للمحاذاة الصارمة */
        .col-id {
            width: 35px;
            min-width: 35px;
            max-width: 35px;
        }

        .col-name {
            width: 140px;
            min-width: 140px;
            max-width: 140px;
            text-align: right;
            padding-right: 0.5rem;
        }

        /* عمود القسم/التخصص */
        .col-dept {
            width: 80px;
            min-width: 80px;
            max-width: 80px;
            text-align: right;
            padding-right: 0.5rem;
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        /* تنسيق اسم المدرب/المتدرب */
        .trainer-name,
        .trainee-name {
            font-family: 'Cairo', sans-serif;
            font-size: 11px;
            font-weight: 400;
            color: #ffffff;
        }

        .col-stat {
            width: 45px;
            min-width: 45px;
            max-width: 45px;
        }

        .col-stat-wide {
            width: 90px;
            min-width: 90px;
            max-width: 90px;
        }

        /* 45 + 45 */

        /* ألوان البيانات */
        .text-contact {
            color: var(--color-practical);
            font-weight: 700;
        }

        .text-quota {
            color: var(--color-theory);
            font-weight: 700;
        }

        .text-credits {
            color: var(--color-accent);
            font-weight: 700;
        }

        /* شارات الأنواع (من التفضيلات) */
        .type-badge {
            display: inline-block;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: bold;
            margin-right: 2px;
        }

        .type-badge-theory {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        .type-badge-practical {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }

        .type-badge-blended {
            background: rgba(139, 92, 246, 0.2);
            color: #c4b5fd;
        }

        .type-badge-coop {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
        }

        /* تعديلات الجدول */
        .data-table {
            table-layout: fixed;
        }

        /* إجبار المتصفح على احترام العرض */

        /* تنسيق محتوى بالون الشعبة */
        .cell-tooltip-header {
            font-weight: 700;
            margin-bottom: 0.3rem;
            color: var(--color-accent);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.2rem;
            white-space: nowrap;
        }

        .cell-tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 0.1rem;
            color: var(--text-secondary);
        }

        .cell-tooltip-val {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* تنسيق خلية النصاب للمدرب */
        .quota-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.2rem;
            font-size: 0.75rem;
        }

        .quota-contact {
            color: var(--color-accent);
            font-weight: 700;
        }

        .quota-divider {
            color: var(--text-muted);
        }

        .quota-limit {
            color: var(--text-secondary);
        }

        .tooltip-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .tooltip-row:last-child {
            border-bottom: none;
        }

        .tooltip-icon {
            color: var(--text-muted);
            width: 20px;
            text-align: center;
        }

        .tooltip-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .tooltip-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .tooltip-courses {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .course-badge {
            background: rgba(99, 102, 241, 0.2);
            color: var(--color-accent);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        /* ═══════════════════════════════════════════════════════════════
           مفتاح الألوان
           ═══════════════════════════════════════════════════════════════ */
        .legend {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 0.75rem 1rem;
            background: var(--bg-glass);
            border-radius: var(--border-radius-sm);
            margin-right: auto;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* ═══════════════════════════════════════════════════════════════
           التحميل
           ═══════════════════════════════════════════════════════════════ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 26, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-color);
            border-top-color: var(--color-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ═══════════════════════════════════════════════════════════════
           الإشعارات (Toast)
           ═══════════════════════════════════════════════════════════════ */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }

        .toast {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: toastIn 0.3s ease;
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .toast-icon {
            font-size: 1.2rem;
        }

        .toast-message {
            color: var(--text-primary);
        }

        /* ═══════════════════════════════════════════════════════════════
           Timeline Styles - التصميم الجديد
           ═══════════════════════════════════════════════════════════════ */

        /* خلية اليوم (Timeline Container) */
        .day-cell {
            position: relative;
            min-width: 180px;
            height: 40px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            overflow: hidden;
        }

        /* خط الوقت الخلفي */
        .day-cell::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-50%);
        }

        /* شريط المحاضرة */
        .session-bar {
            position: absolute;
            top: 4px;
            bottom: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 500;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            transition: all 0.2s ease;
            cursor: pointer;
            z-index: 1;
        }

        .session-bar:hover {
            transform: scaleY(1.1);
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .session-bar.theory {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .session-bar.practical {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .session-bar.blended {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .session-bar.coop {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        /* الشعبة المختارة - إطار ملون */
        .session-bar.selected {
            box-shadow: 0 0 0 2px var(--selection-color, #6366f1),
                0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* الشعبة المستهدفة - إطار أكثر وضوحاً */
        .session-bar.target {
            box-shadow: 0 0 0 3px var(--color-target),
                0 0 12px var(--color-target),
                0 2px 8px rgba(0, 0, 0, 0.3);
            animation: targetPulse 1.5s ease-in-out infinite;
        }

        @keyframes targetPulse {

            0%,
            100% {
                box-shadow: 0 0 0 3px var(--color-target), 0 0 12px var(--color-target);
            }

            50% {
                box-shadow: 0 0 0 4px var(--color-target), 0 0 20px var(--color-target);
            }
        }

        /* الشعبة الظاهرة (المختارة للعرض) - إطار أزرق مميز */
        .session-bar.visible-highlight {
            box-shadow: 0 0 0 2px #60a5fa,
                0 0 10px rgba(96, 165, 250, 0.6),
                0 2px 8px rgba(0, 0, 0, 0.3);
            transform: scaleY(1.05);
        }

        /* عند تطبيق الاثنين معاً - الشعبة ظاهرة ومستهدفة */
        .session-bar.visible-highlight.target {
            box-shadow: 0 0 0 3px var(--color-target),
                0 0 0 6px #60a5fa,
                0 0 15px var(--color-target),
                0 2px 8px rgba(0, 0, 0, 0.3);
            animation: targetPulse 1.5s ease-in-out infinite;
        }

        /* موضع الشعبة المستهدفة (الفراغ) */
        .target-slot {
            position: absolute;
            top: 4px;
            bottom: 4px;
            border: 2px dashed var(--color-target);
            border-radius: 4px;
            background: rgba(251, 191, 36, 0.15);
            z-index: 0;
        }

        /* صندوق الشعبة المستهدفة - متاح (أخضر/ذهبي) */
        .target-slot.available {
            border: 2px dashed var(--color-target);
            background: rgba(251, 191, 36, 0.2);
            animation: targetSlotPulse 1.5s ease-in-out infinite;
        }

        /* صندوق الشعبة المستهدفة - تعارض (أحمر) - يظهر فوق الشريط */
        .target-slot.conflict {
            border: 3px solid #ef4444;
            background: rgba(239, 68, 68, 0.35);
            animation: conflictPulse 1s ease-in-out infinite;
            z-index: 5;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
        }

        @keyframes targetSlotPulse {

            0%,
            100% {
                background: rgba(251, 191, 36, 0.15);
            }

            50% {
                background: rgba(251, 191, 36, 0.3);
            }
        }

        @keyframes conflictPulse {

            0%,
            100% {
                background: rgba(239, 68, 68, 0.2);
            }

            50% {
                background: rgba(239, 68, 68, 0.4);
            }
        }

        /* صناديق الفراغات المشتركة - أخضر متوهج */
        .free-slot {
            position: absolute;
            top: 2px;
            bottom: 2px;
            border: 2px dashed #22c55e;
            border-radius: 4px;
            background: rgba(34, 197, 94, 0.2);
            animation: freeSlotPulse 1.5s ease-in-out infinite;
            z-index: 1;
            pointer-events: auto;
            cursor: help;
        }

        .free-slot:hover {
            background: rgba(34, 197, 94, 0.35);
            border-style: solid;
        }

        @keyframes freeSlotPulse {

            0%,
            100% {
                background: rgba(34, 197, 94, 0.15);
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
            }

            50% {
                background: rgba(34, 197, 94, 0.3);
                box-shadow: 0 0 8px 2px rgba(34, 197, 94, 0.5);
            }
        }

        /* صفوف المتدربين المتاحين */
        .data-table tbody tr.available-row {
            background: rgba(34, 197, 94, 0.08);
        }

        .data-table tbody tr.available-row:hover {
            background: rgba(34, 197, 94, 0.15);
        }

        /* صفوف المتدربين المتعارضين */
        .data-table tbody tr.conflict-row {
            background: rgba(239, 68, 68, 0.08);
        }

        .data-table tbody tr.conflict-row:hover {
            background: rgba(239, 68, 68, 0.15);
        }

        /* ألوان الشعب المختارة */
        .selection-color-1 {
            --selection-color: #6366f1;
        }

        .selection-color-2 {
            --selection-color: #ec4899;
        }

        .selection-color-3 {
            --selection-color: #14b8a6;
        }

        .selection-color-4 {
            --selection-color: #f97316;
        }

        .selection-color-5 {
            --selection-color: #84cc16;
        }

        /* رؤوس الجدول الثابتة */
        .data-table thead {
            position: sticky;
            top: 0;
            z-index: 20;
            background: var(--bg-secondary);
        }

        /* الأعمدة الثابتة */
        .data-table .col-id,
        .data-table .col-name,
        .data-table .col-dept,
        .data-table .col-stat {
            position: sticky;
            background: var(--bg-secondary);
            z-index: 15;
        }

        .data-table .col-id {
            left: 0;
        }

        .data-table .col-name {
            left: 40px;
        }

        .data-table .col-dept {
            left: 220px;
            /* 40 + 180 */
        }

        .data-table .col-stat {
            left: 320px;
            /* 40 + 180 + 100 */
        }

        /* التمرير الأفقي */
        .data-table-wrapper {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 400px;
        }

        /* عرض أعمدة الأيام */
        .day-column {
            min-width: 180px;
            text-align: center;
            padding: 4px;
        }

        /* Tooltip للمحاضرات */
        .session-bar[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            border-radius: 6px;
            white-space: pre-line;
            font-size: 0.7rem;
            z-index: 100;
            pointer-events: none;
        }

        /* ═══════════════════════════════════════════════════════════════
           Multi-Select Component - مكون الاختيار المتعدد
           ═══════════════════════════════════════════════════════════════ */

        .multi-select {
            position: relative;
            min-width: 150px;
        }

        .multi-select-trigger {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .multi-select-trigger:hover {
            border-color: var(--color-accent);
        }

        .multi-select-trigger .count-badge {
            background: var(--color-accent);
            color: white;
            font-size: 0.7rem;
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* Dropdown is the highest */
        .multi-select-dropdown {
            z-index: 9999 !important;
            position: absolute;
            top: 100%;
            right: 0;
            /* Align to right for RTL */
            left: auto;
            min-width: 200px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-lg);
            display: none;
            max-height: 250px;
            overflow: hidden;
            font-size: 0.8rem;
        }

        .multi-select.open .multi-select-dropdown {
            display: block;
        }

        .multi-select-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .multi-select-search {
            flex: 1;
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.4rem 0.6rem;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .multi-select-search:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .multi-select-actions {
            display: flex;
            gap: 0.25rem;
        }

        .multi-select-actions button {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.3rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .multi-select-actions button:hover {
            background: var(--bg-glass);
            color: var(--color-accent);
        }

        .multi-select-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .multi-select-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .multi-select-option:hover {
            background: var(--bg-glass);
        }

        .multi-select-option.selected {
            background: rgba(99, 102, 241, 0.15);
        }

        .multi-select-option input {
            accent-color: var(--color-accent);
        }

        .multi-select-option .trainee-count {
            margin-right: auto;
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bg-glass);
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
        }

        /* ═══════════════════════════════════════════════════════════════
           Section Search Input - قائمة البحث عن الشعب (مشتركة)
           ═══════════════════════════════════════════════════════════════ */
        .section-search-input {
            position: relative;
            min-width: 160px;
        }

        .section-search-input input {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: 0.3rem 0.5rem;
            color: var(--text-primary);
            font-size: 0.75rem;
            font-family: var(--font-family);
        }

        .section-search-input input:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        /* الشعب الظاهرة - لون أزرق */
        .visible-section-input input {
            border-color: var(--color-accent);
        }

        .visible-section-input input:focus {
            box-shadow: 0 0 8px rgba(99, 102, 241, 0.3);
        }

        /* الشعب المستهدفة - لون ذهبي */
        .target-section-input input {
            border-color: var(--color-target);
        }

        .target-section-input input:focus {
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.3);
        }

        /* القائمة المنسدلة المشتركة */
        .section-search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            min-width: 280px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            font-size: 0.7rem;
        }

        .section-search-dropdown.show {
            display: block;
        }

        /* عناصر القائمة المنسدلة */
        .section-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.4rem 0.5rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s ease;
            font-size: 0.7rem;
        }

        .section-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .section-item:last-child {
            border-bottom: none;
        }

        .section-item .section-info {
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
        }

        .section-item .section-code {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.7rem;
        }

        .section-item .section-name {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }

        .section-item .trainee-badge {
            background: var(--color-accent);
            color: white;
            font-weight: 600;
            padding: 0.1rem 0.3rem;
            border-radius: 4px;
            font-size: 0.65rem;
        }

        /* Target dropdown specific */
        .target-section-dropdown .section-item:hover {
            background: rgba(251, 191, 36, 0.1);
        }

        .target-section-dropdown .section-item .trainee-badge {
            background: var(--color-target);
            color: #000;
        }

        /* ═══════════════════════════════════════════════════════════════
           Section Chips Inline - الشعب المختارة في نفس الصف
           ═══════════════════════════════════════════════════════════════ */
        .section-chips-inline {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            align-items: center;
        }

        .section-chip {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.2rem 0.4rem 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.65rem;
            animation: chipIn 0.2s ease;
        }

        /* الشعب الظاهرة - أزرق */
        .section-chip.visible {
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid var(--color-accent);
            color: var(--text-primary);
        }

        /* الشعب المستهدفة - ذهبي */
        .section-chip.target {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid var(--color-target);
            color: var(--text-primary);
        }

        .section-chip .chip-count {
            font-weight: 600;
            padding: 0.05rem 0.25rem;
            border-radius: 8px;
            font-size: 0.6rem;
        }

        .section-chip.visible .chip-count {
            background: var(--color-accent);
            color: white;
        }

        .section-chip.target .chip-count {
            background: var(--color-target);
            color: #000;
        }

        /* عدد المتدربين المتاحين للنقل - دائرة زرقاء متوهجة */
        .section-chip.target .chip-available {
            font-weight: 700;
            padding: 0.1rem 0.35rem;
            border-radius: 10px;
            font-size: 0.65rem;
            background: var(--color-accent);
            color: white;
            margin-right: 2px;
            animation: availablePulse 1.5s ease-in-out infinite;
            cursor: help;
        }

        @keyframes availablePulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
            }

            50% {
                box-shadow: 0 0 8px 3px rgba(99, 102, 241, 0.6);
            }
        }

        .section-chip .chip-ref {
            font-size: 0.55rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .section-chip .chip-remove {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            font-size: 0.8rem;
            line-height: 1;
        }

        .section-chip .chip-remove:hover {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        /* الفاصل بين الأقسام */
        .filter-divider {
            width: 1px;
            height: 24px;
            background: var(--border-color);
            margin: 0 0.5rem;
        }

        /* Target Chips - الشعب المستهدفة */
        .target-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        /* Multi-select List Items */
        .multi-select-list {
            max-height: 200px;
            overflow-y: auto;
            padding: 0.5rem 0;
        }

        /* تصميم مربع الاختيار المخصص - يعمل في كل المتصفحات */
        .multi-select-option {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.5rem 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
            color: var(--text-primary);
            position: relative;
        }

        .multi-select-option:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        /* إخفاء الـ checkbox الأصلي */
        .multi-select-option input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
            margin: 0;
            padding: 0;
        }

        /* مربع الاختيار المخصص */
        .custom-checkbox {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border: 2px solid var(--text-secondary);
            border-radius: 4px;
            background-color: transparent;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        /* حالة التحديد - الخلفية */
        .multi-select-option input[type="checkbox"]:checked+.custom-checkbox,
        .multi-select-option.checked .custom-checkbox {
            background-color: var(--color-accent);
            border-color: var(--color-accent);
        }

        /* علامة الصح */
        .multi-select-option input[type="checkbox"]:checked+.custom-checkbox::after,
        .multi-select-option.checked .custom-checkbox::after {
            content: '';
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
            margin-bottom: 2px;
        }

        /* تأثير عند المرور */
        .multi-select-option:hover .custom-checkbox {
            border-color: var(--color-accent);
        }

        /* نص الخيار */
        .option-text {
            flex: 1;
        }

        .target-chip {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid var(--color-target);
            border-radius: 20px;
            padding: 0.3rem 0.6rem 0.3rem 0.8rem;
            font-size: 0.8rem;
            animation: chipIn 0.2s ease;
        }

        @keyframes chipIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .target-chip .chip-count {
            background: var(--color-target);
            color: #000;
            font-weight: 600;
            padding: 0.1rem 0.35rem;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .target-chip .chip-remove {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.1rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .target-chip .chip-remove:hover {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .btn-home {
            background: rgba(99, 102, 241, 0.15);
            color: var(--color-accent);
            border: 1px solid var(--color-accent);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 1rem;
        }

        .btn-home:hover {
            background: var(--color-accent);
            color: white;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.4);
        }

        .btn-home i {
            width: 18px;
            height: 18px;
        }

        .top-bar {
            position: relative;
            z-index: 500;
            /* الحل الجذري: رفع الحاوية بالكامل */
            background: var(--bg-primary);
            /* ضمان خلفية للمنع الشفافية */
        }

        /* Filter Row Layout - Compact with ULTIMATE z-index fix */
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.75rem;
            padding: 0.4rem 0.75rem;
            background: var(--bg-card);
            border-radius: var(--border-radius-sm);
            margin-bottom: 0.25rem;
            position: relative;
            z-index: 50;
            /* الصفوف العادية */
        }

        /* الصف الأول (الفلاتر) يجب أن يكون أعلى من الصف الثاني */
        .top-bar>.filter-row:first-child,
        .filter-row:nth-child(1) {
            z-index: 60 !important;
        }

        /* منطقة الجداول تحت الفلاتر بشكل نهائي */
        .tables-container,
        .table-section,
        .data-table-wrapper {
            position: relative;
            z-index: 1 !important;
        }

        /* Multi-select container needs high z-index */
        .multi-select {
            position: relative;
            z-index: 999 !important;
        }

        /* Dropdown is the highest */
        .multi-select-dropdown {
            z-index: 9999 !important;
        }

        .filter-section {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 0.4rem;
        }

        .filter-section-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* تنسيق الصف العلوي */
        .control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .toggles-group {
            display: flex;
            gap: 1rem;
        }
    </style>
</head>

<body>
    <!-- ═══════════════════════════════════════════════════════════════
         صفحة رفع الملفات
         ═══════════════════════════════════════════════════════════════ -->
    <div class="upload-page" id="uploadPage">
        <h1 class="upload-title">فراغات المتدربين والمدربين</h1>
        <p class="upload-subtitle">قم برفع ملفات البيانات للبدء في التحليل</p>

        <div class="upload-container">
            <!-- ملف SS01 -->
            <div class="upload-zone" id="ss01Zone" data-file="ss01">
                <div class="upload-zone-icon">📅</div>
                <div class="upload-zone-title">ملف SS01</div>
                <div class="upload-zone-desc">جدول الوحدة التدريبية (طولي)</div>
                <div class="upload-zone-hint">اسحب وأفلت الملف هنا أو انقر للاختيار</div>
                <div class="upload-zone-success">✓ تم الرفع بنجاح</div>
                <div class="upload-progress">
                    <div class="upload-progress-bar"></div>
                </div>
            </div>

            <!-- ملف SF01 -->
            <div class="upload-zone" id="sf01Zone" data-file="sf01">
                <div class="upload-zone-icon">📋</div>
                <div class="upload-zone-title">ملف SF01</div>
                <div class="upload-zone-desc">تسجيل المقررات</div>
                <div class="upload-zone-hint">اسحب وأفلت الملف هنا أو انقر للاختيار</div>
                <div class="upload-zone-success">✓ تم الرفع بنجاح</div>
                <div class="upload-progress">
                    <div class="upload-progress-bar"></div>
                </div>
            </div>
        </div>

        <button class="upload-btn" id="startBtn">ابدأ التحليل</button>

        <input type="file" id="fileInput" accept=".csv" hidden>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         الصفحة الرئيسية
         ═══════════════════════════════════════════════════════════════ -->
    <div class="main-page" id="mainPage">
        <!-- الشريط العلوي -->
        <div class="top-bar">
            <!-- الصف الأول: أدوات التحكم والمفتاح -->
            <div class="control-row">
                <!-- زر العودة للرئيسية -->
                <button class="btn-home" onclick="goToUploadPage()" title="العودة للرئيسية">
                    <i data-lucide="home"></i>
                </button>

                <!-- مجموعة التبديل (يمين) -->
                <div class="toggles-group">
                    <div class="toggle-container">
                        <div class="toggle" id="freeSlotsToggle" onclick="toggleFreeSlots()"></div>
                        <span class="toggle-label">تحديد الفراغات</span>
                    </div>
                    <div class="toggle-container">
                        <div class="toggle" id="mergeIdenticalToggle" onclick="toggleMergeIdentical()"></div>
                        <span class="toggle-label">دمج المتطابقين</span>
                    </div>
                    <div class="toggle-container">
                        <div class="toggle" id="freeOnlySwitch" onclick="toggleFreeOnly()"></div>
                        <span class="toggle-label">المتاحين فقط</span>
                    </div>
                </div>
            </div>

            <!-- الصف المقسم: الشعب الظاهرة والمستهدفة -->
            <div class="split-rows-container">
                <!-- النصف الأيمن: الشعب الظاهرة -->
                <div class="section-row visible-row">
                    <div class="section-input-group">
                        <span class="filter-section-label">📋 الشعب الظاهرة</span>
                        <div class="section-search-input visible-section-input">
                            <input type="text" id="visibleSectionSearch" placeholder="ابحث عن شعبة..."
                                oninput="searchVisibleSections(this.value)" onfocus="showVisibleDropdown()"
                                autocomplete="off">
                            <div class="section-search-dropdown" id="visibleSectionDropdown"></div>
                        </div>
                    </div>
                    <div class="section-chips-inline" id="visibleChipsContainer"></div>
                </div>

                <!-- النصف الأيسر: الشعب المستهدفة -->
                <div class="section-row target-row">
                    <div class="section-input-group">
                        <span class="filter-section-label">🎯 الشعب المستهدفة</span>
                        <div class="section-search-input target-section-input">
                            <input type="text" id="targetSectionSearch" placeholder="ابحث..."
                                oninput="searchTargetSections(this.value)" onfocus="showTargetDropdown()"
                                autocomplete="off">
                            <div class="section-search-dropdown target-section-dropdown" id="targetSectionDropdown">
                            </div>
                        </div>
                    </div>
                    <div class="section-chips-inline" id="targetChipsContainer"></div>
                </div>
            </div>
        </div>

        <!-- منطقة الجداول -->
        <div class="tables-container">
            <!-- جدول المدربين -->
            <div class="table-section">
                <div class="table-header">
                    <span class="table-icon">👨‍🏫</span>
                    <span class="table-title">المدربين</span>
                    <span class="table-count">2 مدرب</span>
                </div>

                <div class="data-table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th rowspan="2" class="col-id">#</th>
                                <th rowspan="2" class="col-name">المدرب</th>
                                <th rowspan="2" class="col-stat text-contact">اتصال</th>
                                <th rowspan="2" class="col-stat text-quota">نصاب</th>
                                <th class="day-header day-sun" colspan="4">الأحد</th>
                                <th class="day-header" colspan="4">الاثنين</th>
                                <th class="day-header" colspan="4">الثلاثاء</th>
                                <th class="day-header" colspan="4">الأربعاء</th>
                                <th class="day-header" colspan="4">الخميس</th>
                            </tr>
                            <tr>
                                <!-- الأحد -->
                                <th class="time-header">7:30</th>
                                <th class="time-header">9:15</th>
                                <th class="time-header">10:55</th>
                                <th class="time-header">12:40</th>
                                <!-- الاثنين -->
                                <th class="time-header">7:30</th>
                                <th class="time-header">9:15</th>
                                <th class="time-header">10:55</th>
                                <th class="time-header">12:40</th>
                                <!-- الثلاثاء -->
                                <th class="time-header">7:30</th>
                                <th class="time-header">9:15</th>
                                <th class="time-header">10:55</th>
                                <th class="time-header">12:40</th>
                                <!-- الأربعاء -->
                                <th class="time-header">7:30</th>
                                <th class="time-header">9:15</th>
                                <th class="time-header">10:55</th>
                                <th class="time-header">12:40</th>
                                <!-- الخميس -->
                                <th class="time-header">7:30</th>
                                <th class="time-header">9:15</th>
                                <th class="time-header">10:55</th>
                                <th class="time-header">12:40</th>
                            </tr>
                        </thead>
                        <tbody>
                            <td>1</td>
                            <td class="col-name">محمد يوسف الشبيلي</td>
                            <td class="text-contact">16</td>
                            <td class="text-quota">18</td>
                            <!-- الأحد -->
                            <td>
                                <div class="time-cell theory split">
                                    <div class="cell-tooltip">
                                        <div class="cell-tooltip-header">14894 - صيانة النظم</div>
                                        <div class="cell-tooltip-row"><span>النوع</span><span
                                                class="cell-tooltip-val">نظري</span></div>
                                        <div class="cell-tooltip-row"><span>القاعة</span><span
                                                class="cell-tooltip-val">A-101</span></div>
                                        <div class="cell-tooltip-row"><span>المسجلين</span><span
                                                class="cell-tooltip-val">24</span></div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="time-cell practical"></div>
                            </td>
                            <td>
                                <div class="time-cell empty"></div>
                            </td>
                            <td>
                                <div class="time-cell empty"></div>
                            </td>
                            <!-- الاثنين -->
                            <td>
                                <div class="time-cell practical"></div>
                            </td>
                            <td>
                                <div class="time-cell practical"></div>
                            </td>
                            <td>
                                <div class="time-cell theory target"></div>
                            </td>
                            <td>
                                <div class="time-cell empty"></div>
                            </td>
                            <!-- الثلاثاء -->
                            <td>
                                <div class="time-cell theory"></div>
                            </td>
                            <td>
                                <div class="time-cell practical"></div>
                            </td>
                            <td>
                                <div class="time-cell blended split">
                                    <div class="cell-tooltip">
                                        <div class="cell-tooltip-header">14905 - الآلات الدوارة</div>
                                        <div class="cell-tooltip-row"><span>النوع</span><span
                                                class="cell-tooltip-val">مدمج</span></div>
                                        <div class="cell-tooltip-row"><span>جزء</span><span
                                                class="cell-tooltip-val">2/2</span></div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="time-cell empty"></div>
                            </td>
                            <!-- الأربعاء -->
                            <td>
                                <div class="time-cell empty"></div>
                            </td>
                            <td>
                                <div class="time-cell practical"></div>
                            </td>
                            <td>
                                <div class="time-cell practical"></div>
                            </td>
                            <td>
                                <div class="time-cell empty"></div>
                            </td>
                            <!-- الخميس -->
                            <td>
                                <div class="time-cell theory"></div>
                            </td>
                            <td>
                                <div class="time-cell practical"></div>
                            </td>
                            <td>
                                <div class="time-cell practical"></div>
                            </td>
                            <td>
                                <div class="time-cell empty"></div>
                            </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- جدول المتدربين -->
            <div class="table-section">
                <div class="table-header">
                    <span class="table-icon">👨‍🎓</span>
                    <span class="table-title">المتدربين</span>
                    <span class="table-count">15 متدرب</span>
                </div>

                <div class="data-table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th rowspan="2" class="col-id">#</th>
                                <th rowspan="2" class="col-name">المتدرب</th>
                                <th rowspan="2" class="col-stat text-contact">الرقم</th>
                                <th rowspan="2" class="col-stat text-credits">س معتمدة</th>
                                <th class="day-header day-sun" colspan="4">الأحد</th>
                                <th class="day-header day-mon" colspan="4">الاثنين</th>
                                <th class="day-header day-tue" colspan="4">الثلاثاء</th>
                                <th class="day-header day-wed" colspan="4">الأربعاء</th>
                                <th class="day-header day-thu" colspan="4">الخميس</th>
                            </tr>
                            <tr>
                                <!-- الأحد -->
                                <th class="time-header">7:30</th>
                                <th class="time-header">9:15</th>
                                <th class="time-header">10:55</th>
                                <th class="time-header">12:40</th>
                                <!-- الاثنين -->
                                <th class="time-header">7:30</th>
                                <th class="time-header">9:15</th>
                                <th class="time-header">10:55</th>
                                <th class="time-header">12:40</th>
                                <!-- الثلاثاء -->
                                <th class="time-header">7:30</th>
                                <th class="time-header">9:15</th>
                                <th class="time-header">10:55</th>
                                <th class="time-header">12:40</th>
                                <!-- الأربعاء -->
                                <th class="time-header">7:30</th>
                                <th class="time-header">9:15</th>
                                <th class="time-header">10:55</th>
                                <th class="time-header">12:40</th>
                                <!-- الخميس -->
                                <th class="time-header">7:30</th>
                                <th class="time-header">9:15</th>
                                <th class="time-header">10:55</th>
                                <th class="time-header">12:40</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td class="col-name">
                                    <span class="trainee-id">
                                        444117138
                                        <div class="tooltip">
                                            <div class="tooltip-row">
                                                <span class="tooltip-icon">👤</span>
                                                <div>
                                                    <div class="tooltip-label">الاسم</div>
                                                    <div class="tooltip-value">فيصل يوسف العبدالجبار</div>
                                                </div>
                                            </div>
                                            <div class="tooltip-row">
                                                <span class="tooltip-icon">🎓</span>
                                                <div>
                                                    <div class="tooltip-label">التخصص</div>
                                                    <div class="tooltip-value">تقنية الصيانة الميكانيكية</div>
                                                </div>
                                            </div>
                                            <div class="tooltip-row">
                                                <span class="tooltip-icon">📱</span>
                                                <div>
                                                    <div class="tooltip-label">الجوال</div>
                                                    <div class="tooltip-value">05xxxxxxxx</div>
                                                </div>
                                            </div>
                                            <div class="tooltip-row">
                                                <span class="tooltip-icon">📚</span>
                                                <div>
                                                    <div class="tooltip-label">المقررات</div>
                                                    <div class="tooltip-courses">
                                                        <span class="course-badge">صيانة النظم</span>
                                                        <span class="course-badge">الآلات الدوارة</span>
                                                        <span class="course-badge">الرسم الهندسي</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="tooltip-row">
                                                <span class="tooltip-icon">⏱️</span>
                                                <div>
                                                    <div class="tooltip-label">الساعات المعتمدة</div>
                                                    <div class="tooltip-value">16 ساعة</div>
                                                </div>
                                            </div>
                                        </div>
                                    </span>
                                </td>
                                <td class="text-credits">16</td>
                                <!-- الأحد -->
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <!-- الاثنين -->
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty target"></div>
                                </td>
                                <td>
                                    <div class="time-cell theory"></div>
                                </td>
                                <!-- الثلاثاء -->
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <!-- الأربعاء -->
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <!-- الخميس -->
                                <td>
                                    <div class="time-cell theory"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td class="col-name">
                                    <span class="trainee-id">444117587</span>
                                </td>
                                <td class="text-credits">20</td>
                                <!-- الأحد -->
                                <td>
                                    <div class="time-cell theory"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <!-- الاثنين -->
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical target"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <!-- الثلاثاء -->
                                <td>
                                    <div class="time-cell theory"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell blended"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <!-- الأربعاء -->
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <!-- الخميس -->
                                <td>
                                    <div class="time-cell theory"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                            </tr>
                            <tr>
                                <td>3</td>
                                <td class="col-name">
                                    <span class="trainee-id">444117670</span>
                                </td>
                                <td class="text-credits">15</td>
                                <!-- الأحد -->
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell theory"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <!-- الاثنين -->
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty target"></div>
                                </td>
                                <td>
                                    <div class="time-cell theory"></div>
                                </td>
                                <!-- الثلاثاء -->
                                <td>
                                    <div class="time-cell theory"></div>
                                </td>
                                <td>
                                    <div class="time-cell theory"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <!-- الأربعاء -->
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                                <!-- الخميس -->
                                <td>
                                    <div class="time-cell theory"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell practical"></div>
                                </td>
                                <td>
                                    <div class="time-cell empty"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- شاشة التحميل -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- الإشعارات -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ═══════════════════════════════════════════════════════════════
         JavaScript - التفاعلات الأساسية
         ═══════════════════════════════════════════════════════════════ -->
    <script>
        // المتغيرات
        let uploadedFiles = { ss01: null, sf01: null };
        let currentZone = null;
        let showFreeOnly = false; // إظهار المتدربين المتاحين فقط

        // فلاتر الأعمدة
        let columnFilters = {
            trainer: { name: [], dept: [] },
            trainee: { name: [], major: [] }
        };

        // العناصر
        const uploadPage = document.getElementById('uploadPage');
        const mainPage = document.getElementById('mainPage');
        const startBtn = document.getElementById('startBtn');
        const fileInput = document.getElementById('fileInput');
        const ss01Zone = document.getElementById('ss01Zone');
        const sf01Zone = document.getElementById('sf01Zone');
        // Removed old toggle reference

        // تبديل عرض المتاحين فقط
        function toggleFreeOnly() {
            // تبديل الحالة
            showFreeOnly = !showFreeOnly;
            updateFreeOnlyUI();

            // إعادة عرض الجدول
            renderTraineesTable();

            // إشعار المستخدم
            if (showFreeOnly) {
                showToast('🟢 عرض المتدربين المتاحين فقط', 'success');
            } else {
                showToast('عرض جميع المتدربين', 'info');
            }
            console.log('showFreeOnly changed to:', showFreeOnly);
        }

        function updateFreeOnlyUI() {
            const toggle = document.getElementById('freeOnlySwitch');
            if (toggle) {
                if (showFreeOnly) {
                    toggle.classList.add('active');
                } else {
                    toggle.classList.remove('active');
                }
            }
        }

        // ═══════════════════════════════════════════════════════════════
        //  دمج المتطابقين - تجميع المتدربين بنفس الشعب
        // ═══════════════════════════════════════════════════════════════
        let mergeIdentical = false;

        // تبديل وضع دمج المتطابقين
        function toggleMergeIdentical() {
            mergeIdentical = !mergeIdentical;
            updateMergeIdenticalUI();

            renderTraineesTable();

            if (mergeIdentical) {
                showToast('🔗 تم دمج المتدربين المتطابقين', 'success');
            } else {
                showToast('عرض كل متدرب في صف منفصل', 'info');
            }
        }

        function updateMergeIdenticalUI() {
            const toggle = document.getElementById('mergeIdenticalToggle');
            if (toggle) {
                if (mergeIdentical) {
                    toggle.classList.add('active');
                } else {
                    toggle.classList.remove('active');
                }
            }
        }

        // الحصول على مفتاح التجميع للمتدرب (الأرقام المرجعية مرتبة)
        function getTraineeGroupKey(trainee) {
            if (!trainee.registrations || trainee.registrations.length === 0) {
                return '';
            }
            // ترتيب الأرقام المرجعية وتحويلها لمفتاح نصي
            return [...trainee.registrations].map(r => r.refNum).sort().join(',');
        }

        // تجميع المتدربين المتطابقين
        function groupIdenticalTrainees(traineesArray) {
            const groups = {};

            traineesArray.forEach(trainee => {
                const key = getTraineeGroupKey(trainee);
                if (!groups[key]) {
                    groups[key] = {
                        key: key,
                        trainees: [],
                        registrations: trainee.registrations || [],
                        // سنستخدم جدول أول متدرب كممثل للمجموعة
                        representativeId: trainee.id
                    };
                }
                groups[key].trainees.push(trainee);
            });

            // تحويل لمصفوفة وترتيب حسب عدد المتدربين (الأكبر أولاً)
            return Object.values(groups).sort((a, b) => b.trainees.length - a.trainees.length);
        }

        // ═══════════════════════════════════════════════════════════════
        //  تحديد الفراغات المشتركة
        // ═══════════════════════════════════════════════════════════════
        let showFreeSlots = false;
        const END_OF_DAY = 15 * 60; // 15:00 = 900 دقيقة
        const MIN_FREE_SLOT = 50; // الحد الأدنى للفراغ بالدقائق

        // تبديل وضع تحديد الفراغات
        function toggleFreeSlots() {
            showFreeSlots = !showFreeSlots;
            updateFreeSlotsUI();

            // إعادة عرض الجداول
            renderAllData();

            if (showFreeSlots) {
                showToast('🟢 تحديد الفراغات المشتركة', 'success');
            } else {
                showToast('إخفاء الفراغات', 'info');
            }
        }

        function updateFreeSlotsUI() {
            const toggle = document.getElementById('freeSlotsToggle');
            if (toggle) {
                if (showFreeSlots) {
                    toggle.classList.add('active');
                } else {
                    toggle.classList.remove('active');
                }
            }
        }

        // حساب الفراغات المشتركة لجميع المتدربين والمدربين (من الشعب الظاهرة)
        function calculateSharedFreeSlots() {
            if (visibleSections.length === 0) return {};

            // تجميع جميع المحاضرات لكل يوم
            const allBusySlots = {};
            DAYS.forEach(day => allBusySlots[day] = []);

            // جمع محاضرات المتدربين من الشعب الظاهرة
            Object.values(trainees).forEach(trainee => {
                // تحقق من أن المتدرب مسجل في إحدى الشعب الظاهرة
                const hasVisibleSection = trainee.registrations.some(r => visibleSections.includes(r.refNum));
                if (!hasVisibleSection) return;

                const schedule = getTraineeSchedule(trainee.id);
                DAYS.forEach(day => {
                    const daySchedule = schedule.schedule[day] || {};
                    Object.keys(daySchedule).forEach(time => {
                        const [endStr, startStr] = time.split(' - ');
                        const start = parseTimeString(startStr);
                        const end = parseTimeString(endStr);
                        allBusySlots[day].push({ start, end });
                    });
                });
            });

            // جمع محاضرات المدربين من الشعب الظاهرة
            Object.values(trainers).forEach(trainer => {
                // تحقق من أن المدرب يدرّس إحدى الشعب الظاهرة
                const hasVisibleSection = trainer.sections.some(ref => visibleSections.includes(ref));
                if (!hasVisibleSection) return;

                const schedule = getTrainerSchedule(trainer.id);
                DAYS.forEach(day => {
                    const daySchedule = schedule.schedule[day] || {};
                    Object.keys(daySchedule).forEach(time => {
                        const [endStr, startStr] = time.split(' - ');
                        const start = parseTimeString(startStr);
                        const end = parseTimeString(endStr);
                        allBusySlots[day].push({ start, end });
                    });
                });
            });

            // حساب الفراغات لكل يوم
            const freeSlots = {};
            DAYS.forEach(day => {
                freeSlots[day] = findFreeSlots(allBusySlots[day]);
            });

            return freeSlots;
        }

        // إيجاد الفراغات من قائمة الفترات المشغولة
        function findFreeSlots(busySlots) {
            if (busySlots.length === 0) {
                // إذا لا توجد محاضرات، كل اليوم فارغ
                const dayStart = timeRangeStart || (7 * 60 + 30); // 7:30
                if (END_OF_DAY - dayStart >= MIN_FREE_SLOT) {
                    return [{ start: dayStart, end: END_OF_DAY }];
                }
                return [];
            }

            // ترتيب الفترات المشغولة
            const sorted = [...busySlots].sort((a, b) => a.start - b.start);

            // دمج الفترات المتداخلة
            const merged = [];
            let current = { ...sorted[0] };

            for (let i = 1; i < sorted.length; i++) {
                if (sorted[i].start <= current.end) {
                    // تداخل - توسيع الفترة الحالية
                    current.end = Math.max(current.end, sorted[i].end);
                } else {
                    merged.push(current);
                    current = { ...sorted[i] };
                }
            }
            merged.push(current);

            // البحث عن الفراغات
            const freeSlots = [];
            const dayStart = timeRangeStart || (7 * 60 + 30); // 7:30

            // فراغ قبل أول محاضرة
            if (merged[0].start > dayStart) {
                const gap = merged[0].start - dayStart;
                if (gap >= MIN_FREE_SLOT) {
                    freeSlots.push({ start: dayStart, end: merged[0].start });
                }
            }

            // فراغات بين المحاضرات
            for (let i = 0; i < merged.length - 1; i++) {
                const gap = merged[i + 1].start - merged[i].end;
                if (gap >= MIN_FREE_SLOT) {
                    freeSlots.push({ start: merged[i].end, end: merged[i + 1].start });
                }
            }

            // فراغ بعد آخر محاضرة حتى نهاية اليوم (15:00)
            const lastEnd = merged[merged.length - 1].end;
            if (END_OF_DAY > lastEnd) {
                const gap = END_OF_DAY - lastEnd;
                if (gap >= MIN_FREE_SLOT) {
                    freeSlots.push({ start: lastEnd, end: END_OF_DAY });
                }
            }

            return freeSlots;
        }

        // تنسيق الدقائق إلى وقت مقروء (مثل 7:30)
        function minutesToTimeString(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}:${mins.toString().padStart(2, '0')}`;
        }
        // تهيئة صفحة الرفع
        function initUploadPage() {
            [ss01Zone, sf01Zone].forEach(zone => {
                zone.addEventListener('click', () => {
                    currentZone = zone.dataset.file;
                    fileInput.click();
                });

                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('dragover');
                });

                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('dragover');
                });

                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('dragover');
                    currentZone = zone.dataset.file;
                    handleFile(e.dataTransfer.files[0]);
                });
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    handleFile(e.target.files[0]);
                }
            });

            // تحميل الملفات المحفوظة من IndexedDB
            loadCachedFiles();
        }

        // ═══════════════════════════════════════════════════════════════
        //  IndexedDB للحفظ الدائم (أفضل من localStorage للملفات الكبيرة)
        // ═══════════════════════════════════════════════════════════════
        const DB_NAME = 'TraineeSlotsDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'files';
        let db = null;

        // فتح قاعدة البيانات
        function openDatabase() {
            return new Promise((resolve, reject) => {
                if (db) {
                    resolve(db);
                    return;
                }

                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        database.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
            });
        }

        // حفظ الملف في IndexedDB
        async function saveFileToCache(fileType, content) {
            try {
                const database = await openDatabase();
                const transaction = database.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);

                store.put({
                    id: fileType,
                    content: content,
                    timestamp: new Date().toISOString()
                });

                console.log(`💾 تم حفظ ${fileType} في IndexedDB`);
            } catch (e) {
                console.warn('خطأ في حفظ IndexedDB:', e);
            }
        }

        // تحميل الملفات المحفوظة من IndexedDB
        async function loadCachedFiles() {
            try {
                const database = await openDatabase();
                const transaction = database.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);

                const ss01Request = store.get('ss01');
                const sf01Request = store.get('sf01');

                ss01Request.onsuccess = () => {
                    if (ss01Request.result) {
                        uploadedFiles.ss01 = { cached: true, content: ss01Request.result.content };
                        const ss01Zone = document.getElementById('ss01Zone');
                        if (ss01Zone) {
                            ss01Zone.classList.add('uploaded');
                            ss01Zone.querySelector('.upload-zone-title').textContent = 'SS01 ✓ (محفوظ)';
                        }
                        console.log('📂 تم تحميل SS01 من IndexedDB');
                        checkFilesReady();
                    }
                };

                sf01Request.onsuccess = () => {
                    if (sf01Request.result) {
                        uploadedFiles.sf01 = { cached: true, content: sf01Request.result.content };
                        const sf01Zone = document.getElementById('sf01Zone');
                        if (sf01Zone) {
                            sf01Zone.classList.add('uploaded');
                            sf01Zone.querySelector('.upload-zone-title').textContent = 'SF01 ✓ (محفوظ)';
                        }
                        console.log('📂 تم تحميل SF01 من IndexedDB');
                        checkFilesReady();
                    }
                };
            } catch (e) {
                console.warn('خطأ في تحميل IndexedDB:', e);
            }
        }

        // معالجة الملف
        function handleFile(file) {
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showToast('يرجى اختيار ملف CSV فقط', 'error');
                return;
            }

            // التأكد من المنطقة الحالية
            if (!currentZone) {
                // افتراضياً نستخدم ss01 إذا لم يتم التحديد (حالة نادرة)
                if (!uploadedFiles.ss01) currentZone = 'ss01';
                else currentZone = 'sf01';
            }

            const zone = document.getElementById(currentZone + 'Zone');
            if (!zone) return;

            // محاكاة الرفع
            const progressBar = zone.querySelector('.upload-progress-bar');
            const progress = zone.querySelector('.upload-progress');
            progress.style.display = 'block';

            // قراءة محتوى الملف
            const reader = new FileReader();
            reader.onload = function (e) {
                const fileContent = e.target.result;

                // حفظ في localStorage
                saveFileToCache(currentZone, fileContent);

                // حفظ الملف مع المحتوى
                uploadedFiles[currentZone] = { file, content: fileContent };

                zone.classList.add('uploaded');
                progress.style.display = 'none';
                progressBar.style.width = '100%';

                checkFilesReady();
                showToast(`تم رفع ${currentZone.toUpperCase()} بنجاح وحفظه`, 'success');
            };

            reader.onerror = function () {
                progress.style.display = 'none';
                showToast('فشل في قراءة الملف', 'error');
            };

            // Start reading with progress simulation
            let width = 0;
            const interval = setInterval(() => {
                width += 20;
                progressBar.style.width = width + '%';
                if (width >= 100) {
                    clearInterval(interval);
                }
            }, 30);

            reader.readAsText(file);
        }

        // التحقق من جاهزية الملفات
        function checkFilesReady() {
            if (uploadedFiles.ss01 && uploadedFiles.sf01) {
                startBtn.classList.add('active');
            } else {
                startBtn.classList.remove('active');
            }
        }

        // بدء التحليل
        async function startAnalysis() {
            // التحقق التفصيلي مع رسائل خطأ
            if (!uploadedFiles.ss01) {
                showToast('⚠️ يجب رفع ملف SS01 (جدول الوحدة الأسبوعي)', 'error');
                return;
            }
            if (!uploadedFiles.sf01) {
                showToast('⚠️ يجب رفع ملف SF01 (قائمة تسجيل المتدربين)', 'error');
                return;
            }

            // معالجة الملفات
            const success = await processUploadedFiles();

            if (success) {
                // إخفاء صفحة الرفع وإظهار الرئيسية
                const uploadPageEl = document.getElementById('uploadPage');
                const mainPageEl = document.getElementById('mainPage');

                if (uploadPageEl && mainPageEl) {
                    uploadPageEl.style.display = 'none';
                    mainPageEl.style.display = 'flex';
                    mainPageEl.scrollIntoView();
                } else {
                    console.error('Elements missing:', { uploadPageEl, mainPageEl });
                    showToast('حدث خطأ في عرض الصفحة الرئيسية', 'error');
                }
            }
        }



        // إزالة الـ chips
        document.querySelectorAll('.chip-remove').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.target.closest('.chip').remove();
            });
        });

        // عرض/إخفاء التحميل
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // عرض الإشعارات
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';

            const icons = {
                success: '✅',
                error: '❌',
                info: 'ℹ️'
            };

            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <span class="toast-message">${message}</span>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ═══════════════════════════════════════════════════════════════
        //  معالجة البيانات - Data Processing
        // ═══════════════════════════════════════════════════════════════

        // الثوابت
        const DAYS = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس'];
        const TIME_SLOTS = [
            '0730 - 0910',
            '0915 - 1055',
            '1100 - 1240',
            '1250 - 1430'
        ];

        // هياكل البيانات الرئيسية
        let sections = {};      // الشعب (من SS01)
        let trainees = {};      // المتدربين (من SF01)
        let trainers = {};      // المدربين (مستخرج من SS01)
        let allTimeSlots = new Set(); // جميع الأوقات الفريدة
        let sortedTimeSlots = []; // الأوقات المرتبة (تُملأ بعد التحليل)

        // بيانات الفلاتر (تُستخرج ديناميكياً)
        let departments = new Set();      // الأقسام
        let coursePrefixes = new Set();   // رموز المقررات (حروف فقط)
        let scheduleTypes = new Set();    // أنواع الشعب
        let courses = new Map();          // المقررات مع عدد الشعب

        // حالة الفلاتر المختارة
        let selectedFilters = {
            departments: [],      // الأقسام المختارة
            prefixes: [],         // الرموز المختارة
            scheduleTypes: []     // أنواع الجدولة المختارة
        };

        // الشعب المستهدفة
        let targetSections = [];  // أرقام الشعب المستهدفة

        // النطاق الزمني الديناميكي
        let timeRangeStart = 0;  // بالدقائق من منتصف الليل
        let timeRangeEnd = 0;    // بالدقائق من منتصف الليل
        let timeRangeMinutes = 0; // إجمالي الدقائق


        // ═══════════════════════════════════════════════════════════════
        //  دوال Timeline
        // ═══════════════════════════════════════════════════════════════

        // تحويل نص الوقت "0730" إلى دقائق
        function parseTimeString(timeStr) {
            if (!timeStr || timeStr.length < 4) return 0;
            const hours = parseInt(timeStr.substring(0, 2)) || 0;
            const mins = parseInt(timeStr.substring(2, 4)) || 0;
            return hours * 60 + mins;
        }

        // حساب النطاق الزمني من البيانات
        function calculateTimeRange() {
            let minTime = Infinity;
            let maxTime = 0;

            Object.values(sections).forEach(section => {
                section.sessions.forEach(session => {
                    if (!session.time) return;
                    const [endStr, startStr] = session.time.split(' - ');
                    const start = parseTimeString(startStr);
                    const end = parseTimeString(endStr);

                    if (start < minTime) minTime = start;
                    if (end > maxTime) maxTime = end;
                });
            });

            // إضافة هامش
            timeRangeStart = minTime - 10;
            timeRangeEnd = maxTime + 10;
            timeRangeMinutes = timeRangeEnd - timeRangeStart;

            console.log(`⏰ النطاق الزمني: ${Math.floor(timeRangeStart / 60)}:${timeRangeStart % 60} - ${Math.floor(timeRangeEnd / 60)}:${timeRangeEnd % 60}`);
        }

        // تحويل وقت لنسبة مئوية من عرض الخلية
        function timeToPercent(timeStr) {
            const mins = parseTimeString(timeStr);
            return ((mins - timeRangeStart) / timeRangeMinutes) * 100;
        }

        // تحويل مدة لنسبة مئوية
        function durationToPercent(startStr, endStr) {
            const start = parseTimeString(startStr);
            const end = parseTimeString(endStr);
            return ((end - start) / timeRangeMinutes) * 100;
        }

        // إنشاء خلية Timeline ليوم معين
        function createTimelineCell(daySessions, targetSectionsList = [], showTargetSlots = false, currentDay = null) {
            let bars = '';
            let targetSlots = '';

            // معالجة الجلسات الموجودة
            if (daySessions && daySessions.length > 0) {
                daySessions.forEach(session => {
                    if (!session.time) return;

                    const [endStr, startStr] = session.time.split(' - ');
                    const left = timeToPercent(startStr);
                    const width = durationToPercent(startStr, endStr);
                    const type = getCellType(session.scheduleType);

                    // التحقق من الشعبة المستهدفة
                    const isTarget = targetSectionsList.includes(session.refNumber);
                    const targetClass = isTarget ? ' target' : '';

                    // التحقق من الشعبة الظاهرة (المختارة للعرض)
                    const isVisible = visibleSections.length > 0 && visibleSections.includes(session.refNumber);
                    const visibleClass = isVisible ? ' visible-highlight' : '';

                    // تنسيق الوقت للعرض (0730 → 7:30)
                    const formatTime = (t) => t ? `${parseInt(t.slice(0, 2))}:${t.slice(2)}` : '';
                    const timeDisplay = `${formatTime(startStr)} - ${formatTime(endStr)}`;

                    // Tooltip تفصيلي
                    // الحصول على عدد المتدربين من بيانات الشعبة
                    const sectionData = sections[session.refNumber];
                    const enrolledCount = sectionData ? sectionData.enrolled : 0;

                    const tooltipLines = [
                        `📋 الرقم المرجعي: ${session.refNumber || '-'}`,
                        `📚 ${session.courseCode || ''} - ${session.courseName || ''}`,
                        `⏰ ${timeDisplay}`,
                        `📝 ${session.scheduleType || '-'}`,
                        session.trainerName ? `👨‍🏫 ${session.trainerName}` : '',
                        session.room ? `🏫 القاعة: ${session.room}` : '',
                        `👥 المتدربين: ${enrolledCount}`
                    ].filter(Boolean).join('\n');

                    bars += `<div class="session-bar ${type}${targetClass}${visibleClass}" 
                        style="right: ${left}%; width: ${width}%;"
                        title="${tooltipLines}"
                        data-ref="${session.refNumber}">
                        ${session.courseCode || ''}
                    </div>`;
                });
            }

            // إضافة صناديق الشعب المستهدفة (إظهار موقعها حتى لو لم تكن مسجلة)
            if (showTargetSlots && targetSectionsList.length > 0 && currentDay) {
                targetSectionsList.forEach(refNum => {
                    const section = sections[refNum];
                    if (!section) return;

                    // البحث عن جلسات الشعبة المستهدفة في هذا اليوم فقط
                    section.sessions.forEach(targetSession => {
                        if (!targetSession.time) return;
                        // التحقق من أن الجلسة في نفس اليوم
                        if (targetSession.day !== currentDay) return;

                        const [endStr, startStr] = targetSession.time.split(' - ');
                        const left = timeToPercent(startStr);
                        const width = durationToPercent(startStr, endStr);

                        // التحقق من وجود تعارض (هل هناك جلسة أخرى في نفس الوقت؟)
                        const hasConflict = daySessions && daySessions.some(s => {
                            if (!s.time || s.refNumber === refNum) return false;
                            const [sEnd, sStart] = s.time.split(' - ');
                            // تحقق من التداخل الزمني
                            return !(endStr <= sStart || startStr >= sEnd);
                        });

                        const conflictClass = hasConflict ? 'conflict' : 'available';
                        const tooltipText = hasConflict ?
                            `⚠️ تعارض - ${section.courseCode} (${refNum})` :
                            `✅ متاح - ${section.courseCode} (${refNum})`;

                        targetSlots += `<div class="target-slot ${conflictClass}" 
                            style="right: ${left}%; width: ${width}%;"
                            title="${tooltipText}"
                            data-ref="${refNum}">
                        </div>`;
                    });
                });
            }

            // إضافة صناديق الفراغات المشتركة (أخضر متوهج)
            let freeSlotsHtml = '';
            if (showFreeSlots && currentDay && visibleSections.length > 0) {
                const sharedFreeSlots = calculateSharedFreeSlots();
                const dayFreeSlots = sharedFreeSlots[currentDay] || [];

                dayFreeSlots.forEach(slot => {
                    // تحويل الدقائق إلى نص وقت (مثل "0730")
                    const startTimeStr = String(Math.floor(slot.start / 60)).padStart(2, '0') +
                        String(slot.start % 60).padStart(2, '0');
                    const endTimeStr = String(Math.floor(slot.end / 60)).padStart(2, '0') +
                        String(slot.end % 60).padStart(2, '0');

                    const left = timeToPercent(startTimeStr);
                    const width = ((slot.end - slot.start) / timeRangeMinutes) * 100;

                    // تنسيق الوقت للعرض
                    const startDisplay = minutesToTimeString(slot.start);
                    const endDisplay = minutesToTimeString(slot.end);
                    const duration = slot.end - slot.start;

                    const tooltipText = `✅ فراغ متاح\nمن ${startDisplay} إلى ${endDisplay}\n(${duration} دقيقة)`;

                    freeSlotsHtml += `<div class="free-slot" 
                        style="right: ${left}%; width: ${width}%;"
                        title="${tooltipText}">
                    </div>`;
                });
            }

            // تحديد كلاس اليوم
            const dayMap = { 'الأحد': 'day-sun', 'الإثنين': 'day-mon', 'الثلاثاء': 'day-tue', 'الأربعاء': 'day-wed', 'الخميس': 'day-thu' };
            const dayClass = (currentDay && dayMap[currentDay]) ? dayMap[currentDay] : '';

            return `<td class="day-column ${dayClass}"><div class="day-cell">${freeSlotsHtml}${targetSlots}${bars}</div></td>`;
        }

        // ═══════════════════════════════════════════════════════════════
        function parseCSV(text) {
            const lines = text.split(/\r?\n/).filter(line => line.trim());
            if (lines.length === 0) return [];

            const result = [];
            const headers = parseCSVLine(lines[0]);

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === 0) continue;

                const row = {};
                headers.forEach((header, idx) => {
                    row[header.trim()] = values[idx]?.trim() || '';
                });
                result.push(row);
            }

            return result;
        }

        // معالجة سطر CSV مع دعم علامات الاقتباس
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++; // تخطي علامة الاقتباس المزدوجة
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);

            return result;
        }

        // ═══════════════════════════════════════════════════════════════
        //  2. معالجة ملف SS01 (جداول الشعب)
        // ═══════════════════════════════════════════════════════════════
        function parseSS01(data) {
            sections = {};
            trainers = {};

            data.forEach(row => {
                const refNum = row['الرقم المرجعي'];
                if (!refNum) return;

                const day = row['اليوم'];
                const time = row['الوقت'];
                const trainerId = row['رقم المدرب'];
                const trainerName = row['اسم المدرب'];

                // جمع الأوقات الفريدة
                if (time) {
                    allTimeSlots.add(time);
                }

                // إذا الشعبة موجودة، أضف الجلسة
                if (sections[refNum]) {
                    // تأكد من عدم تكرار الجلسة
                    const exists = sections[refNum].sessions.some(s =>
                        s.day === day && s.time === time
                    );
                    if (!exists && day && time) {
                        sections[refNum].sessions.push({ day, time });
                    }
                } else {
                    // إنشاء شعبة جديدة
                    sections[refNum] = {
                        refNumber: refNum,
                        courseCode: row['المقرر'] || '',
                        courseName: row['اسم المقرر'] || '',
                        trainerId: trainerId || '',
                        trainerName: trainerName || '',
                        scheduleType: row['نوع الجدولة'] || row['نوع الشعبة'] || '',
                        creditHours: parseInt(row['الساعات المعتمدة']) || 0,
                        contactHours: parseInt(row['ساعات الاتصال']) || 0,
                        lectureHours: parseInt(row['ساعات المحاضرة']) || 0,
                        labHours: parseInt(row['ساعات المختبر']) || 0,
                        otherHours: parseInt(row['ساعات أخرى']) || 0,
                        department: row['القسم'] || '',
                        building: row['مبنى'] || '',
                        room: row['قاعة'] || '',
                        capacity: parseInt(row['سعة']) || 0,
                        enrolled: parseInt(row['مسجلين']) || 0,
                        sessions: day && time ? [{ day, time }] : []
                    };
                }

                // بناء قائمة المدربين
                if (trainerId && trainerName) {
                    if (!trainers[trainerId]) {
                        trainers[trainerId] = {
                            id: trainerId,
                            name: trainerName,
                            sections: []
                        };
                    }
                    if (!trainers[trainerId].sections.includes(refNum)) {
                        trainers[trainerId].sections.push(refNum);
                    }
                }

                // استخراج بيانات الفلاتر
                const dept = row['القسم'];
                const courseCode = row['المقرر'];
                const schedType = row['نوع الشعبة'] || row['نوع الجدولة'];

                if (dept) departments.add(dept);
                if (schedType) scheduleTypes.add(schedType);

                // استخراج رمز المقرر (الحروف فقط)
                if (courseCode) {
                    const prefix = courseCode.replace(/[-\d]/g, '').trim();
                    if (prefix) coursePrefixes.add(prefix);

                    // تتبع المقررات مع عدد شعبها
                    if (!courses.has(courseCode)) {
                        courses.set(courseCode, {
                            code: courseCode,
                            name: row['اسم المقرر'] || '',
                            sectionCount: 0
                        });
                    }
                    courses.get(courseCode).sectionCount++;
                }
            });

            console.log(`✅ تم تحميل ${Object.keys(sections).length} شعبة`);
            console.log(`✅ تم تحميل ${Object.keys(trainers).length} مدرب`);
            console.log(`📁 ${departments.size} قسم | ${coursePrefixes.size} رمز | ${scheduleTypes.size} نوع شعبة`);
        }

        // ═══════════════════════════════════════════════════════════════
        //  3. معالجة ملف SF01 (تسجيل المتدربين)
        // ═══════════════════════════════════════════════════════════════
        function parseSF01(data) {
            trainees = {};

            data.forEach(row => {
                const traineeId = row['رقم المتدرب'];
                const refNum = row['الرقم المرجعي'];

                if (!traineeId) return;

                // قراءة الساعات المعتمدة من SF01
                const creditHours = parseInt(row['الساعات المعتمدة']) || 0;

                if (trainees[traineeId]) {
                    // إضافة تسجيل جديد للمتدرب الموجود
                    if (refNum) {
                        const exists = trainees[traineeId].registrations.some(r => r.refNum === refNum);
                        if (!exists) {
                            trainees[traineeId].registrations.push({ refNum, creditHours });
                        }
                    }
                } else {
                    // إنشاء متدرب جديد
                    trainees[traineeId] = {
                        id: traineeId,
                        name: row['إسم المتدرب'] || '',
                        department: row['القسم'] || '',
                        major: row['التخصص'] || '',
                        program: row['برنامج'] || '',
                        phone: row['رقم الجوال'] || '',
                        status: row['حالة المتدرب'] || '',
                        trainingType: row['نوع التدريب'] || '',
                        registrations: refNum ? [{ refNum, creditHours }] : []
                    };
                }
            });

            console.log(`✅ تم تحميل ${Object.keys(trainees).length} متدرب`);
        }

        // ═══════════════════════════════════════════════════════════════
        //  4. الحصول على جدول المتدرب
        // ═══════════════════════════════════════════════════════════════
        function getTraineeSchedule(traineeId) {
            const trainee = trainees[traineeId];
            if (!trainee) return {};

            const schedule = {};
            DAYS.forEach(day => schedule[day] = {});

            let totalCreditHours = 0;

            trainee.registrations.forEach(reg => {
                const refNum = reg.refNum;
                const section = sections[refNum];
                if (!section) return;

                // جمع الساعات المعتمدة من التسجيل (SF01) وليس من الشعبة (SS01)
                totalCreditHours += reg.creditHours;

                section.sessions.forEach(session => {
                    if (!schedule[session.day]) schedule[session.day] = {};

                    schedule[session.day][session.time] = {
                        refNumber: refNum,
                        courseCode: section.courseCode,
                        courseName: section.courseName,
                        trainerName: section.trainerName,
                        scheduleType: section.scheduleType,
                        room: section.room
                    };
                });
            });

            return {
                schedule,
                totalCreditHours,
                registrationCount: trainee.registrations.length
            };
        }

        // ═══════════════════════════════════════════════════════════════
        //  5. الحصول على جدول المدرب
        // ═══════════════════════════════════════════════════════════════
        function getTrainerSchedule(trainerId) {
            const trainer = trainers[trainerId];
            if (!trainer) return {};

            const schedule = {};
            DAYS.forEach(day => schedule[day] = {});

            let totalSections = trainer.sections.length;
            let totalMinutes = 0;
            let totalQuota = 0;

            trainer.sections.forEach(refNum => {
                const section = sections[refNum];
                if (!section) return;

                // حساب الدقائق الفعلية من الجلسات لهذه الشعبة
                let sectionMinutes = 0;
                section.sessions.forEach(session => {
                    if (!session.time) return;
                    const [endStr, startStr] = session.time.split(' - ');
                    const start = parseTimeString(startStr);
                    const end = parseTimeString(endStr);
                    sectionMinutes += (end - start);

                    if (!schedule[session.day]) schedule[session.day] = {};

                    schedule[session.day][session.time] = {
                        refNumber: refNum,
                        courseCode: section.courseCode,
                        courseName: section.courseName,
                        scheduleType: section.scheduleType,
                        enrolled: section.enrolled,
                        room: section.room
                    };
                });

                totalMinutes += sectionMinutes;

                // حساب ساعات الاتصال لهذه الشعبة
                const sectionContactHours = sectionMinutes / 50;

                // حساب النصاب بناءً على نوع الشعبة
                const scheduleType = (section.scheduleType || '').toLowerCase();

                if (scheduleType.includes('ذاتي')) {
                    // الذاتي لا يُحسب ضمن النصاب
                    // لا إضافة
                } else if (scheduleType.includes('عملي') || scheduleType.includes('تعاوني')) {
                    // العملي والتعاوني: 3 ساعات اتصال = 2 نصاب
                    totalQuota += (sectionContactHours * 2) / 3;
                } else if (scheduleType.includes('مدمج')) {
                    // المدمج: يعتمد على نوع المقرر الأصلي
                    const theoryHours = (section.lectureHours || 0) + (section.otherHours || 0);
                    const practicalHours = section.labHours || 0;

                    if (practicalHours > 0 && theoryHours === 0) {
                        // مقرر عملي بحت مدمج → 3:2
                        totalQuota += (sectionContactHours * 2) / 3;
                    } else {
                        // مقرر نظري أو مختلط مدمج → 1:1
                        totalQuota += sectionContactHours;
                    }
                } else {
                    // النظري (افتراضي): 1 ساعة اتصال = 1 نصاب
                    totalQuota += sectionContactHours;
                }
            });

            // تحويل الدقائق إلى ساعات اتصال (كل 50 دقيقة = ساعة)
            // مع تقريب إلى خانة عشرية واحدة
            const totalContactHours = Math.round((totalMinutes / 50) * 10) / 10;
            totalQuota = Math.round(totalQuota * 10) / 10;

            return {
                schedule,
                totalSections,
                totalContactHours,
                totalQuota
            };
        }

        // ═══════════════════════════════════════════════════════════════
        //  6. تحديد فراغات المتدرب
        // ═══════════════════════════════════════════════════════════════
        function getTraineeFreeSlots(traineeId) {
            const { schedule } = getTraineeSchedule(traineeId);
            const freeSlots = {};

            DAYS.forEach(day => {
                freeSlots[day] = TIME_SLOTS.filter(slot =>
                    !schedule[day] || !schedule[day][slot]
                );
            });

            return freeSlots;
        }

        // ═══════════════════════════════════════════════════════════════
        //  7. التحقق من توفر المتدرب لشعبة معينة
        // ═══════════════════════════════════════════════════════════════
        function isTraineeAvailableForSection(traineeId, sectionRefNum) {
            const section = sections[sectionRefNum];
            if (!section) return false;

            const freeSlots = getTraineeFreeSlots(traineeId);

            // يجب أن يكون فارغاً في جميع جلسات الشعبة
            return section.sessions.every(session =>
                freeSlots[session.day]?.includes(session.time)
            );
        }

        // ═══════════════════════════════════════════════════════════════
        //  8. المعالجة الرئيسية عند رفع الملفات
        // ═══════════════════════════════════════════════════════════════
        async function processUploadedFiles() {
            try {
                showLoading(true);

                // قراءة ملف SS01 (من الذاكرة أو من الملف)
                let ss01Text;
                if (uploadedFiles.ss01.content) {
                    ss01Text = uploadedFiles.ss01.content;
                } else if (uploadedFiles.ss01.text) {
                    ss01Text = await uploadedFiles.ss01.text();
                } else {
                    throw new Error('SS01 content not found');
                }
                const ss01Data = parseCSV(ss01Text);
                parseSS01(ss01Data);

                // قراءة ملف SF01 (من الذاكرة أو من الملف)
                let sf01Text;
                if (uploadedFiles.sf01.content) {
                    sf01Text = uploadedFiles.sf01.content;
                } else if (uploadedFiles.sf01.text) {
                    sf01Text = await uploadedFiles.sf01.text();
                } else {
                    throw new Error('SF01 content not found');
                }
                const sf01Data = parseCSV(sf01Text);
                parseSF01(sf01Data);

                // ترتيب الأوقات وحفظها عالمياً
                sortedTimeSlots = Array.from(allTimeSlots).sort((a, b) => {
                    const timeA = a.split(' - ')[0];
                    const timeB = b.split(' - ')[0];
                    return timeA.localeCompare(timeB);
                });

                console.log('⏰ الأوقات المتاحة:', sortedTimeSlots);

                // حساب النطاق الزمني
                calculateTimeRange();

                // عرض البيانات
                renderAllData();

                showLoading(false);
                showToast('✅ تم تحليل البيانات بنجاح', 'success');

                return true;
            } catch (error) {
                console.error('خطأ في معالجة الملفات:', error);
                showLoading(false);
                showToast('❌ حدث خطأ في معالجة الملفات', 'error');
                return false;
            }
        }

        // ═══════════════════════════════════════════════════════════════
        //  عرض البيانات في الجداول
        // ═══════════════════════════════════════════════════════════════
        function renderAllData() {
            updateTableHeaders();
            renderTrainersTable();
            renderTraineesTable();
            populateMultiSelectLists(); // تصحيح اسم الدالة
            updateCounts();
        }

        // تحديث العدادات
        function updateCounts() {
            const trainersCount = document.querySelector('.table-section:first-child .table-count');
            const traineesCount = document.querySelector('.table-section:last-child .table-count');

            if (trainersCount) {
                trainersCount.textContent = `${Object.keys(trainers).length} مدرب`;
            }
            if (traineesCount) {
                traineesCount.textContent = `${Object.keys(trainees).length} متدرب`;
            }
        }

        // تحديث رؤوس الجداول ديناميكياً (Timeline)
        function updateTableHeaders() {
            const tables = document.querySelectorAll('.data-table');

            // خريطة أسماء الأيام للكلاسات
            const dayMap = ['day-sun', 'day-mon', 'day-tue', 'day-wed', 'day-thu'];

            tables.forEach(table => {
                const thead = table.querySelector('thead');
                if (!thead) return;

                const isTrainersTable = table.closest('.table-section')?.querySelector('.table-title')?.textContent?.includes('المدربين');

                // إضافة كلاس مميز للرأس
                thead.classList.remove('trainer-header', 'trainee-header');
                thead.classList.add(isTrainersTable ? 'trainer-header' : 'trainee-header');

                // تحديد نوع الجدول والأعمدة القابلة للفلترة
                const type = isTrainersTable ? 'trainer' : 'trainee';
                const nameCol = isTrainersTable ? 'المدرب' : 'المتدرب';
                const deptCol = isTrainersTable ? 'القسم' : 'التخصص';

                // صف واحد فقط بـ 5 أعمدة للأيام
                let headerRow = `<tr>
                    <th class="col-id">#</th>
                    
                    <!-- عمود الاسم مع فلتر -->
                    <th class="col-name">
                        <div class="th-filter-wrapper">
                            <span>${nameCol}</span>
                            <button id="btn-filter-${type}-name"
                                    class="column-filter-btn ${columnFilters[type].name.length > 0 ? 'active' : ''}" 
                                    onclick="toggleColumnFilter(event, '${type}', 'name')">
                                <i data-lucide="filter"></i>
                            </button>
                        </div>
                    </th>

                    <!-- عمود القسم/التخصص مع فلتر -->
                    <th class="col-dept">
                         <div class="th-filter-wrapper">
                            <span>${deptCol}</span>
                             <button id="btn-filter-${type}-${isTrainersTable ? 'dept' : 'major'}"
                                    class="column-filter-btn ${columnFilters[type].dept ? (columnFilters[type].dept.length > 0 ? 'active' : '') : (columnFilters[type].major.length > 0 ? 'active' : '')}" 
                                    onclick="toggleColumnFilter(event, '${type}', '${isTrainersTable ? 'dept' : 'major'}')">
                                <i data-lucide="filter"></i>
                            </button>
                        </div>
                    </th>

                    ${isTrainersTable ?
                        '<th class="col-stat text-contact">اتصال</th><th class="col-stat text-quota">نصاب</th>' :
                        '<th class="col-stat text-contact">الرقم</th><th class="col-stat text-credits">س معتمدة</th>'}`;

                DAYS.forEach((day, idx) => {
                    // إضافة كلاس اليوم المناسب للرأس
                    headerRow += `<th class="day-header day-column ${dayMap[idx] || ''}">${day}</th>`;
                });
                headerRow += '</tr>';

                thead.innerHTML = headerRow;

                // إعادة تفعيل الأيقونات
                if (window.lucide) {
                    lucide.createIcons({
                        root: thead
                    });
                }
            });

            console.log('✅ تم تحديث رؤوس الجداول (Timeline) مع الفلاتر');
        }

        // ═══════════════════════════════════════════════════════════════
        //  منطق فلاتر الأعمدة
        // ═══════════════════════════════════════════════════════════════

        // متغير لتخزين الفلتر النشط حالياً
        let activeFilterContext = null;

        // تهيئة قائمة الفلتر العامة (مرة واحدة)
        function initGlobalFilterDropdown() {
            if (document.getElementById('global-column-filter')) return;

            const dropdown = document.createElement('div');
            dropdown.id = 'global-column-filter';
            dropdown.className = 'column-filter-dropdown';

            // الهيكل الداخلي
            // الهيكل الداخلي
            dropdown.innerHTML = `
                <div class="column-filter-header">
                    <input type="text" class="column-filter-search" 
                           placeholder="بحث..." 
                           id="global-filter-search">
                    <button class="column-filter-action-btn btn-select-all" id="global-filter-select-all" title="تحديد الكل">
                         <i data-lucide="check-check"></i>
                    </button>
                    <button class="column-filter-action-btn btn-clear-all" id="global-filter-clear-all" title="مسح التحديد">
                         <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="column-filter-options" id="global-filter-options"></div>
             `;

            // إعادة تهيئة الأيقونات
            if (window.lucide) window.lucide.createIcons({ root: dropdown });

            document.body.appendChild(dropdown);

            // منع إغلاق القائمة عند النقر داخلها
            dropdown.addEventListener('click', (e) => e.stopPropagation());

            // ربط أحداث البحث والأزرار
            document.getElementById('global-filter-search').addEventListener('input', (e) => {
                if (activeFilterContext) filterColumnSearch(e.target, activeFilterContext.type, activeFilterContext.field);
            });

            document.getElementById('global-filter-select-all').addEventListener('click', () => {
                if (activeFilterContext) selectAllColumnFilter(activeFilterContext.type, activeFilterContext.field);
            });

            document.getElementById('global-filter-clear-all').addEventListener('click', () => {
                if (activeFilterContext) clearColumnFilter(activeFilterContext.type, activeFilterContext.field);
            });
        }

        // الانتقال لصفحة الرفع
        function goToUploadPage() {
            document.getElementById('mainPage').classList.remove('active');
            setTimeout(() => {
                document.getElementById('uploadPage').style.display = 'flex';
                document.getElementById('mainPage').style.display = 'none';

                // إعادة تفعيل الأنيميشن
                requestAnimationFrame(() => {
                    document.getElementById('uploadPage').classList.add('active');
                });
            }, 300);
        }

        // بدء التطبيق
        document.getElementById('startBtn').addEventListener('click', async () => {
            const success = await processUploadedFiles();
            if (success) {
                document.getElementById('uploadPage').classList.remove('active');
                setTimeout(() => {
                    document.getElementById('uploadPage').style.display = 'none';
                    document.getElementById('mainPage').style.display = 'flex';
                    requestAnimationFrame(() => {
                        document.getElementById('mainPage').classList.add('active');
                        // إعادة تهيئة الأيقونات للتأكد من ظهورها في الصفحة الرئيسية
                        if (window.lucide) window.lucide.createIcons();
                    });
                }, 300);
            }
        });

        // تهيئة الأيقونات عند التحميل الأولي
        document.addEventListener('DOMContentLoaded', () => {
            if (window.lucide) window.lucide.createIcons();

            // مزامنة حالة الأزرار
            updateFreeOnlyUI();
            updateMergeIdenticalUI();
            updateFreeSlotsUI();
        });

        // فتح قائمة الفلتر
        function toggleColumnFilter(event, type, field) {
            event.stopPropagation();
            initGlobalFilterDropdown();

            const dropdown = document.getElementById('global-column-filter');
            // العثور على الزر بدقة
            const buttonId = `btn-filter-${type}-${field}`;
            let button = document.getElementById(buttonId);

            // Fallback
            if (!button && event.currentTarget) button = event.currentTarget;

            if (!button) {
                console.error('Filter button not found:', buttonId);
                return;
            }

            // إذا ضغطنا على نفس الزر والقائمة مفتوحة -> أغلقها
            if (activeFilterContext &&
                activeFilterContext.type === type &&
                activeFilterContext.field === field &&
                dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                activeFilterContext = null;
                return;
            }

            // تحديث السياق
            activeFilterContext = { type, field, button };

            // تنظيف حقل البحث
            const searchInput = document.getElementById('global-filter-search');
            if (searchInput) searchInput.value = '';

            // بناء الخيارات
            buildColumnFilterOptions(type, field);

            // إعادة حساب الموقع
            repositionDropdown(dropdown, button);

            dropdown.classList.add('show');
        }

        function repositionDropdown(dropdown, button) {
            const btnRect = button.getBoundingClientRect();
            const dropdownWidth = 350;

            let top = btnRect.bottom + 5;
            let left = btnRect.right - dropdownWidth;

            if (left < 10) left = 10;
            if (top + 300 > window.innerHeight) top = btnRect.top - 310;

            dropdown.style.top = `${top}px`;
            dropdown.style.left = `${left}px`;
            dropdown.style.right = 'auto';
        }

        // إغلاق الفلاتر عند النقر خارجها
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.column-filter-dropdown') && !event.target.closest('.column-filter-btn')) {
                document.querySelectorAll('.column-filter-dropdown').forEach(d => d.classList.remove('show'));
            }
        });

        // إغلاق القوائم عند التمرير (لأنها ثابتة ولا تتحرك مع الجدول)
        window.addEventListener('scroll', () => {
            document.querySelectorAll('.column-filter-dropdown.show').forEach(d => d.classList.remove('show'));
        }, true);

        // بناء خيارات الفلتر
        function buildColumnFilterOptions(type, field) {
            const container = document.getElementById('global-filter-options');
            if (!container) return;

            let values = new Set();

            try {
                if (type === 'trainer') {
                    if (field === 'name') Object.values(trainers).forEach(t => values.add(t.name));
                    else if (field === 'dept') Object.values(trainers).forEach(t => t.sections.forEach(ref => { const d = sections[ref]?.department; if (d) values.add(d); }));
                } else if (type === 'trainee') {
                    if (field === 'name') Object.values(trainees).forEach(t => values.add(t.name));
                    else if (field === 'major') Object.values(trainees).forEach(t => { if (t.major) values.add(t.major); });
                }
            } catch (err) {
                console.error('Error building filter options:', err);
            }

            const sortedValues = [...values].sort();
            const currentSelection = columnFilters[type][field];

            let html = '';
            if (sortedValues.length === 0) {
                html = '<div style="padding:10px; text-align:center; color:#666;">لا توجد بيانات</div>';
            } else {
                sortedValues.forEach(val => {
                    const isChecked = currentSelection.includes(val);
                    html += `
                        <label class="column-filter-option">
                            <input type="checkbox" value="${val}" 
                                   ${isChecked ? 'checked' : ''} 
                                   onchange="applyColumnFilter('${type}', '${field}', this.value, this.checked)">
                            <span>${val}</span>
                        </label>
                    `;
                });
            }
            container.innerHTML = html;
        }

        // البحث
        function filterColumnSearch(input, type, field) {
            const filterText = input.value.toLowerCase();
            const options = document.querySelectorAll(`#global-filter-options .column-filter-option`);
            options.forEach(option => {
                const text = option.querySelector('span').textContent.toLowerCase();
                option.style.display = text.includes(filterText) ? 'flex' : 'none';
            });
        }

        // تطبيق الفلتر
        function applyColumnFilter(type, field, value, isChecked) {
            if (isChecked) {
                if (!columnFilters[type][field].includes(value)) columnFilters[type][field].push(value);
            } else {
                columnFilters[type][field] = columnFilters[type][field].filter(v => v !== value);
            }
            updateAndRender(type, field, true);
        }

        // اختيار الكل
        function selectAllColumnFilter(type, field) {
            const container = document.getElementById('global-filter-options');
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:not(:checked)');

            checkboxes.forEach(cb => {
                if (getComputedStyle(cb.closest('label')).display !== 'none') {
                    cb.checked = true;
                    if (!columnFilters[type][field].includes(cb.value)) {
                        columnFilters[type][field].push(cb.value);
                    }
                }
            });
            updateAndRender(type, field, true);
        }

        // مسح الكل
        function clearColumnFilter(type, field) {
            columnFilters[type][field] = [];
            updateAndRender(type, field, true);
        }

        function updateAndRender(type, field, keepDropdownOpen = false) {
            // تحديث الجدول
            updateTableHeaders();
            if (type === 'trainer') renderTrainersTable();
            else renderTraineesTable();

            if (keepDropdownOpen && activeFilterContext) {
                // إعادة العثور على الزر وإعادة التموضع
                setTimeout(() => {
                    const buttonId = `btn-filter-${activeFilterContext.type}-${activeFilterContext.field}`;
                    const newButton = document.getElementById(buttonId);

                    if (newButton) {
                        activeFilterContext.button = newButton;
                        const dropdown = document.getElementById('global-column-filter');
                        repositionDropdown(dropdown, newButton);
                    } else {
                        // الزر اختفى
                        const d = document.getElementById('global-column-filter');
                        if (d) d.classList.remove('show');
                        activeFilterContext = null;
                    }
                }, 0);
            } else {
                // إغلاق افتراضي إذا لم نطلب الإبقاء
                if (!keepDropdownOpen) {
                    const d = document.getElementById('global-column-filter');
                    if (d) d.classList.remove('show');
                    activeFilterContext = null;
                }
            }
        }

        // الحصول على نوع الخلية بناءً على نوع الجدولة
        function getCellType(scheduleType) {
            if (!scheduleType) return 'empty';
            const type = scheduleType.toLowerCase();
            if (type.includes('نظري')) return 'theory';
            if (type.includes('عملي')) return 'practical';
            if (type.includes('مدمج') || type.includes('تعاوني')) return 'blended';
            return 'theory';
        }

        // الحصول على رمز نوع الشعبة مع اللون (للقوائم المنسدلة)
        function getTypeCode(scheduleType) {
            if (!scheduleType) return '';
            const type = scheduleType.toLowerCase();
            if (type.includes('نظري')) return '<span style="color: #3b82f6; font-weight: bold;">ن</span>';
            if (type.includes('عملي')) return '<span style="color: #10b981; font-weight: bold;">ع</span>';
            if (type.includes('مدمج')) return '<span style="color: #8b5cf6; font-weight: bold;">م</span>';
            if (type.includes('ذاتي')) return '<span style="color: #6b7280; font-weight: bold;">ذ</span>';
            if (type.includes('تعاوني')) return '<span style="color: #f59e0b; font-weight: bold;">ت</span>';
            return '';
        }

        // الحصول على رمز اليوم
        function getDayCode(dayName) {
            if (!dayName) return '';
            const day = dayName.toLowerCase();
            if (day.includes('أحد') || day.includes('احد')) return 'ح';
            if (day.includes('اثن') || day.includes('إثن')) return 'ن';
            if (day.includes('ثلاث')) return 'ث';
            if (day.includes('أربع') || day.includes('اربع')) return 'ر';
            if (day.includes('خميس')) return 'خ';
            return dayName.charAt(0);
        }

        // إنشاء مربعات الجلسات (يوم + وقت) للقوائم المنسدلة
        function getSessionBadges(sessions) {
            if (!sessions || sessions.length === 0) return '';
            return sessions.map(s => {
                const dayCode = getDayCode(s.day);
                const time = formatTimeForDisplay(s.time);
                return `<span style="background: rgba(99,102,241,0.2); border-radius: 4px; padding: 0.1rem 0.25rem; font-size: 0.6rem; margin-right: 2px;">${dayCode} ${time}</span>`;
            }).join('');
        }

        // تحويل الوقت للعرض (من - إلى)
        function formatTimeForDisplay(time) {
            if (!time) return '';
            // الوقت يأتي بصيغة "1240 - 1100" (نهاية - بداية)
            const parts = time.split(' - ');
            if (parts.length === 2) {
                const endTime = parts[0];   // 1240
                const startTime = parts[1]; // 1100
                const formatTime = (t) => {
                    if (t && t.length === 4) {
                        return t.substring(0, 2) + ':' + t.substring(2);
                    }
                    return t;
                };
                return `${formatTime(startTime)}-${formatTime(endTime)}`;
            }
            // إذا كان الوقت بصيغة أخرى
            const singleTime = parts[0];
            if (singleTime && singleTime.length === 4) {
                return singleTime.substring(0, 2) + ':' + singleTime.substring(2);
            }
            return time;
        }

        // إنشاء خلية الجدول
        function createScheduleCell(slotData, isTarget = false) {
            if (!slotData) {
                return `<td><div class="time-cell empty${isTarget ? ' target' : ''}"></div></td>`;
            }

            const cellType = getCellType(slotData.scheduleType);
            const targetClass = isTarget ? ' target' : '';
            const tooltip = `${slotData.courseCode}\n${slotData.courseName}\n${slotData.trainerName || ''}`;

            return `<td>
                <div class="time-cell ${cellType}${targetClass}" title="${tooltip}">
                    <span class="cell-content">${slotData.courseCode || ''}</span>
                </div>
            </td>`;
        }

        // عرض جدول المدربين (Timeline)
        function renderTrainersTable() {
            const tbody = document.querySelector('.table-section:first-child .data-table tbody');
            if (!tbody) {
                console.error('لم يتم العثور على جدول المدربين');
                return;
            }

            tbody.innerHTML = '';
            let index = 1;

            // تصفية وترتيب المدربين
            let filteredTrainers = Object.values(trainers);

            // 1. فلترة بناءً على الشعب الظاهرة
            if (visibleSections.length > 0) {
                filteredTrainers = filteredTrainers.filter(trainer => {
                    return trainer.sections.some(refNum => visibleSections.includes(refNum));
                });
            }

            // 2. فلترة الأعمدة (المدرب والقسم)
            if (columnFilters.trainer.name.length > 0) {
                filteredTrainers = filteredTrainers.filter(t => columnFilters.trainer.name.includes(t.name));
            }
            if (columnFilters.trainer.dept.length > 0) {
                filteredTrainers = filteredTrainers.filter(t => {
                    const depts = [...new Set(
                        t.sections.map(refNum => sections[refNum]?.department).filter(Boolean)
                    )];
                    // يجب أن يكون لديه قسم واحد على الأقل من الأقسام المختارة
                    return depts.some(d => columnFilters.trainer.dept.includes(d));
                });
            }

            // ترتيب المدربين حسب عدد الساعات (تنازلياً)
            const sortedTrainers = filteredTrainers.sort((a, b) => {
                const schedA = getTrainerSchedule(a.id);
                const schedB = getTrainerSchedule(b.id);
                return schedB.totalContactHours - schedA.totalContactHours;
            });

            sortedTrainers.forEach(trainer => {
                const scheduleData = getTrainerSchedule(trainer.id);
                const row = document.createElement('tr');

                // الحصول على أقسام المدرب الفريدة من الشعب التي يدرسها
                const trainerDepts = [...new Set(
                    trainer.sections.map(refNum => sections[refNum]?.department).filter(Boolean)
                )].join(' / ');

                // بناء خلايا الجدول الأساسية
                let cells = `
                    <td class="col-id">${index}</td>
                    <td class="col-name trainer-name" title="${trainer.name}">${trainer.name}</td>
                    <td class="col-dept" title="${trainerDepts}">${trainerDepts}</td>
                    <td class="col-stat text-contact">${scheduleData.totalContactHours}</td>
                    <td class="col-stat text-quota">${scheduleData.totalQuota}</td>
                `;

                // إضافة خلايا Timeline للأيام
                DAYS.forEach(day => {
                    // تجميع جلسات اليوم
                    const daySessions = [];
                    Object.entries(scheduleData.schedule[day] || {}).forEach(([time, data]) => {
                        daySessions.push({
                            time,
                            refNumber: data.refNumber,
                            courseCode: data.courseCode,
                            courseName: data.courseName,
                            scheduleType: data.scheduleType,
                            room: data.room
                        });
                    });
                    cells += createTimelineCell(daySessions, targetSections);
                });

                row.innerHTML = cells;
                tbody.appendChild(row);
                index++;
            });

            console.log(`✅ تم عرض ${sortedTrainers.length} مدرب (Timeline)`);
        }

        // عرض جدول المتدربين (Timeline)
        function renderTraineesTable() {
            const tbody = document.querySelector('.table-section:last-child .data-table tbody');
            if (!tbody) {
                console.error('لم يتم العثور على جدول المتدربين');
                return;
            }

            tbody.innerHTML = '';
            let index = 1;

            // تصفية المتدربين بناءً على الشعب الظاهرة
            let filteredTrainees = Object.values(trainees);

            // 1. فلترة بناءً على الشعب الظاهرة
            if (visibleSections.length > 0) {
                filteredTrainees = filteredTrainees.filter(trainee => {
                    return trainee.registrations.some(r => visibleSections.includes(r.refNum));
                });
            }

            // 2. فلترة الأعمدة (المتدرب والتخصص)
            if (columnFilters.trainee.name.length > 0) {
                filteredTrainees = filteredTrainees.filter(t => columnFilters.trainee.name.includes(t.name));
            }
            if (columnFilters.trainee.major.length > 0) {
                filteredTrainees = filteredTrainees.filter(t => columnFilters.trainee.major.includes(t.major));
            }

            // دالة حساب التعارض مع الشعب المستهدفة
            function hasConflictWithTarget(trainee) {
                if (targetSections.length === 0) return false;

                const schedule = getTraineeSchedule(trainee.id);

                for (const targetRefNum of targetSections) {
                    const targetSection = sections[targetRefNum];
                    if (!targetSection) continue;

                    for (const targetSession of targetSection.sessions) {
                        if (!targetSession.time || !targetSession.day) continue;
                        const [targetEnd, targetStart] = targetSession.time.split(' - ');

                        // التحقق من وجود جلسة في نفس اليوم والوقت
                        const daySchedule = schedule.schedule[targetSession.day] || {};
                        for (const [time, data] of Object.entries(daySchedule)) {
                            if (data.refNumber === targetRefNum) continue;
                            const [sEnd, sStart] = time.split(' - ');
                            // تحقق من التداخل الزمني
                            if (!(targetEnd <= sStart || targetStart >= sEnd)) {
                                return true; // يوجد تعارض
                            }
                        }
                    }
                }
                return false; // لا يوجد تعارض
            }

            // فلترة المتدربين المتاحين فقط إذا كان الخيار مفعلاً
            if (showFreeOnly && targetSections.length > 0) {
                filteredTrainees = filteredTrainees.filter(trainee => !hasConflictWithTarget(trainee));
            }

            // ترتيب المتدربين: المتاحين أولاً ثم حسب عدد الساعات
            const sortedTrainees = filteredTrainees.sort((a, b) => {
                const conflictA = hasConflictWithTarget(a) ? 1 : 0;
                const conflictB = hasConflictWithTarget(b) ? 1 : 0;

                // إذا لم يكن هناك شعب مستهدفة، رتب حسب الساعات فقط
                if (targetSections.length === 0) {
                    const schedA = getTraineeSchedule(a.id);
                    const schedB = getTraineeSchedule(b.id);
                    return schedB.totalCreditHours - schedA.totalCreditHours;
                }

                // المتاحين (بدون تعارض) أولاً
                if (conflictA !== conflictB) {
                    return conflictA - conflictB;
                }

                // ثم حسب عدد الساعات
                const schedA = getTraineeSchedule(a.id);
                const schedB = getTraineeSchedule(b.id);
                return schedB.totalCreditHours - schedA.totalCreditHours;
            });

            // عرض أول 100 متدرب/مجموعة فقط للأداء
            const displayTrainees = sortedTrainees.slice(0, 100);

            // هل يوجد شعب مستهدفة؟
            const showTargetSlots = targetSections.length > 0;

            // ═══════════════════════════════════════════════════════════
            // عرض مع دمج المتطابقين
            // ═══════════════════════════════════════════════════════════
            if (mergeIdentical) {
                // تجميع المتدربين المتطابقين
                const groups = groupIdenticalTrainees(displayTrainees);

                groups.forEach(group => {
                    // استخدام أول متدرب كممثل للمجموعة
                    const representative = group.trainees[0];
                    const scheduleData = getTraineeSchedule(representative.id);
                    const row = document.createElement('tr');

                    // تحديد ما إذا كان هناك تعارض (أي متدرب في المجموعة = المجموعة كلها)
                    const hasConflict = hasConflictWithTarget(representative);
                    if (hasConflict) {
                        row.classList.add('conflict-row');
                    } else if (showTargetSlots) {
                        row.classList.add('available-row');
                    }

                    // إضافة class للمجموعات المتعددة
                    if (group.trainees.length > 1) {
                        row.classList.add('merged-group');
                    }

                    // قائمة أسماء المتدربين للـ tooltip
                    const traineeNames = group.trainees.map(t => `• ${t.name}`).join('\n');
                    const traineeIds = group.trainees.map(t => t.id).join(', ');
                    const tooltipText = `المتدربين (${group.trainees.length}):\n${traineeNames}\n\nالأرقام: ${traineeIds}`;

                    // الحصول على التخصص (جميع المتدربين في المجموعة من نفس التخصص)
                    const traineeMajor = group.trainees[0]?.major || '';

                    // بناء خلايا الجدول الأساسية
                    let cells = `
                        <td class="col-id">${index}</td>
                        <td class="col-name merged-cell" title="${tooltipText}">
                            <span class="merge-count">${group.trainees.length}</span>
                            <span class="merge-label">مجموعة متطابقة</span>
                        </td>
                        <td class="col-dept" title="${traineeMajor}">${traineeMajor}</td>
                        <td class="col-stat text-contact">-</td>
                        <td class="col-stat text-credits">${scheduleData.totalCreditHours}</td>
                    `;

                    // إضافة خلايا Timeline للأيام
                    DAYS.forEach(day => {
                        const daySessions = [];
                        Object.entries(scheduleData.schedule[day] || {}).forEach(([time, data]) => {
                            daySessions.push({
                                time,
                                refNumber: data.refNumber,
                                courseCode: data.courseCode,
                                courseName: data.courseName,
                                trainerName: data.trainerName,
                                scheduleType: data.scheduleType,
                                room: data.room
                            });
                        });
                        cells += createTimelineCell(daySessions, targetSections, showTargetSlots, day);
                    });

                    row.innerHTML = cells;
                    tbody.appendChild(row);
                    index++;
                });

                console.log(`✅ تم عرض ${groups.length} مجموعة من ${displayTrainees.length} متدرب (مدمج)`);
            }
            // ═══════════════════════════════════════════════════════════
            // عرض عادي (كل متدرب في صف)
            // ═══════════════════════════════════════════════════════════
            else {
                displayTrainees.forEach(trainee => {
                    const scheduleData = getTraineeSchedule(trainee.id);
                    const row = document.createElement('tr');

                    // تحديد ما إذا كان هناك تعارض
                    const hasConflict = hasConflictWithTarget(trainee);
                    if (hasConflict) {
                        row.classList.add('conflict-row');
                    } else if (showTargetSlots) {
                        row.classList.add('available-row');
                    }

                    // بناء خلايا الجدول الأساسية
                    let cells = `
                        <td class="col-id">${index}</td>
                        <td class="col-name trainee-name" title="${trainee.name}\n${trainee.phone || ''}">${trainee.name}</td>
                        <td class="col-dept" title="${trainee.major || ''}">${trainee.major || ''}</td>
                        <td class="col-stat text-contact" style="font-size: 0.65rem;">${trainee.id}</td>
                        <td class="col-stat text-credits">${scheduleData.totalCreditHours}</td>
                    `;

                    // إضافة خلايا Timeline للأيام
                    DAYS.forEach(day => {
                        // تجميع جلسات اليوم
                        const daySessions = [];
                        Object.entries(scheduleData.schedule[day] || {}).forEach(([time, data]) => {
                            daySessions.push({
                                time,
                                refNumber: data.refNumber,
                                courseCode: data.courseCode,
                                courseName: data.courseName,
                                trainerName: data.trainerName,
                                scheduleType: data.scheduleType,
                                room: data.room
                            });
                        });
                        cells += createTimelineCell(daySessions, targetSections, showTargetSlots, day);
                    });

                    row.innerHTML = cells;
                    tbody.appendChild(row);
                    index++;
                });

                console.log(`✅ تم عرض ${displayTrainees.length} متدرب (Timeline)`);
            }
        }
        // ═══════════════════════════════════════════════════════════════
        //  Multi-Select Component Functions
        // ═══════════════════════════════════════════════════════════════

        // Toggle dropdown visibility
        function toggleMultiSelect(filterId) {
            const container = document.getElementById(filterId);
            const wasOpen = container.classList.contains('open');

            // Close all other dropdowns
            document.querySelectorAll('.multi-select.open').forEach(el => {
                el.classList.remove('open');
            });

            // Toggle this one
            if (!wasOpen) {
                container.classList.add('open');
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            // لا تغلق القائمة إذا كان النقر على أي عنصر داخل القائمة المنسدلة
            if (e.target.closest('.multi-select-dropdown')) {
                return;
            }
            if (!e.target.closest('.multi-select')) {
                document.querySelectorAll('.multi-select.open').forEach(el => {
                    el.classList.remove('open');
                });
            }
            // إغلاق قائمة الشعب الظاهرة
            if (!e.target.closest('.visible-section-input')) {
                hideVisibleDropdown();
            }
            // إغلاق قائمة الشعب المستهدفة
            if (!e.target.closest('.target-section-input')) {
                hideTargetDropdown();
            }
        });

        // Filter options in multi-select
        function filterMultiSelect(input, filterId) {
            const searchTerm = input.value.toLowerCase();
            const list = document.getElementById(filterId.replace('Filter', 'List'));

            list.querySelectorAll('.multi-select-option').forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Select all options
        function selectAllMulti(filterId) {
            const list = document.getElementById(filterId.replace('Filter', 'List'));
            list.querySelectorAll('input[type="checkbox"]:not(:checked)').forEach(cb => {
                if (cb.closest('.multi-select-option').style.display !== 'none') {
                    cb.checked = true;
                }
            });
            updateMultiSelectState(filterId);
        }

        // Clear all selections
        function clearAllMulti(filterId) {
            const list = document.getElementById(filterId.replace('Filter', 'List'));
            list.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                cb.checked = false;
            });
            updateMultiSelectState(filterId);
        }

        // Update trigger text and count badge
        function updateMultiSelectState(filterId) {
            console.log('🔵 [updateMultiSelectState] بداية التنفيذ، filterId:', filterId);

            const container = document.getElementById(filterId);
            const list = document.getElementById(filterId.replace('Filter', 'List'));
            const trigger = container.querySelector('.multi-select-trigger span:first-child');
            const badge = container.querySelector('.count-badge');

            const checked = list.querySelectorAll('input[type="checkbox"]:checked');
            const count = checked.length;

            console.log('📊 [updateMultiSelectState] checked elements:', checked);
            console.log('📊 [updateMultiSelectState] count:', count);

            if (count === 0) {
                trigger.textContent = 'الكل';
                badge.style.display = 'none';
                console.log('🟡 [updateMultiSelectState] لا توجد اختيارات');
            } else {
                // Get text from the label span with .option-text class
                const firstText = checked[0].closest('label').querySelector('.option-text').textContent;
                trigger.textContent = count === 1 ? firstText : `${count} مختار`;
                badge.textContent = count;
                badge.style.display = 'inline';
                console.log('🟢 [updateMultiSelectState] تم اختيار:', count, 'أول عنصر:', firstText);
            }

            // تحديث الـ class على كل label لعرض علامة الصح بشكل صحيح
            list.querySelectorAll('.multi-select-option').forEach(label => {
                const checkbox = label.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    label.classList.add('checked');
                } else {
                    label.classList.remove('checked');
                }
            });

            // Apply cascading filters
            applyCascadingFilters();
        }

        // ═══════════════════════════════════════════════════════════════
        //  فلاتر متتالية (AND logic) - جميع الشروط يجب أن تتحقق
        // ═══════════════════════════════════════════════════════════════

        // جمع القيم المختارة من فلتر معين
        function getSelectedValues(filterId) {
            const list = document.getElementById(filterId.replace('Filter', 'List'));
            if (!list) return [];
            const checked = list.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checked).map(cb => cb.value);
        }

        // تطبيق الفلاتر المتتالية
        function applyCascadingFilters() {
            // جمع جميع القيم المختارة
            selectedFilters.departments = getSelectedValues('departmentFilter');
            selectedFilters.prefixes = getSelectedValues('prefixFilter');
            selectedFilters.scheduleTypes = getSelectedValues('scheduleTypeFilter');

            console.log('🔍 الفلاتر المطبقة:', selectedFilters);

            // إعادة عرض الجداول
            if (Object.keys(trainers).length > 0) {
                renderTrainersTable();
                renderTraineesTable();
            }
        }

        // التحقق من تطابق الشعبة مع الفلاتر (AND logic)
        function sectionMatchesFilters(section) {
            // إذا لم تُختر أي قيم من فلتر، يُعتبر مطابقاً
            // إذا اختيرت قيم، يجب أن تكون الشعبة ضمنها

            // فلتر القسم
            if (selectedFilters.departments.length > 0) {
                if (!selectedFilters.departments.includes(section.department)) {
                    return false;
                }
            }

            // فلتر رمز المقرر (الحروف فقط)
            if (selectedFilters.prefixes.length > 0) {
                const coursePrefix = (section.courseCode || '').replace(/[-\d]/g, '').trim();
                if (!selectedFilters.prefixes.includes(coursePrefix)) {
                    return false;
                }
            }

            // فلتر نوع الشعبة
            if (selectedFilters.scheduleTypes.length > 0) {
                if (!selectedFilters.scheduleTypes.includes(section.scheduleType)) {
                    return false;
                }
            }

            // كل الفلاتر تطابقت
            return true;
        }

        // Populate multi-select lists
        function populateMultiSelectLists() {
            // Department list
            const deptList = document.getElementById('departmentList');
            if (deptList) {
                deptList.innerHTML = '';
                Array.from(departments).sort().forEach(dept => {
                    deptList.innerHTML += `
                        <label class="multi-select-option" onclick="event.stopPropagation()">
                            <input type="checkbox" value="${dept}" onchange="event.stopPropagation(); updateMultiSelectState('departmentFilter')">
                            <span class="custom-checkbox"></span>
                            <span class="option-text">${dept}</span>
                        </label>`;
                });
            }

            // Course prefix list
            const prefixList = document.getElementById('prefixList');
            if (prefixList) {
                prefixList.innerHTML = '';
                Array.from(coursePrefixes).sort().forEach(prefix => {
                    prefixList.innerHTML += `
                        <label class="multi-select-option" onclick="event.stopPropagation()">
                            <input type="checkbox" value="${prefix}" onchange="event.stopPropagation(); updateMultiSelectState('prefixFilter')">
                            <span class="custom-checkbox"></span>
                            <span class="option-text">${prefix}</span>
                        </label>`;
                });
            }

            // Schedule type list
            const typeList = document.getElementById('scheduleTypeList');
            if (typeList) {
                typeList.innerHTML = '';
                Array.from(scheduleTypes).sort().forEach(type => {
                    typeList.innerHTML += `
                        <label class="multi-select-option" onclick="event.stopPropagation()">
                            <input type="checkbox" value="${type}" onchange="event.stopPropagation(); updateMultiSelectState('scheduleTypeFilter')">
                            <span class="custom-checkbox"></span>
                            <span class="option-text">${type}</span>
                        </label>`;
                });
            }

            console.log(`✅ تم تحديث الفلاتر: ${departments.size} قسم، ${coursePrefixes.size} رمز، ${scheduleTypes.size} نوع`);
        }

        // ═══════════════════════════════════════════════════════════════
        //  Visible Sections - الشعب الظاهرة (تحدد المدربين والمتدربين المعروضين)
        // ═══════════════════════════════════════════════════════════════

        let visibleSections = [];  // أرقام الشعب الظاهرة

        function showVisibleDropdown() {
            const dropdown = document.getElementById('visibleSectionDropdown');
            if (dropdown) {
                dropdown.classList.add('show');
                searchVisibleSections(document.getElementById('visibleSectionSearch').value);
            }
        }

        function hideVisibleDropdown() {
            const dropdown = document.getElementById('visibleSectionDropdown');
            if (dropdown) dropdown.classList.remove('show');
        }

        function searchVisibleSections(searchTerm) {
            const dropdown = document.getElementById('visibleSectionDropdown');
            if (!dropdown) return;

            const term = searchTerm.toLowerCase();

            // Filter sections based on search term
            let filteredSections = Object.values(sections).filter(section => {
                const searchable = `${section.refNumber} ${section.courseCode} ${section.courseName}`.toLowerCase();
                return searchable.includes(term);
            });

            // Sort by enrolled count (descending - most first)
            filteredSections = filteredSections.sort((a, b) => b.enrolled - a.enrolled);

            // Limit to 30 results
            filteredSections = filteredSections.slice(0, 30);

            // Build dropdown HTML
            dropdown.innerHTML = filteredSections.length === 0 ?
                '<div style="padding: 0.5rem; text-align: center; color: var(--text-muted); font-size: 0.7rem;">لا توجد نتائج</div>' :
                filteredSections.map(section => {
                    const typeCode = getTypeCode(section.scheduleType);
                    const sessionBadges = getSessionBadges(section.sessions);
                    const trainerName = section.trainerName ? ` - ${section.trainerName}` : '';
                    return `
                        <div class="section-item" onclick="addVisibleSection('${section.refNumber}')">
                            <div class="section-info">
                                <span class="section-code">${section.refNumber} - ${section.courseCode} ${typeCode}</span>
                                <span class="section-sessions">${sessionBadges}</span>
                                <span class="section-name">${section.courseName}${trainerName}</span>
                            </div>
                            <span class="trainee-badge">${section.enrolled}</span>
                        </div>`;
                }).join('');

            if (searchTerm) {
                dropdown.classList.add('show');
            }
        }

        function addVisibleSection(refNumber) {
            if (visibleSections.includes(refNumber)) {
                showToast('الشعبة مضافة مسبقاً', 'info');
                return;
            }

            visibleSections.push(refNumber);
            updateVisibleChips();
            renderAllData();
            // لا نغلق القائمة - نتركها مفتوحة للاختيار المتعدد
            showToast('تمت إضافة الشعبة', 'success');
            // تحديث عدد المتاحين في chips المستهدفة
            updateTargetChips();
        }

        function removeVisibleSection(refNumber) {
            const index = visibleSections.indexOf(refNumber);
            if (index > -1) {
                visibleSections.splice(index, 1);
                updateVisibleChips();
                renderAllData();
                // تحديث عدد المتاحين في chips المستهدفة
                updateTargetChips();
            }
        }

        function updateVisibleChips() {
            const container = document.getElementById('visibleChipsContainer');
            if (!container) return;

            container.innerHTML = visibleSections.map(refNum => {
                const section = sections[refNum];
                if (!section) return '';

                // إنشاء tooltip تفصيلي
                const sessionsText = section.sessions.map(s => {
                    const dayCode = getDayCode(s.day);
                    const timeStr = formatTimeForDisplay(s.time);
                    return `${dayCode} ${timeStr}`;
                }).join(' | ');

                const tooltipLines = [
                    `📋 الرقم المرجعي: ${refNum}`,
                    `📚 ${section.courseCode} - ${section.courseName}`,
                    `📝 نوع: ${section.scheduleType || '-'}`,
                    `⏰ ${sessionsText}`,
                    section.trainerName ? `👨‍🏫 ${section.trainerName}` : '',
                    `👥 المسجلين: ${section.enrolled}`
                ].filter(Boolean).join('\n');

                return `
                    <div class="section-chip visible" title="${tooltipLines}">
                        <span class="chip-ref">${refNum}</span>
                        <span>${section.courseCode}</span>
                        <span class="chip-count">${section.enrolled}</span>
                        <button class="chip-remove" onclick="removeVisibleSection('${refNum}')">×</button>
                    </div>`;
            }).join('');
        }

        // ═══════════════════════════════════════════════════════════════
        //  Target Section Search Functions - الشعب المستهدفة
        // ═══════════════════════════════════════════════════════════════

        function showTargetDropdown() {
            const dropdown = document.getElementById('targetSectionDropdown');
            if (dropdown) {
                dropdown.classList.add('show');
                searchTargetSections(document.getElementById('targetSectionSearch').value);
            }
        }

        function hideTargetDropdown() {
            const dropdown = document.getElementById('targetSectionDropdown');
            if (dropdown) dropdown.classList.remove('show');
        }

        function searchTargetSections(searchTerm) {
            const dropdown = document.getElementById('targetSectionDropdown');
            if (!dropdown) return;

            const term = searchTerm.toLowerCase();

            // Filter sections based on search term
            let filteredSections = Object.values(sections).filter(section => {
                const searchable = `${section.refNumber} ${section.courseCode} ${section.courseName}`.toLowerCase();
                return searchable.includes(term);
            });

            // Sort by enrolled count (ascending - least first)
            filteredSections = filteredSections.sort((a, b) => a.enrolled - b.enrolled);

            // Limit to 30 results
            filteredSections = filteredSections.slice(0, 30);

            // Build dropdown HTML
            dropdown.innerHTML = filteredSections.length === 0 ?
                '<div style="padding: 0.5rem; text-align: center; color: var(--text-muted); font-size: 0.7rem;">لا توجد نتائج</div>' :
                filteredSections.map(section => {
                    const typeCode = getTypeCode(section.scheduleType);
                    const sessionBadges = getSessionBadges(section.sessions);
                    const trainerName = section.trainerName ? ` - ${section.trainerName}` : '';
                    return `
                        <div class="section-item" onclick="addTargetSection('${section.refNumber}')">
                            <div class="section-info">
                                <span class="section-code">${section.refNumber} - ${section.courseCode} ${typeCode}</span>
                                <span class="section-sessions">${sessionBadges}</span>
                                <span class="section-name">${section.courseName}${trainerName}</span>
                            </div>
                            <span class="trainee-badge">${section.enrolled}</span>
                        </div>`;
                }).join('');

            if (searchTerm) {
                dropdown.classList.add('show');
            }
        }

        function addTargetSection(refNumber) {
            if (targetSections.includes(refNumber)) {
                showToast('الشعبة مضافة مسبقاً', 'info');
                return;
            }

            targetSections.push(refNumber);
            updateTargetChips();
            renderAllData();
            // لا نغلق القائمة - نتركها مفتوحة للاختيار المتعدد
            showToast('تمت إضافة الشعبة المستهدفة', 'success');
        }

        function removeTargetSection(refNumber) {
            const index = targetSections.indexOf(refNumber);
            if (index > -1) {
                targetSections.splice(index, 1);
                updateTargetChips();
                renderAllData();
            }
        }

        function updateTargetChips() {
            const container = document.getElementById('targetChipsContainer');
            if (!container) return;

            container.innerHTML = targetSections.map(refNum => {
                const section = sections[refNum];
                if (!section) return '';

                // حساب عدد المتدربين المتاحين للنقل (من الشعب الظاهرة)
                const availableCount = countAvailableForTarget(refNum);

                // إنشاء tooltip تفصيلي
                const sessionsText = section.sessions.map(s => {
                    const dayCode = getDayCode(s.day);
                    const timeStr = formatTimeForDisplay(s.time);
                    return `${dayCode} ${timeStr}`;
                }).join(' | ');

                const tooltipLines = [
                    `📋 الرقم المرجعي: ${refNum}`,
                    `📚 ${section.courseCode} - ${section.courseName}`,
                    `📝 نوع: ${section.scheduleType || '-'}`,
                    `⏰ ${sessionsText}`,
                    section.trainerName ? `👨‍🏫 ${section.trainerName}` : '',
                    `👥 المسجلين: ${section.enrolled}`,
                    `✅ متاحين للنقل: ${availableCount}`
                ].filter(Boolean).join('\n');

                // عرض عدد المتاحين فقط إذا كانت هناك شعب ظاهرة
                const availableBadge = visibleSections.length > 0
                    ? `<span class="chip-available" title="متاحين للنقل من الشعب الظاهرة">${availableCount}</span>`
                    : '';

                return `
                    <div class="section-chip target" title="${tooltipLines}">
                        <span class="chip-ref">${refNum}</span>
                        <span>${section.courseCode}</span>
                        <span class="chip-count">${section.enrolled}</span>
                        ${availableBadge}
                        <button class="chip-remove" onclick="removeTargetSection('${refNum}')">×</button>
                    </div>`;
            }).join('');
        }

        // ═══════════════════════════════════════════════════════════════
        //  حساب عدد المتدربين المتاحين للنقل لشعبة مستهدفة محددة
        // ═══════════════════════════════════════════════════════════════
        function countAvailableForTarget(targetRefNum) {
            // إذا لم تكن هناك شعب ظاهرة، لا نحسب
            if (visibleSections.length === 0) return 0;

            const targetSection = sections[targetRefNum];
            if (!targetSection) return 0;

            // الحصول على المتدربين من الشعب الظاهرة
            const visibleTrainees = Object.values(trainees).filter(trainee => {
                return trainee.registrations.some(r => visibleSections.includes(r.refNum));
            });

            // حساب المتدربين الذين ليس لديهم تعارض مع هذه الشعبة المستهدفة
            let availableCount = 0;

            visibleTrainees.forEach(trainee => {
                const hasConflict = hasConflictWithSpecificTarget(trainee, targetRefNum);
                if (!hasConflict) {
                    availableCount++;
                }
            });

            return availableCount;
        }

        // التحقق من تعارض متدرب مع شعبة مستهدفة محددة
        function hasConflictWithSpecificTarget(trainee, targetRefNum) {
            const targetSection = sections[targetRefNum];
            if (!targetSection) return false;

            const schedule = getTraineeSchedule(trainee.id);

            for (const targetSession of targetSection.sessions) {
                if (!targetSession.time || !targetSession.day) continue;
                const [targetEnd, targetStart] = targetSession.time.split(' - ');

                // التحقق من وجود جلسة في نفس اليوم والوقت
                const daySchedule = schedule.schedule[targetSession.day] || {};
                for (const [time, data] of Object.entries(daySchedule)) {
                    if (data.refNumber === targetRefNum) continue;
                    const [sEnd, sStart] = time.split(' - ');
                    // تحقق من التداخل الزمني
                    if (!(targetEnd <= sStart || targetStart >= sEnd)) {
                        return true; // يوجد تعارض
                    }
                }
            }
            return false; // لا يوجد تعارض
        }

        // ═══════════════════════════════════════════════════════════════
        //  Cascading Filters
        // ═══════════════════════════════════════════════════════════════

        function getSelectedValues(filterId) {
            const list = document.getElementById(filterId.replace('Filter', 'List'));
            if (!list) return [];
            const checked = list.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checked).map(cb => cb.value);
        }

        function applyCascadingFilters() {
            const selectedDepts = getSelectedValues('departmentFilter');
            const selectedPrefixes = getSelectedValues('prefixFilter');
            const selectedTypes = getSelectedValues('scheduleTypeFilter');

            // Update selectedFilters state
            selectedFilters.departments = selectedDepts;
            selectedFilters.prefixes = selectedPrefixes;
            selectedFilters.scheduleTypes = selectedTypes;

            // Re-render tables with filters
            renderAllData();
        }

        // Check if a section matches current filters
        function sectionMatchesFilters(section) {
            // If no filters selected, show all
            const hasDeptFilter = selectedFilters.departments.length > 0;
            const hasPrefixFilter = selectedFilters.prefixes.length > 0;
            const hasTypeFilter = selectedFilters.scheduleTypes.length > 0;

            if (!hasDeptFilter && !hasPrefixFilter && !hasTypeFilter) {
                return true;
            }

            // Check department
            if (hasDeptFilter && !selectedFilters.departments.includes(section.department)) {
                return false;
            }

            // Check prefix (extract letters from course code)
            if (hasPrefixFilter) {
                const prefix = section.courseCode.replace(/[-\d]/g, '').trim();
                if (!selectedFilters.prefixes.includes(prefix)) {
                    return false;
                }
            }

            // Check schedule type
            if (hasTypeFilter && !selectedFilters.scheduleTypes.includes(section.scheduleType)) {
                return false;
            }

            return true;
        }

        // تم نقل toggleFreeOnly للأعلى مع المتغيرات العامة        // ═══════════════════════════════════════════════════════════════
        //  Populate filters (updated)
        // ═══════════════════════════════════════════════════════════════
        function populateFilters() {
            populateMultiSelectLists();

            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // التهيئة
        initUploadPage();

        // نسخ رقم المتدرب بالنقر المزدوج
        document.addEventListener('dblclick', (e) => {
            const traineeId = e.target.closest('.trainee-id');
            if (traineeId) {
                const id = traineeId.textContent.trim().split('\n')[0].trim();
                navigator.clipboard.writeText(id).then(() => {
                    showToast(`تم نسخ الرقم: ${id}`, 'success');
                });
            }
        });

        // للتجربة: عرض الصفحة الرئيسية مباشرة (اضغط Ctrl+Shift+D)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                uploadPage.style.display = 'none';
                mainPage.style.display = 'flex';
            }
        });
    </script>
</body>

</html>